<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Wed May 02 14:06:40 KST 2018-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.icignal.marketing.storeReport.mapper.MktStoreReportMapper">

    <!-- 0. shop갯수 조회 -->
    <select id="selectShopCnt" resultType="java.lang.Integer">
        /* MktStoreReportMapper.selectShopCnt */
        SELECT CASE count(A1.ShopId) WHEN 0 THEN 1 ELSE count(A1.ShopId) END
        FROM mrtmktrpt.DimShop A1
        JOIN mrtmktrpt.DimOfflineType A2 ON A1.OfflineTypeId = A2.OfflineTypeId
        WHERE 1=1
        AND A1.StatusCode = 2
        AND A1.BrandCode = #{brandCode}
        AND A2.OfflineTypeCode != '6'
        <!-- AND A1.OfflineTypeId = ( SELECT OfflineTypeId FROM mrtmktrpt.DimShop WHERE ShopCode = #{shopCode} ) -->
    </select>

    <!-- 1. 회원 비교 -->
    <select id="selectMbrCompareTotal" resultType="com.icignal.marketing.storeReport.dto.response.MktMbrCompareResDto">
        /* MktStoreReportMapper.selectMbrCompareTotal */
        SELECT ISNULL(ROUND(SUM(A1.SalesAmount / 1000), 0), 0) AS shopTotalSales
             , ISNULL(SUM(A1.SalesQty), 0) AS shopUnitSales
             , ISNULL(ROUND(SUM(A1.SalesAmount) / SUM(A1.SalesQty), 0), 0) AS shopUnitSalesPrice
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
                 JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
                 JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
                 JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A4.ShopCode = #{shopCode}
    </select>

    <select id="selectMbrCompareTotalBrand" resultType="com.icignal.marketing.storeReport.dto.response.MktMbrCompareResDto">
        /* MktStoreReportMapper.selectMbrCompareTotalBrand */
        SELECT ISNULL(ROUND(SUM((A1.SalesAmount / #{shopCnt}) / 1000), 0), 0) AS brandTotalSales
             , ISNULL(ROUND(SUM(A1.SalesQty) / #{shopCnt}, 0), 0) AS brandUnitSales
             , ISNULL(ROUND(SUM(A1.SalesAmount / #{shopCnt}) / SUM(A1.SalesQty / #{shopCnt}), 0), 0) AS brandUnitSalesPrice
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
                 JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
                 JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
                 JOIN mrtmktrpt.DimBrand A4 ON A1.BrandId = A4.BrandId
                 JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId AND A5.StatusCode = 2
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A4.BrandCode = #{brandCode}
    </select>

    <select id="selectMbrCompare" resultType="com.icignal.marketing.storeReport.dto.response.MktMbrCompareResDto">
        /* MktStoreReportMapper.selectMbrCompare */
        WITH total AS (
        SELECT ISNULL(ROUND(SUM(A1.SalesAmount / 1000), 0), 0) AS shopTotalSales
        , ISNULL(SUM(A1.SalesQty), 0) AS shopUnitSales
        , ISNULL(ROUND(SUM(A1.SalesAmount) / SUM(A1.SalesQty), 0), 0) AS shopUnitSalesPrice
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A4.ShopCode = #{shopCode}
        <!-- AND A1.SalesQty > 0 -->
        ), mbr AS (
        SELECT ISNULL(SUM(A1.SalesAmount), 0) AS mbrTotalSales
        , ISNULL(COUNT(A3.UserId_Code), 0) AS shopCustomerCnt
        , ISNULL(SUM(A1.SalesQty), 0) AS mbrTotalSalesQty
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        ), nonMbr AS (
        SELECT ISNULL(SUM(A1.SalesAmount), 0) AS nonMbrTotalSales
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code = 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        ), nowMbr AS (
        SELECT COUNT(1) AS shopTotalMemCnt
        FROM mrtcrm.FactMember A1 WITH(NOLOCK)
        WHERE 1=1
        AND A1.MainShopCode = #{shopCode}
        ), newMbr AS (
        SELECT COUNT(1) AS shopNewMemCnt
        FROM mrtmktrpt.DimMemberInfo A1 WITH(NOLOCK)
        WHERE 1=1
        AND A1.RegistrationDate <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A1.RegistrationDate <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A1.RegistrationShopCode = #{shopCode}
        )
        SELECT total.shopTotalSales AS shopTotalSales
        , total.shopUnitSales AS shopUnitSales
        , total.shopUnitSalesPrice AS shopUnitSalesPrice
        , CASE
        WHEN total.shopTotalSales > 0
        THEN ROUND((mbr.mbrTotalSales * 100.0) / sum(total.shopTotalSales * 1000) over(), 0)
        ELSE 0
        END AS shopMemSales
        , nowMbr.shopTotalMemCnt AS shopTotalMemCnt
        , newMbr.shopNewMemCnt AS shopNewMemCnt
        , mbr.shopCustomerCnt AS shopCustomerCnt
        , CASE
        WHEN mbr.shopCustomerCnt > 0
        THEN ROUND(mbr.mbrTotalSalesQty / mbr.shopCustomerCnt, 1)
        ELSE 0
        END AS shopAverageCnt
        , CASE
        WHEN mbr.shopCustomerCnt > 0
        THEN ROUND(mbr.mbrTotalSales / mbr.shopCustomerCnt, 0)
        ELSE 0
        END AS shopAveragePrice
        , CASE
        WHEN total.shopTotalSales > 0
        THEN ROUND((nonMbr.nonMbrTotalSales * 100.0) / sum(total.shopTotalSales * 1000) over(), 0)
        ELSE 0
        END AS shopNonMemSales
        FROM total, mbr, nonMbr, nowMbr, newMbr
    </select>

    <select id="selectMbrCompareBrand" resultType="com.icignal.marketing.storeReport.dto.response.MktMbrCompareResDto">
        /* MktStoreReportMapper.selectMbrCompareBrand */
        WITH total AS (
        SELECT ISNULL(ROUND(SUM(A1.SalesAmount / 1000), 0), 0) AS shopTotalSales
        , ISNULL(SUM(A1.SalesQty), 0) AS shopUnitSales
        , ISNULL(ROUND(SUM(A1.SalesAmount) / SUM(A1.SalesQty), 0), 0) AS shopUnitSalesPrice
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A5.BrandCode = #{brandCode}
        <!-- AND A1.SalesQty > 0 -->
        ), mbr AS (
        SELECT ISNULL(SUM(A1.SalesAmount), 0) AS mbrTotalSales
        , ISNULL(COUNT(A3.UserId_Code), 0) AS shopCustomerCnt
        , ISNULL(SUM(A1.SalesQty), 0) AS mbrTotalSalesQty
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A5.BrandCode = #{brandCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        ), nonMbr AS (
        SELECT ISNULL(SUM(A1.SalesAmount), 0) AS nonMbrTotalSales
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A5.BrandCode = #{brandCode}
        AND A3.UserId_Code = 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        ), nowMbr AS (
        SELECT COUNT(1) AS shopTotalMemCnt
        FROM mrtcrm.FactMember A1 WITH(NOLOCK)
        WHERE 1=1
        AND A1.MainShopBrand = #{brandCode}
        ), newMbr AS (
        SELECT COUNT(1) AS shopNewMemCnt
        FROM mrtmktrpt.DimMemberInfo A1 WITH(NOLOCK)
        WHERE 1=1
        AND A1.RegistrationDate <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A1.RegistrationDate <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A1.RegistrationBrandCode = #{brandCode}
        )
        SELECT ISNULL(ROUND(total.shopTotalSales / #{shopCnt}, 0), 0) AS brandTotalSales
        , ISNULL(ROUND(total.shopUnitSales / #{shopCnt}, 0), 0) AS brandUnitSales
        <!-- , ISNULL(ROUND(total.shopUnitSalesPrice / #{shopCnt}, 0), 0) AS brandUnitSalesPrice -->
        , ISNULL(ROUND(total.shopUnitSalesPrice, 0), 0) AS brandUnitSalesPrice
        , CASE
        WHEN mbr.mbrTotalSales > 0 AND total.shopTotalSales > 0
        THEN ISNULL(ROUND(((mbr.mbrTotalSales * 100.0) / sum(total.shopTotalSales * 1000) over()), 0), 0)
        ELSE 0
        END AS brandMemSales
        , ISNULL(ROUND(nowMbr.shopTotalMemCnt / #{shopCnt}, 0), 0) AS brandTotalMemCnt
        , ISNULL(ROUND(newMbr.shopNewMemCnt / #{shopCnt}, 0), 0) AS brandNewMemCnt
        , ISNULL(ROUND(mbr.shopCustomerCnt / #{shopCnt}, 0), 0) AS brandCustomerCnt
        , CASE
        WHEN mbr.shopCustomerCnt > 0
        THEN ISNULL(ROUND((mbr.mbrTotalSalesQty / mbr.shopCustomerCnt), 1), 0)
        ELSE 0
        END AS brandAverageCnt
        , CASE
        WHEN mbr.shopCustomerCnt > 0
        THEN ISNULL(ROUND((mbr.mbrTotalSales / mbr.shopCustomerCnt), 0), 0)
        ELSE 0
        END AS brandAveragePrice
        , CASE
        WHEN total.shopTotalSales > 0
        THEN ISNULL(ROUND(((nonMbr.nonMbrTotalSales * 100.0) / sum(total.shopTotalSales * 1000) over()), 0), 0)
        ELSE 0
        END AS brandNonMemSales
        FROM total, mbr, nonMbr, nowMbr, newMbr
    </select>

    <select id="selectGenderChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiBarChartSeriesDto">
        /* MktStoreReportMapper.selectGenderChart */
        SELECT ROUND(count(A1.SalesQty) * 100.0 / sum(count(1)) over(), 1) AS data
        , A4.MembershipLevelName AS name
        , A4.MembershipLevel
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        <!-- JOIN mrtmktrpt.DimMembershipLevel A4 ON A1.MembershipLevelId = A4.MembershipLevelId -->
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_S_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_D_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_Q_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_G_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_M_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_U_Code = A4.MembershipLevelCode</if>
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A6 ON A1.BrandId = A6.BrandId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A4.MembershipLevelCode != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        <if test='type == "shop"'>AND A5.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A6.BrandCode = #{brandCode}</if>
        GROUP BY A4.MembershipLevelName, A4.MembershipLevel
        ORDER BY A4.MembershipLevel DESC
    </select>

    <select id="selectAgeChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiAgeChartSeriesDto">
        /* MktStoreReportMapper.selectAgeChart */
        SELECT A3.GenderNameFull_KOR AS name
        , A3.GenderNameFull_KOR AS stackGroup
        <if test='type == "shop"'>
            , SUM(CASE WHEN AgeGroupCode = 'A001' THEN 1 ELSE 0 END) as age_19
            , SUM(CASE WHEN AgeGroupCode = 'A002' THEN 1 ELSE 0 END) as age_20
            , SUM(CASE WHEN AgeGroupCode = 'A003' THEN 1 ELSE 0 END) as age_25
            , SUM(CASE WHEN AgeGroupCode = 'A004' THEN 1 ELSE 0 END) as age_30
            , SUM(CASE WHEN AgeGroupCode = 'A005' THEN 1 ELSE 0 END) as age_35
            , SUM(CASE WHEN AgeGroupCode = 'A006' THEN 1 ELSE 0 END) as age_40
            , SUM(CASE WHEN AgeGroupCode = 'A007' THEN 1 ELSE 0 END) as age_45
            , SUM(CASE WHEN AgeGroupCode = 'A008' THEN 1 ELSE 0 END) as age_50
            , SUM(CASE WHEN AgeGroupCode = 'A009' THEN 1 ELSE 0 END) as age_55
            , SUM(CASE WHEN AgeGroupCode = 'A010' THEN 1 ELSE 0 END) as age_60
        </if>
        <if test='type == "brand"'>
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A001' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_19
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A002' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_20
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A003' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_25
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A004' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_30
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A005' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_35
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A006' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_40
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A007' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_45
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A008' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_50
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A009' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_55
            , ISNULL(ROUND(SUM(CASE WHEN AgeGroupCode = 'A010' THEN 1 ELSE 0 END) / #{shopCnt}, 0), 0) as age_60
        </if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimAgeGroup A5 ON A1.CustomerAgeGroupId = A5.AgeGroupId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A6 ON A1.BrandId = A6.BrandId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A3.UserId_Code != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        AND ( A3.GenderNameShort_ENG = 'M' OR A3.GenderNameShort_ENG = 'F')
        <if test='type == "shop"'>AND A4.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A6.BrandCode = #{brandCode}</if>
        GROUP BY A3.GenderNameFull_KOR
        <!-- , A4.MembershipLevelCode -->
    </select>

    <select id="selectGenderGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiMbrCompareGridDataDto">
        /* MktStoreReportMapper.selectAgeGrid */
        SELECT AA.colNm		AS colNm
        , SUM(AA.iTotal) 	AS iTotal
        , SUM(AA.iVip) 		AS iVip
        , SUM(AA.iAGrade) 	AS iAGrade
        , SUM(AA.iBGrade) 	AS iBGrade
        , SUM(AA.iCGrade) 	AS iCGrade
        FROM (
        SELECT GenderNameFull_KOR AS colNm
        , 0 AS iTotal
        , 0 AS iVip
        , 0 AS iAGrade
        , 0 AS iBGrade
        , 0 AS iCGrade
        FROM mrtmktrpt.DimMemberInfo
        WHERE ( GenderNameShort_ENG = 'M' OR GenderNameShort_ENG = 'F')
        GROUP BY GenderNameFull_KOR
        UNION
        SELECT A3.GenderNameFull_KOR AS colNm
        , ISNULL(ROUND(COUNT(1) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iTotal
        <if test='brandCode == "S"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "D"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "Q"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "G"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "M"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "U"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        <!-- JOIN mrtmktrpt.DimMembershipLevel A4 ON A1.MembershipLevelId = A4.MembershipLevelId -->
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_S_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_D_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_Q_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_G_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_M_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_U_Code = A4.MembershipLevelCode</if>
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A6 ON A1.BrandId = A6.BrandId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A4.MembershipLevelCode != 'IS_NOT_DATA'
        AND ( A3.GenderNameShort_ENG = 'M' OR A3.GenderNameShort_ENG = 'F')
        <if test='type == "shop"'>AND A5.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A6.BrandCode = #{brandCode}</if>
        GROUP BY A3.GenderNameFull_KOR
        ) AA
        GROUP BY AA.colNm
        ORDER BY AA.colNm
    </select>

    <select id="selectAgeGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiMbrCompareGridDataDto">
        /* MktStoreReportMapper.selectAgeGrid */
        SELECT AA.colNm		AS colNm
        , SUM(AA.iTotal) 	AS iTotal
        , SUM(AA.iVip) 		AS iVip
        , SUM(AA.iAGrade) 	AS iAGrade
        , SUM(AA.iBGrade) 	AS iBGrade
        , SUM(AA.iCGrade) 	AS iCGrade
        , AA.AgeGroupSort
        FROM (
        SELECT dag.AgeGroupName1 AS colNm
        , 0 AS iTotal
        , 0 AS iVip
        , 0 AS iAGrade
        , 0 AS iBGrade
        , 0 AS iCGrade
        , dag.AgeGroupSort
        FROM mrtmktrpt.DimAgeGroup dag WITH(NOLOCK)
        WHERE dag.AgeGroupCode <![CDATA[<>]]> 'IS_NOT_DATA'
        UNION
        SELECT A7.AgeGroupName1 AS colNm
        , ISNULL(ROUND(COUNT(1) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iTotal
        <if test='brandCode == "S"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "D"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "Q"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "G"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "M"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        <if test='brandCode == "U"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
            , ISNULL(ROUND(SUM(CASE WHEN A4.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        </if>
        , A7.AgeGroupSort
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        <!-- JOIN mrtmktrpt.DimMembershipLevel A4 ON A1.MembershipLevelId = A4.MembershipLevelId -->
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_S_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_D_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_Q_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_G_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_M_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_U_Code = A4.MembershipLevelCode</if>
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A6 ON A1.BrandId = A6.BrandId</if>
        JOIN mrtmktrpt.DimAgeGroup A7 ON A1.CustomerAgeGroupId = A7.AgeGroupId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A7.AgeGroupCode != 'IS_NOT_DATA'
        AND A4.MembershipLevelCode != 'IS_NOT_DATA'
        AND ( A3.GenderNameShort_ENG = 'M' OR A3.GenderNameShort_ENG = 'F')
        <if test='type == "shop"'>AND A5.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A6.BrandCode = #{brandCode}</if>
        GROUP BY A7.AgeGroupName1, A7.AgeGroupSort
        ) AA
        GROUP BY AA.colNm, AA.AgeGroupSort
        ORDER BY AA.AgeGroupSort
    </select>
    <!-- 1. 회원 비교 -->

    <!-- 2. 상품 비교 -->
    <select id="selectClassChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiBarChartSeriesDto">
        /* MktStoreReportMapper.selectClassChart */
        SELECT A3.ClassName AS name
        , ROUND(count(A1.SalesAmount) * 100.0 / sum(count(1)) over(), 1) AS data
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct  A3 ON A1.ProductId  = A3.ProductId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A4 ON A1.ShopId  = A4.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId</if>
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        <!-- AND A1.SalesQty > 0 -->
        <if test='type == "shop"'>AND A4.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A5.BrandCode = #{brandCode}</if>
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        GROUP BY A3.ClassName
        ORDER BY A3.ClassName DESC
    </select>

    <select id="selectCategoryChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiCategoryChartSeriesDto">
        /* MktStoreReportMapper.selectCategoryChart */
        SELECT A4.CategoryCode AS name
        , A4.ClassCode
        <if test='type == "shop"'>
            , ISNULL(SUM(CASE WHEN A4.ClassCode =  1 THEN A1.SalesQty ELSE 0 END), 0) AS data1
            , ISNULL(SUM(CASE WHEN A4.ClassCode =  2 THEN A1.SalesQty ELSE 0 END), 0) AS data2
            , ISNULL(SUM(CASE WHEN A4.ClassCode =  3 THEN A1.SalesQty ELSE 0 END), 0) AS data3
        </if>
        <if test='type == "brand"'>
            , ISNULL(ROUND(SUM(CASE WHEN A4.ClassCode =  1 THEN A1.SalesQty ELSE 0 END) / #{shopCnt}, 0), 0) as data1
            , ISNULL(ROUND(SUM(CASE WHEN A4.ClassCode =  2 THEN A1.SalesQty ELSE 0 END) / #{shopCnt}, 0), 0) as data2
            , ISNULL(ROUND(SUM(CASE WHEN A4.ClassCode =  3 THEN A1.SalesQty ELSE 0 END) / #{shopCnt}, 0), 0) as data3
        </if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId</if>
        JOIN mrtmktrpt.DimProduct A4 on A1.ProductId  = A4.ProductId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A6 ON A1.BrandId = A6.BrandId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        <!-- AND A1.SalesQty > 0 -->
        <if test='type == "shop"'>AND A5.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A6.BrandCode = #{brandCode}</if>
        <if test='mbrDiv == "MBR"'>AND A3.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A3.UserId_Code = 'IS_NOT_DATA'</if>
        GROUP BY A4.CategoryCode, A4.ClassCode
        ORDER BY A4.ClassCode
    </select>

    <select id="selectTopItemGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiProductCompareGridDataDto">
        /* MktStoreReportMapper.selectTopItemGrid */
        SELECT
        <if test='type == "shop"'> TOP 5 </if>
        <if test='type == "brand"'> TOP 10 </if>
        A3.ItemCode AS productName
        <if test='type == "shop"'>
            , FORMAT(sum(A1.SalesQty), '#,##0') AS cnt
        </if>
        <if test='type == "brand"'>
            , FORMAT(ISNULL(ROUND(SUM(A1.SalesQty) / #{shopCnt}, 1), 0), '#,##0.##') AS cnt
        </if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId</if>
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        <if test='type == "shop"'>AND A4.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A5.BrandCode = #{brandCode}</if>
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        GROUP BY A3.ItemCode
        ORDER BY SUM(A1.SalesQty) DESC
    </select>

    <select id="selectLowItemGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiProductCompareGridDataDto">
        /* MktStoreReportMapper.selectLowItemGrid */
        SELECT
        <if test='type == "shop"'> TOP 5 </if>
        <if test='type == "brand"'> TOP 10 </if>
        A3.ItemCode AS productName
        <if test='type == "shop"'>
            , FORMAT(sum(A1.SalesQty), '#,##0') AS cnt
        </if>
        <if test='type == "brand"'>
            , FORMAT(ISNULL(ROUND(SUM(A1.SalesQty) / #{shopCnt}, 1), 0), '#,##0.##') AS cnt
        </if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId</if>
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        <if test='type == "shop"'>AND A4.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A5.BrandCode = #{brandCode}</if>
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        GROUP BY A3.ItemCode
        <if test='type == "shop"'>HAVING SUM(A1.SalesQty) > 0</if>
        <if test='type == "brand"'>HAVING ROUND(SUM(A1.SalesQty) / #{shopCnt}, 0) > 0</if>
        ORDER BY SUM(A1.SalesQty)
    </select>

    <select id="selectTopProductGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiProductCompareGridDataDto">
        /* MktStoreReportMapper.selectTopProductGrid */
        SELECT TOP 5
        A3.ProductCode AS productName
        <if test='type == "shop"'>, FORMAT(sum(A1.SalesQty), '#,##0') AS cnt</if>
        <if test='type == "brand"'>, FORMAT(ISNULL(ROUND(SUM(A1.SalesQty) / #{shopCnt}, 1), 0), '#,##0.##') AS cnt</if>
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct A3 on A1.ProductId  = A3.ProductId
        <if test='type == "shop"'>JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId</if>
        <if test='type == "brand"'>JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId</if>
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        <if test='type == "shop"'>AND A4.ShopCode = #{shopCode}</if>
        <if test='type == "brand"'>AND A5.BrandCode = #{brandCode}</if>
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        <if test='productClass == "1" or productClass == "2" or productClass == "3"'>AND A3.ClassCode = #{productClass}</if>
        <!-- GROUP BY A3.ProductCode -->
        GROUP BY A3.ProductCode
        ORDER BY SUM(A1.SalesQty) DESC
    </select>

    <select id="selectSalesRatioItemGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiProductCompareSalesRatioGridDataDto">
        /* MktStoreReportMapper.selectSalesRatioItemGrid */
        WITH shopItem AS (
        SELECT A.ItemCode AS productName
        , ROUND(A.cnt * 100.0 / SUM(A.cnt) OVER(), 1) AS cnt
        FROM (
        SELECT A3.ItemCode AS ItemCode
        , SUM(A1.SalesQty) AS cnt
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
        JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A4.ShopCode = #{shopCode}
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        <!-- AND A1.SalesQty > 0 -->
        GROUP BY A3.ItemCode
        HAVING SUM(A1.SalesQty) > 0
        ) A
        GROUP BY A.ItemCode, A.cnt
        ), brandItem AS (
        SELECT A.ItemCode AS productName
        , ROUND(A.cnt * 100.0 / SUM(A.cnt) OVER(), 1) AS cnt
        FROM (
        SELECT A3.ItemCode AS ItemCode
        , SUM(A1.SalesQty) AS cnt
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
        JOIN mrtmktrpt.DimBrand A5 ON A1.BrandId = A5.BrandId
        <if test='mbrDiv == "MBR" or mbrDiv == "NMBR"'>JOIN mrtmktrpt.DimMemberInfo A6 ON A1.UserId = A6.UserId</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A5.BrandCode = #{brandCode}
        <if test='mbrDiv == "MBR"'>AND A6.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A6.UserId_Code = 'IS_NOT_DATA'</if>
        <!-- AND A1.SalesQty > 0 -->
        GROUP BY A3.ItemCode
        HAVING SUM(A1.SalesQty) > 0
        ) A
        GROUP BY A.ItemCode, A.cnt
        )
        SELECT TOP 5 shopItem.productName AS productName
        , shopItem.cnt AS sCnt
        , brandItem.cnt AS bCnt
        , ROUND((shopItem.cnt - brandItem.cnt), 1) AS iCnt
        FROM shopItem, brandItem
        WHERE shopItem.productName = brandItem.productName
        AND shopItem.cnt > 0
        AND brandItem.cnt > 0
        ORDER BY ROUND((shopItem.cnt - brandItem.cnt), 1)
        <if test='type == "top"'> DESC </if>
    </select>
    <!-- 2. 상품 비교 -->

    <!-- 3. 재구매&이탈 분석 -->
    <select id="selectRepeatBreakaway" resultType="com.icignal.marketing.storeReport.dto.response.MktRepeatBreakawayResDto">
        /* MktStoreReportMapper.selectRepeatBreakaway */
        SELECT COUNT(CASE WHEN customer.day_cnt > 1 THEN 1 END) AS repeatCnt
        , CASE
        WHEN COUNT(CASE WHEN customer.day_cnt > 1 THEN 1 END) > 0
        THEN ROUND(COUNT(CASE WHEN customer.day_cnt > 1 THEN 1 END) / CONVERT(FLOAT, COUNT(customer.day_cnt)) * 100, 1)
        ELSE 0
        END AS repeatRate
        , (
        SELECT COUNT(DISTINCT A1.Userid) AS cnt
        FROM mrtmktrpt.FactSalesOrder A1
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 on A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_S_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_D_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_Q_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_G_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_M_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_U_Code = A5.MembershipLevelCode</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND A2.Date <![CDATA[<=]]>  CONVERT(VARCHAR(10), #{endDate}, 120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A5.MembershipLevelCode != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        AND NOT EXISTS (
        SELECT DISTINCT B1.Userid
        FROM mrtmktrpt.FactSalesOrder B1
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -3, CONVERT(DATE, #{endDate}))-- 3개월
        AND B2.Date <![CDATA[<=]]>  CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        <!-- AND B1.SalesQty > 0 -->
        AND A3.Userid = B1.Userid
        )
        ) AS customerChurnCnt
        FROM (
        SELECT A1.Userid
        ,COUNT(DISTINCT A2.Date) AS day_cnt
        FROM mrtmktrpt.FactSalesOrder A1
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 on A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10), #{endDate}, 120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        <!-- AND A1.SalesQty > 0 -->
        GROUP BY A1.Userid
        ) customer
    </select>

    <select id="selectRepeatBreakawayGradeChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiBarChartSeriesDto">
        /* MktStoreReportMapper.selectRepeatBreakawayGradeChart */
        SELECT count(A1.Userid) * 100.0 / sum(count(1)) over() AS data
        , A1.MembershipLevelName AS name
        , A1.MembershipLevel
        FROM (
        SELECT B1.Userid AS Userid
        , B5.MembershipLevelName AS MembershipLevelName
        , B5.MembershipLevel AS MembershipLevel
        , MAX(B2.Date) AS maxDate
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_S_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_D_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_Q_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_G_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_M_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_U_Code = B5.MembershipLevelCode</if>
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND B5.MembershipLevelCode != 'IS_NOT_DATA'
        <!-- AND B1.SalesQty > 0 -->
        GROUP BY B1.Userid, B5.MembershipLevelName, B5.MembershipLevel
        HAVING COUNT(DISTINCT B2.Date) > 1
        ) A1
        WHERE 1=1
        GROUP BY A1.MembershipLevelName, A1.MembershipLevel
        ORDER BY A1.MembershipLevel DESC
    </select>

    <select id="selectRepeatBreakawayGradeAgeChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiAgeChartSeriesDto">
        /* MktStoreReportMapper.selectRepeatBreakawayGradeAgeChart */
        SELECT A1.GenderNameFull_KOR AS name
        , A1.GenderNameFull_KOR AS stackGroup
        , SUM(CASE WHEN A1.AgeGroupCode = 'A001' THEN 1 ELSE 0 END) as age_19
        , SUM(CASE WHEN A1.AgeGroupCode = 'A002' THEN 1 ELSE 0 END) as age_20
        , SUM(CASE WHEN A1.AgeGroupCode = 'A003' THEN 1 ELSE 0 END) as age_25
        , SUM(CASE WHEN A1.AgeGroupCode = 'A004' THEN 1 ELSE 0 END) as age_30
        , SUM(CASE WHEN A1.AgeGroupCode = 'A005' THEN 1 ELSE 0 END) as age_35
        , SUM(CASE WHEN A1.AgeGroupCode = 'A006' THEN 1 ELSE 0 END) as age_40
        , SUM(CASE WHEN A1.AgeGroupCode = 'A007' THEN 1 ELSE 0 END) as age_45
        , SUM(CASE WHEN A1.AgeGroupCode = 'A008' THEN 1 ELSE 0 END) as age_50
        , SUM(CASE WHEN A1.AgeGroupCode = 'A009' THEN 1 ELSE 0 END) as age_55
        , SUM(CASE WHEN A1.AgeGroupCode = 'A010' THEN 1 ELSE 0 END) as age_60
        FROM (
        SELECT B1.Userid AS Userid
        , B3.GenderNameFull_KOR AS GenderNameFull_KOR
        , B5.AgeGroupCode AS AgeGroupCode
        , B5.AgeGroupSort AS AgeGroupSort
        , MAX(B2.Date) AS maxDate
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        JOIN mrtmktrpt.DimAgeGroup B5 ON B1.CustomerAgeGroupId = B5.AgeGroupId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND B5.AgeGroupCode != 'IS_NOT_DATA'
        <!-- AND B1.SalesQty > 0 -->
        AND ( B3.GenderNameShort_ENG = 'M' OR B3.GenderNameShort_ENG = 'F')
        GROUP BY B1.Userid, B3.GenderNameFull_KOR, B5.AgeGroupCode, B5.AgeGroupSort
        HAVING COUNT(DISTINCT B2.Date) > 1
        ) A1
        GROUP BY A1.GenderNameFull_KOR
    </select>

    <select id="selectRepeatBreakawayGenderGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiMbrCompareGridDataDto">
        /* MktStoreReportMapper.selectRepeatBreakawayGenderGrid */
        SELECT AA.colNm		AS colNm
        , SUM(AA.iTotal) 	AS iTotal
        , SUM(AA.iVip) 		AS iVip
        , SUM(AA.iAGrade) 	AS iAGrade
        , SUM(AA.iBGrade) 	AS iBGrade
        , SUM(AA.iCGrade) 	AS iCGrade
        FROM (
        SELECT GenderNameFull_KOR AS colNm
        , 0 AS iTotal
        , 0 AS iVip
        , 0 AS iAGrade
        , 0 AS iBGrade
        , 0 AS iCGrade
        FROM mrtmktrpt.DimMemberInfo
        WHERE ( GenderNameShort_ENG = 'M' OR GenderNameShort_ENG = 'F')
        GROUP BY GenderNameFull_KOR
        UNION
        SELECT A.colNm
        , ISNULL(ROUND(COUNT(A.Userid) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iTotal
        , ISNULL(ROUND(SUM(A.iVip) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
        , ISNULL(ROUND(SUM(A.iAGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
        , ISNULL(ROUND(SUM(A.iBGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
        , ISNULL(ROUND(SUM(A.iCGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        FROM (
        SELECT B3.GenderNameFull_KOR AS colNm
        , B1.Userid AS Userid
        <if test='brandCode == "S"'>
            , CASE WHEN B5.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "D"'>
            , CASE WHEN B5.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "Q"'>
            , CASE WHEN B5.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "G"'>
            , CASE WHEN B5.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "M"'>
            , CASE WHEN B5.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "U"'>
            , CASE WHEN B5.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0244001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        , MAX(B2.Date) AS maxDate
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_S_Code = B5.MembershipLevelCode </if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_D_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_Q_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_G_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_M_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_U_Code = B5.MembershipLevelCode</if>
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND B5.MembershipLevelCode != 'IS_NOT_DATA'
        AND ( B3.GenderNameShort_ENG = 'M' OR B3.GenderNameShort_ENG = 'F')
        <!-- AND B1.SalesQty > 0 -->
        GROUP BY B1.Userid, B3.GenderNameFull_KOR, B5.MembershipLevelCode
        HAVING COUNT(DISTINCT B2.Date) > 1
        ) A
        GROUP BY A.colNm
        ) AA
        GROUP BY AA.colNm
        ORDER BY AA.colNm
    </select>

    <select id="selectRepeatBreakawayAgeGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiMbrCompareGridDataDto">
        /* MktStoreReportMapper.selectRepeatBreakawayAgeGrid */
        SELECT AA.colNm		AS colNm
        , SUM(AA.iTotal) 	AS iTotal
        , SUM(AA.iVip) 		AS iVip
        , SUM(AA.iAGrade) 	AS iAGrade
        , SUM(AA.iBGrade) 	AS iBGrade
        , SUM(AA.iCGrade) 	AS iCGrade
        , AA.AgeGroupSort
        FROM (
        SELECT dag.AgeGroupName1 AS colNm
        , 0 AS iTotal
        , 0 AS iVip
        , 0 AS iAGrade
        , 0 AS iBGrade
        , 0 AS iCGrade
        , dag.AgeGroupSort
        FROM mrtmktrpt.DimAgeGroup dag WITH(NOLOCK)
        WHERE dag.AgeGroupCode != 'IS_NOT_DATA'
        UNION
        SELECT A.colNm
        , ISNULL(ROUND(COUNT(A.Userid) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iTotal
        , ISNULL(ROUND(SUM(A.iVip) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iVip
        , ISNULL(ROUND(SUM(A.iAGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iAGrade
        , ISNULL(ROUND(SUM(A.iBGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iBGrade
        , ISNULL(ROUND(SUM(A.iCGrade) * 100.0 / SUM(COUNT(1)) over() , 1), 0) AS iCGrade
        , A.AgeGroupSort
        FROM (
        SELECT B6.AgeGroupName1 AS colNm
        , B1.Userid AS Userid
        <if test='brandCode == "S"'>
            , CASE WHEN B5.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "D"'>
            , CASE WHEN B5.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "Q"'>
            , CASE WHEN B5.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "G"'>
            , CASE WHEN B5.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "M"'>
            , CASE WHEN B5.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        <if test='brandCode == "U"'>
            , CASE WHEN B5.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END AS iVip
            , CASE WHEN B5.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END AS iAGrade
            , CASE WHEN B5.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END AS iBGrade
            , CASE WHEN B5.MembershipLevelCode = '0244001' THEN 1 ELSE 0 END AS iCGrade
        </if>
        , B6.AgeGroupSort AS AgeGroupSort
        , MAX(B2.Date) AS maxDate
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_S_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_D_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_Q_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_G_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_M_Code = B5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel B5 ON B3.MembershipLevel_U_Code = B5.MembershipLevelCode</if>
        JOIN mrtmktrpt.DimAgeGroup B6 ON B1.CustomerAgeGroupId = B6.AgeGroupId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate}))-- 1년전
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND B5.MembershipLevelCode != 'IS_NOT_DATA'
        AND B6.AgeGroupCode != 'IS_NOT_DATA'
        <!-- AND ( B3.GenderNameShort_ENG = 'M' OR B3.GenderNameShort_ENG = 'F') -->
        <!-- AND B1.SalesQty > 0 -->
        GROUP BY B6.AgeGroupName1, B6.AgeGroupSort, B1.Userid, B5.MembershipLevelCode
        HAVING COUNT(DISTINCT B2.Date) > 1
        ) A
        GROUP BY A.colNm, A.AgeGroupSort
        ) AA
        GROUP BY AA.colNm, AA.AgeGroupSort
        ORDER BY AA.AgeGroupSort
    </select>

    <select id="selectRepeatBreakawayGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiRepeatBreakawayGridDataDto">
        /* MktStoreReportMapper.selectRepeatBreakawayGrid */
        WITH yearAgo AS (
        SELECT A1.Userid
        , A5.MembershipLevelCode
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 on A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_S_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_D_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_Q_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_G_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_M_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_U_Code = A5.MembershipLevelCode</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate})) --1년전
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10), #{endDate}, 120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A5.MembershipLevelCode != 'IS_NOT_DATA'
        GROUP BY A1.Userid, A5.MembershipLevelCode
        ), yearAgoCnt AS (
        SELECT COUNT(DISTINCT A3.Userid) AS ttl
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 on A1.UserId = A3.UserId
        JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_S_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_D_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_Q_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_G_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_M_Code = A5.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A5 ON A3.MembershipLevel_U_Code = A5.MembershipLevelCode</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> DATEADD(MONTH, -12, CONVERT(DATE, #{endDate})) --1년전
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10), #{endDate}, 120)
        AND A4.ShopCode = #{shopCode}
        AND A3.UserId_Code != 'IS_NOT_DATA'
        AND A5.MembershipLevelCode != 'IS_NOT_DATA'
        ), last3Month AS (
        SELECT COUNT(B1.Userid) AS ttl
        <if test='brandCode == "S"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "D"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "Q"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "G"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "M"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "U"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        FROM (
        SELECT A1.Userid
        , A1.MembershipLevelCode
        FROM yearAgo A1
        WHERE 1=1
        AND NOT EXISTS (
        SELECT B1.Userid
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -3, CONVERT(DATE, #{endDate})) --3개월
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND A1.Userid = B1.Userid
        GROUP BY B1.Userid
        )
        GROUP BY A1.Userid, A1.MembershipLevelCode
        ) B1
        ), last6Month AS (
        SELECT COUNT(B1.Userid) AS ttl
        <if test='brandCode == "S"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "D"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "Q"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "G"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "M"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "U"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        FROM (
        SELECT A1.Userid
        , A1.MembershipLevelCode
        FROM yearAgo A1
        WHERE 1=1
        AND NOT EXISTS (
        SELECT B1.Userid
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -6, CONVERT(DATE, #{endDate})) --6개월
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND A1.Userid = B1.Userid
        GROUP BY B1.Userid
        )
        GROUP BY A1.Userid, A1.MembershipLevelCode
        ) B1
        ), last9Month AS (
        SELECT COUNT(B1.Userid) AS ttl
        <if test='brandCode == "S"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0242001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "D"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0245001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "Q"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0243001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "G"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0246001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "M"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0247001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        <if test='brandCode == "U"'>
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244004' THEN 1 ELSE 0 END), 0) AS vip
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244003' THEN 1 ELSE 0 END), 0) AS gold
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244002' THEN 1 ELSE 0 END), 0) AS silver
            , ISNULL(SUM(CASE WHEN B1.MembershipLevelCode = '0244001' THEN 1 ELSE 0 END), 0) AS bronze
        </if>
        FROM (
        SELECT A1.Userid
        , A1.MembershipLevelCode
        FROM yearAgo A1
        WHERE 1=1
        AND NOT EXISTS (
        SELECT B1.Userid
        FROM mrtmktrpt.FactSalesOrder B1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate B2 on B1.DateId = B2.DateId
        JOIN mrtmktrpt.DimMemberInfo B3 on B1.UserId = B3.UserId
        JOIN mrtmktrpt.DimShop B4 on B1.ShopId  = B4.ShopId
        WHERE 1=1
        AND B2.Date <![CDATA[>=]]> DATEADD(MONTH, -9, CONVERT(DATE, #{endDate})) --9개월
        AND B2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND B4.ShopCode = #{shopCode}
        AND B3.UserId_Code != 'IS_NOT_DATA'
        AND A1.Userid = B1.Userid
        GROUP BY B1.Userid
        )
        GROUP BY A1.Userid, A1.MembershipLevelCode
        ) B1
        )
        SELECT mbrTier, cntMbr1, iSalRatio1, cntMbr2, iSalRatio2, cntMbr3, iSalRatio3
        FROM
        (
        SELECT N'합계' AS mbrTier
        , FORMAT(last3Month.ttl, '#,##0') AS cntMbr1
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last3Month.ttl * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio1
        , FORMAT(last6Month.ttl, '#,##0') AS cntMbr2
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last6Month.ttl * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio2
        , FORMAT(last9Month.ttl, '#,##0') AS cntMbr3
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last9Month.ttl * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio3
        , 1 AS sort
        FROM yearAgoCnt, last3Month, last6Month, last9Month
        UNION
        SELECT N'VIP' AS mbrTier
        , FORMAT(last3Month.vip, '#,##0') AS cntMbr1
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last3Month.vip * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio1
        , FORMAT(last6Month.vip, '#,##0') AS cntMbr2
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last6Month.vip * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio2
        , FORMAT(last9Month.vip, '#,##0') AS cntMbr3
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last9Month.vip * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio3
        , 1 AS sort
        FROM yearAgoCnt, last3Month, last6Month, last9Month
        UNION
        SELECT N'Gold' AS mbrTier
        , FORMAT(last3Month.gold, '#,##0') AS cntMbr1
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last3Month.gold * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio1
        , FORMAT(last6Month.gold, '#,##0') AS cntMbr2
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last6Month.gold * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio2
        , FORMAT(last9Month.gold, '#,##0') AS cntMbr3
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last9Month.gold * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio3
        , 3 AS sort
        FROM yearAgoCnt, last3Month, last6Month, last9Month
        UNION
        SELECT N'Silver' AS mbrTier
        , FORMAT(last3Month.silver, '#,##0') AS cntMbr1
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last3Month.silver * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio1
        , FORMAT(last6Month.silver, '#,##0') AS cntMbr2
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last6Month.silver * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio2
        , FORMAT(last9Month.silver, '#,##0') AS cntMbr3
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last9Month.silver * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio3
        , 4 AS sort
        FROM yearAgoCnt, last3Month, last6Month, last9Month
        UNION
        SELECT N'Bronze' AS mbrTier
        , FORMAT(last3Month.bronze, '#,##0') AS cntMbr1
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last3Month.bronze * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio1
        , FORMAT(last6Month.bronze, '#,##0') AS cntMbr2
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last6Month.bronze * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio2
        , FORMAT(last9Month.bronze, '#,##0') AS cntMbr3
        , CASE
        WHEN yearAgoCnt.ttl > 0
        THEN ROUND(last9Month.bronze * 100.0 / SUM(yearAgoCnt.ttl) over() , 1)
        ELSE 0
        END AS iSalRatio3
        , 5 AS sort
        FROM yearAgoCnt, last3Month, last6Month, last9Month
        ) A
        ORDER BY A.sort
    </select>
    <!-- 3. 재구매&이탈 분석 -->

    <!-- 4. 최근 12개월 매출 추이 -->
    <select id="selectSalesChange" resultType="com.icignal.marketing.storeReport.dto.response.TuiStackBarChartSeriesDto">
        /* MktStoreReportMapper.selectSalesChange */
        SELECT N'매출액' AS name
        , N'매출액' AS stackGroup
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -11, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data1
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -10, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data2
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -9, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data3
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -8, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data4
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -7, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data5
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -6, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data6
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -5, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data7
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -4, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data8
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -3, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data9
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -2, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data10
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), DATEADD(MONTH, -1, CONVERT(DATE, #{endDate})), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data11
        , ISNULL(ROUND(SUM(CASE WHEN FORMAT(A2.Date, 'yyyy-MM') = CONVERT(VARCHAR(7), CONVERT(DATE, #{endDate}), 120) THEN A1.SalesAmount ELSE 0 END) / 1000, 0), 0) AS data12
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        <if test="membershipLevelCode !=null and !membershipLevelCode.equals('') and membershipLevelCode.length lt 4">
            <if test='brandCode == "S"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_S_Code = A4.MembershipLevelCode</if>
            <if test='brandCode == "D"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_D_Code = A4.MembershipLevelCode</if>
            <if test='brandCode == "Q"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_Q_Code = A4.MembershipLevelCode</if>
            <if test='brandCode == "G"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_G_Code = A4.MembershipLevelCode</if>
            <if test='brandCode == "M"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_M_Code = A4.MembershipLevelCode</if>
            <if test='brandCode == "U"'>LEFT OUTER JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_U_Code = A4.MembershipLevelCode</if>
        </if>
        JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId
        <if test="ageGroupCode !=null and !ageGroupCode.equals('') and ageGroupCode.length lt 11">JOIN mrtmktrpt.DimAgeGroup A6 ON A1.CustomerAgeGroupId = A6.AgeGroupId</if>
        <if test="clubCode !=null and !clubCode.equals('') and clubCode.length lt 4">JOIN mrtcrm.FactMemberClub A7 ON A3.UserId_Code = A7.UserId_Code</if>
        WHERE 1=1
        AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),DATEADD(MONTH, +1, DATEADD(YEAR, -1, DATEADD(d, -day(#{endDate})+1, #{endDate}))),120)
        AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
        AND A5.ShopCode = #{shopCode}
        <if test='mbrDiv == "MBR"'>AND A3.UserId_Code != 'IS_NOT_DATA'</if>
        <if test='mbrDiv == "NMBR"'>AND A3.UserId_Code = 'IS_NOT_DATA'</if>
        <if test="gender !=null and !gender.equals('')">AND A3.gendernameshort_Eng = #{gender}</if>
        <if test="ageGroupCode !=null and !ageGroupCode.equals('') and ageGroupCode.length lt 11">
            AND A6.AgeGroupCode IN
            <foreach collection="ageGroupCode" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
        <if test="membershipLevelCode !=null and !membershipLevelCode.equals('') and membershipLevelCode.length lt 4">
            AND A4.MembershipLevelCode IN
            <foreach collection="membershipLevelCode" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
        <if test="proCode !=null and !proCode.equals('') and proCode.length lt 6">
            AND A3.ProCode IN
            <foreach collection="proCode" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
        <if test="clubCode !=null and !clubCode.equals('') and clubCode.length lt 4">
            AND A7.ClubCode IN
            <foreach collection="clubCode" item="item" separator="," close=")" open="(">
                #{item}
            </foreach>
        </if>
    </select>
    <!-- 4. 최근 12개월 매출 추이 -->

    <!-- 5. 등급별 회원 & 매출 성과 -->
    <select id="selectSalesPerformance" resultType="com.icignal.marketing.storeReport.dto.response.MktSalesPerformanceResDto">
        /* MktStoreReportMapper.selectSalesPerformance */
        WITH amount AS (
        SELECT amountMonth AS amountMonth
        , CASE WHEN GROUPING(mbrTear) = 1 THEN N'합계'
        ELSE mbrTear
        END AS mbrTear
        , SUM(cntMbr) AS cntMbr
        , SUM(salAmt) AS salAmt
        , SUM(sort) AS sort
        FROM (
        SELECT FORMAT(A2.Date,'yyyyMM') AS amountMonth
        , A4.MembershipLevelName AS mbrTear
        , COUNT(DISTINCT A3.UserId) AS cntMbr
        , ISNULL(SUM(A1.SalesAmount), 0) AS salAmt
        , A4.MembershipLevelSort AS sort
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
        JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
        JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
        <if test='brandCode == "S"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_S_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "D"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_D_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "Q"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_Q_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "G"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_G_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "M"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_M_Code = A4.MembershipLevelCode</if>
        <if test='brandCode == "U"'>JOIN mrtmktrpt.DimMembershipLevel A4 ON A3.MembershipLevel_U_Code = A4.MembershipLevelCode</if>
        JOIN mrtmktrpt.DimShop A5 ON A1.ShopId = A5.ShopId
        WHERE 1=1
        AND A5.ShopCode = #{shopCode}
        AND A4.MembershipLevelCode != 'IS_NOT_DATA'
        AND ( FORMAT(A2.Date,'yyyyMM') = FORMAT(CONVERT(DATE, #{endDate}),'yyyyMM')
        OR FORMAT(A2.Date,'yyyyMM') = FORMAT(DATEADD(MONTH,-1,CONVERT(DATE, #{endDate})),'yyyyMM')
        OR FORMAT(A2.Date,'yyyyMM') = FORMAT(DATEADD(YEAR,-1,CONVERT(DATE, #{endDate})),'yyyyMM') )
        GROUP BY FORMAT(A2.Date,'yyyyMM'), A4.MembershipLevelName, A4.MembershipLevelSort
        ) A
        GROUP BY ROLLUP(amountMonth, mbrTear)
        HAVING GROUPING(amountMonth) = 0
        )
        SELECT A.mbrTear
        , FORMAT(SUM(A.cntMbr), '#,##0') AS cntMbr
        , FORMAT(SUM(A.salAmt), '#,##0') AS salAmt
        , FORMAT(SUM(A.cntMbr1), '#,##0') AS cntMbr1
        , FORMAT(SUM(A.salAmt1), '#,##0') AS salAmt1
        , CASE
        WHEN SUM(A.cntMbr1) > 0
        THEN ROUND((SUM(A.cntMbr) - SUM(A.cntMbr1)) / CAST(SUM(A.cntMbr1) AS NUMERIC(6,0)) * 100, 1)
        ELSE 0
        END AS iCntMbr2
        , CASE
        WHEN SUM(A.salAmt1) > 0
        THEN ROUND((SUM(A.salAmt) - SUM(A.salAmt1)) / CAST(SUM(A.salAmt1) AS NUMERIC(10,0)) * 100, 1)
        ELSE 0
        END AS iSalAmt2
        , CASE
        WHEN SUM(A.cntMbr0) > 0
        THEN ROUND((SUM(A.cntMbr) - SUM(A.cntMbr0)) / CAST(SUM(A.cntMbr0) AS NUMERIC(6,0)) * 100, 0)
        ELSE 0
        END AS iCntMbr3
        , CASE
        WHEN SUM(A.salAmt0) > 0
        THEN ROUND((SUM(A.salAmt) - SUM(A.salAmt0)) / CAST(SUM(A.salAmt0) AS NUMERIC(10,0)) * 100, 0)
        ELSE 0
        END AS iSalAmt3
        FROM (
        SELECT mbrTear
        , CASE WHEN amountMonth = FORMAT(CONVERT(DATE, #{endDate}),'yyyyMM') THEN cntMbr ELSE 0 END AS cntMbr
        , CASE WHEN amountMonth = FORMAT(CONVERT(DATE, #{endDate}),'yyyyMM') THEN salAmt ELSE 0 END AS salAmt
        , CASE WHEN amountMonth = FORMAT(DATEADD(MONTH,-1,CONVERT(DATE, #{endDate})),'yyyyMM') THEN cntMbr ELSE 0 END AS cntMbr1
        , CASE WHEN amountMonth = FORMAT(DATEADD(MONTH,-1,CONVERT(DATE, #{endDate})),'yyyyMM') THEN salAmt ELSE 0 END AS salAmt1
        , CASE WHEN amountMonth = FORMAT(DATEADD(YEAR,-1,CONVERT(DATE, #{endDate})),'yyyyMM') THEN cntMbr ELSE 0 END AS cntMbr0
        , CASE WHEN amountMonth = FORMAT(DATEADD(YEAR,-1,CONVERT(DATE, #{endDate})),'yyyyMM') THEN salAmt ELSE 0 END AS salAmt0
        , sort
        FROM amount
        GROUP BY mbrTear, amountMonth, sort, cntMbr, salAmt
        ) A
        GROUP BY A.mbrTear, A.sort
        ORDER BY ( CASE WHEN A.sort = 10 THEN 0 ELSE A.sort END ) DESC
    </select>
    <!-- 5. 등급별 회원 & 매출 성과 -->

    <!-- 6. 구간 비교 -->
    <select id="selectDurCmpPieChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiBarChartSeriesDto">
        /* MktStoreReportMapper.selectDurCmpPieChart */
        SELECT
            SUM(A1.SalesQty) AS data
             , CASE
                   WHEN A3.ClassName = ''
                       THEN N'미분류'
                   ELSE A3.ClassName
            END AS name
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
		JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimProduct A3 ON A1.ProductId = A3.ProductId
            JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A3.ProductCode != 'IS_NOT_DATA'
          AND A4.ShopCode = #{shopCode}
        GROUP BY A3.ClassName
        HAVING SUM(A1.SalesQty) > 0
    </select>

    <select id="selectDurCmpAgeChart" resultType="com.icignal.marketing.storeReport.dto.response.TuiAgeChartSeriesDto">
        /* MktStoreReportMapper.selectDurCmpAgeChart */
        SELECT A3.GenderNameFull_KOR                             AS name
             , A3.GenderNameFull_KOR                                  AS stackGroup
             , SUM(CASE WHEN AgeGroupCode = 'A001' THEN 1 ELSE 0 END) AS age_19
             , SUM(CASE WHEN AgeGroupCode = 'A002' THEN 1 ELSE 0 END) AS age_20
             , SUM(CASE WHEN AgeGroupCode = 'A003' THEN 1 ELSE 0 END) AS age_25
             , SUM(CASE WHEN AgeGroupCode = 'A004' THEN 1 ELSE 0 END) AS age_30
             , SUM(CASE WHEN AgeGroupCode = 'A005' THEN 1 ELSE 0 END) AS age_35
             , SUM(CASE WHEN AgeGroupCode = 'A006' THEN 1 ELSE 0 END) AS age_40
             , SUM(CASE WHEN AgeGroupCode = 'A007' THEN 1 ELSE 0 END) AS age_45
             , SUM(CASE WHEN AgeGroupCode = 'A008' THEN 1 ELSE 0 END) AS age_50
             , SUM(CASE WHEN AgeGroupCode = 'A009' THEN 1 ELSE 0 END) AS age_55
             , SUM(CASE WHEN AgeGroupCode = 'A010' THEN 1 ELSE 0 END) AS age_60
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
		JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimMemberInfo A3 ON A1.UserId = A3.UserId
            JOIN mrtmktrpt.DimAgeGroup A5 ON A1.CustomerAgeGroupId = A5.AgeGroupId
            JOIN mrtmktrpt.DimShop A4 ON A1.ShopId = A4.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A3.UserId_Code != 'IS_NOT_DATA'
          AND ( A3.GenderNameShort_ENG = 'M' OR A3.GenderNameShort_ENG = 'F')
          AND A4.ShopCode = #{shopCode}
        GROUP BY A3.GenderNameFull_KOR
        HAVING SUM(A1.SalesQty) > 0
    </select>

    <select id="selectDurCmpPurTotalGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiDurationCompareGridDataDto">
        /* MktStoreReportMapper.selectDurCmpPurTotalGrid */
        SELECT
            N'기준기간'                                    AS colNm
             , FORMAT(COUNT(DISTINCT SALESORDERNO), '#,##0') AS ordCnt   --주문 수
             , FORMAT(ISNULL(SUM(SALESQTY),0), '#,##0')      AS purCnt   --판매수량
             , FORMAT(ISNULL(SUM(SALESAMOUNT),0), '#,##0')   AS sales    --매출
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT SALESORDERNO), 0),0), '#,##0') AS avgOrdSales      --주문당 단가(매출/주문 수)
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
			JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimShop A3 ON A1.ShopId = A3.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A3.SHOPCODE = #{shopCode}
        UNION ALL
        SELECT
            N'비교기간'                                    AS colNm
             , FORMAT(COUNT(DISTINCT SALESORDERNO), '#,##0') AS ordCnt   --주문 수
             , FORMAT(ISNULL(SUM(SALESQTY),0), '#,##0')      AS purCnt   --판매수량
             , FORMAT(ISNULL(SUM(SALESAMOUNT),0), '#,##0')   AS sales    --매출
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT SALESORDERNO), 0),0), '#,##0') AS avgOrdSales      --주문당 단가(매출/주문 수)
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
			JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimShop A3 ON A1.ShopId = A3.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{cmpStartDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{cmpEndDate},120)
          AND A3.SHOPCODE = #{shopCode}
    </select>

    <select id="selectDurCmpPurMbrGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiDurationCompareGridDataDto">
        /* MktStoreReportMapper.selectDurCmpPurMbrGrid */
        SELECT
            N'기준기간'                                      AS colNm
             , FORMAT(COUNT(DISTINCT A1.USERID), '#,##0')    AS mbrCnt   --주문 회원수
             , FORMAT(COUNT(DISTINCT SALESORDERNO), '#,##0') AS ordCnt   --회원 주문수
             , FORMAT(ISNULL(SUM(SALESQTY),0), '#,##0')      AS purCnt   --회원 판매수량
             , FORMAT(ISNULL(SUM(SALESAMOUNT),0), '#,##0')   AS sales    --회원 매출
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT SALESORDERNO), 0),0), '#,##0') AS avgOrdSales      --회원 주문당 단가(회원매출/회원 주문수)
             , FORMAT(ISNULL(ROUND(SUM(SALESQTY) / COUNT(DISTINCT A1.USERID), 2),0), '#,##0.00')    AS avgPurCnt        --회원 객수량(회원 판매수량/주문 회원수)
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT A1.USERID), 0),0), '#,##0')    AS avgMbrSales      --회원 객단가(회원 매출/주문 회원수)
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
			JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimShop A3 ON A1.ShopId = A3.ShopId
            JOIN mrtmktrpt.DimMemberInfo A5 ON A1.UserId = A5.UserId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A3.SHOPCODE = #{shopCode}
          AND A5.USERID_CODE != 'IS_NOT_DATA'
        UNION ALL
        SELECT
            N'비교기간'                                      AS colNm
             , FORMAT(COUNT(DISTINCT A1.USERID), '#,##0')    AS mbrCnt   --주문 회원수
             , FORMAT(COUNT(DISTINCT SALESORDERNO), '#,##0') AS ordCnt   --회원 주문수
             , FORMAT(ISNULL(SUM(SALESQTY),0), '#,##0')      AS purCnt   --회원 판매수량
             , FORMAT(ISNULL(SUM(SALESAMOUNT),0), '#,##0')   AS sales    --회원 매출
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT SALESORDERNO), 0),0), '#,##0') AS avgOrdSales      --회원 주문당 단가(회원매출/회원 주문수)
             , FORMAT(ISNULL(ROUND(SUM(SALESQTY) / COUNT(DISTINCT A1.USERID), 2),0), '#,##0.00')    AS avgPurCnt        --회원 객수량(회원 판매수량/주문 회원수)
             , FORMAT(ISNULL(ROUND(SUM(SALESAMOUNT) / COUNT(DISTINCT A1.USERID), 0),0), '#,##0')    AS avgMbrSales      --회원 객단가(회원 매출/주문 회원수)
        FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
			JOIN mrtmktrpt.DimDate A2 ON A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimShop A3 ON A1.ShopId = A3.ShopId
            JOIN mrtmktrpt.DimMemberInfo A5 ON A1.UserId = A5.UserId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{cmpStartDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{cmpEndDate},120)
          AND A3.SHOPCODE = #{shopCode}
          AND A5.USERID_CODE != 'IS_NOT_DATA'
    </select>

    <select id="selectDupCmpNewMbr" resultType="com.icignal.marketing.storeReport.dto.response.TuiDurationCompareGridDataDto">
        /* MktStoreReportMapper.selectDupCmpNewMbr */
        SELECT COUNT(DISTINCT A1.USERID) AS newMbrCnt
        FROM mrtmktrpt.DimMemberInfo A1 WITH(NOLOCK)
        WHERE 1=1
          AND A1.RegistrationDate <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A1.RegistrationDate <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A1.RegistrationShopCode = #{shopCode}
          AND A1.USERID_CODE != 'IS_NOT_DATA'
        UNION ALL
        SELECT COUNT(DISTINCT A1.USERID) AS newMbrCnt
        FROM mrtmktrpt.DimMemberInfo A1 WITH(NOLOCK)
        WHERE 1=1
          AND A1.RegistrationDate <![CDATA[>=]]> CONVERT(VARCHAR(10),#{cmpStartDate},120)
          AND A1.RegistrationDate <![CDATA[<=]]> CONVERT(VARCHAR(10),#{cmpEndDate},120)
          AND A1.RegistrationShopCode = #{shopCode}
          AND A1.USERID_CODE != 'IS_NOT_DATA'
    </select>

    <select id="selectDurCmpTopItemGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiDurationCompareGridDataDto">
        /* MktStoreReportMapper.selectDurCmpTopItemGrid */
        WITH std AS (
            SELECT
                TOP 10
			  A3.ItemCode         AS itemCode
			, ISNULL(SUM(A1.SalesAmount),0) AS sales
                 , ISNULL(SUM(A1.SalesQty),0)    AS cnt
            FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
            JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
            JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A4.ShopCode = #{shopCode}
        GROUP BY A3.ItemCode
        ORDER BY SUM(A1.SalesAmount) DESC
            ) , cmp AS (
        SELECT
            T3.ItemCode         AS itemCode
                , ISNULL(SUM(T1.SalesAmount),0) AS sales
                , ISNULL(SUM(T1.SalesQty),0)    AS cnt
        FROM MRTMKTRPT.FACTSALESORDER T1 WITH(NOLOCK)
            JOIN mrtmktrpt.DimDate T2 on T1.DateId = T2.DateId
            JOIN mrtmktrpt.DimProduct T3 on T1.ProductId  = T3.ProductId
            JOIN mrtmktrpt.DimShop T4 on T1.ShopId  = T4.ShopId
        WHERE 1=1
          AND T2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{cmpStartDate},120)
          AND T2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{cmpEndDate},120)
          AND T4.SHOPCODE = #{shopCode}
        GROUP BY T3.ItemCode
            )
        SELECT
            std.itemCode                 AS itemCode
             , ISNULL(FORMAT(std.sales, '#,##0'),0) AS stdSales
             , ISNULL(FORMAT(std.cnt, '#,##0'),0)   AS stdPurCnt
             , ISNULL(FORMAT(cmp.sales, '#,##0'),0) AS cmpSales
             , ISNULL(FORMAT(cmp.cnt, '#,##0'),0)   AS cmpPurCnt
             , CASE
                   WHEN cmp.sales != 0
					   THEN ROUND( (std.sales - cmp.sales) / cmp.sales * 100.0, 1 )
                   ELSE 0
            END AS salesRate
             , CASE
                   WHEN cmp.cnt != 0
					   THEN ROUND( (std.cnt - cmp.cnt) / cmp.cnt * 100.0, 1 )
                   ELSE 0
            END AS purCntRate
        FROM std
                 LEFT JOIN cmp ON std.itemCode = cmp.itemCode
        ORDER BY std.cnt desc
    </select>

    <select id="selectDurCmpTopProductGrid" resultType="com.icignal.marketing.storeReport.dto.response.TuiDurationCompareGridDataDto">
        /* MktStoreReportMapper.selectDurCmpTopProductGrid */
        WITH std AS (
            SELECT
                TOP 10
			  A3.ProductCode      AS productCode
			, ISNULL(SUM(A1.SalesAmount),0) AS sales
                 , ISNULL(SUM(A1.SalesQty),0)    AS cnt
            FROM mrtmktrpt.FactSalesOrder A1 WITH(NOLOCK)
            JOIN mrtmktrpt.DimDate A2 on A1.DateId = A2.DateId
            JOIN mrtmktrpt.DimProduct  A3 on A1.ProductId  = A3.ProductId
            JOIN mrtmktrpt.DimShop A4 on A1.ShopId  = A4.ShopId
        WHERE 1=1
          AND A2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{startDate},120)
          AND A2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{endDate},120)
          AND A4.ShopCode = #{shopCode}
        GROUP BY A3.ProductCode
        ORDER BY SUM(A1.SalesAmount) DESC
            ) , cmp AS (
        SELECT
            T3.ProductCode      AS productCode
                , ISNULL(SUM(T1.SalesAmount),0) AS sales
                , ISNULL(SUM(T1.SalesQty),0)    AS cnt
        FROM MRTMKTRPT.FACTSALESORDER T1 WITH(NOLOCK)
            JOIN mrtmktrpt.DimDate T2 on T1.DateId = T2.DateId
            JOIN mrtmktrpt.DimProduct T3 on T1.ProductId  = T3.ProductId
            JOIN mrtmktrpt.DimShop T4 on T1.ShopId  = T4.ShopId
        WHERE 1=1
          AND T2.Date <![CDATA[>=]]> CONVERT(VARCHAR(10),#{cmpStartDate},120)
          AND T2.Date <![CDATA[<=]]> CONVERT(VARCHAR(10),#{cmpEndDate},120)
          AND T4.SHOPCODE = #{shopCode}
        GROUP BY T3.ProductCode
            )
        SELECT
            std.productCode               AS productCode
             , ISNULL(FORMAT(std.sales, '#,##0'),0) AS stdSales
             , ISNULL(FORMAT(std.cnt, '#,##0'),0)   AS stdPurCnt
             , ISNULL(FORMAT(cmp.sales, '#,##0'),0) AS cmpSales
             , ISNULL(FORMAT(cmp.cnt, '#,##0'),0)   AS cmpPurCnt
             , CASE
                   WHEN cmp.sales != 0
					   THEN ROUND( (std.sales - cmp.sales) / cmp.sales * 100.0, 1 )
                   ELSE 0
            END AS salesRate
             , CASE
                   WHEN cmp.cnt != 0
					   THEN ROUND( (std.cnt - cmp.cnt) / cmp.cnt * 100.0, 1 )
                   ELSE 0
            END AS purCntRate
        FROM std
                 LEFT JOIN cmp ON std.productCode = cmp.productCode
        ORDER BY std.cnt desc
    </select>
    <!-- 6. 구간 비교 -->
</mapper>