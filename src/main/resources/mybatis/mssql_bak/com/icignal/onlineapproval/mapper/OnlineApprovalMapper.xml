<?xml version="1.0" encoding="UTF-8"?><!--Converted at: Wed May 02 14:06:40 KST 2018-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icignal.onlineapproval.mapper.OnlineApprMapper">




    <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyElapproval)
	============================================
	-	제목					: 승인 요청한 캠페인 목록 조회
	-	설명					: 승인 요청한 캠페인 목록 조회
	-	결과형태				: 복수
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		elecAprvNo			: 전자 결재 번호
		camName				: 캠페인 명
		camDd				: 날짜
		camType				: 캠페인 유형
		elecAprvStatusCd	: 상태
		lastApvrName		: 최종 결재자 명
		aslastApvDd			: 최종 결재 일자
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMyElapproval" parameterType="com.icignal.onlineapproval.dto.request.ApprovalListReqDto" 
								    resultType="com.icignal.onlineapproval.dto.response.ApprovalListResDto">
		/* OnlineApprovalMapper.selectMyElapproval */
		SELECT 
			 a.id
			,a.elec_aprv_type_cd  			as elecAprvTypeCode
			,a.elec_aprv_no 		as elecAprvNo
			,a.elec_aprv_title 		as elecAprvTitle
			,e.name 				as elecAprvRqtrId
			,convert(varchar,a.create_date,20) 			as createDate
			,a.ELEC_APRV_STATUS_CD 			as elecAprvStatusCode
			,g.name 				as lastApvrId     
			,a.LAST_APV_DD	 			as lastApvDd
			,a.elec_aprv_type_cd    as  aprvType
			,a.cam_id 				as recordRid
			,${strColumn}
		FROM com.com_elec_aprv a with(nolock)
		left outer join com.employee  e with(nolock) on a.elec_aprv_rqtr_id = e.id
		left outer join com.com_elec_aprv_item  f with(nolock) ON f.elec_aprv_id = a.id AND f.flag = '1' AND f.APVR_TYPE_CD='9'
		left outer join com.employee  g with(nolock) on a.LAST_APVR_ID = g.id
		where ${strCondWhere}
		and a.flag = 1 
		and a.elec_aprv_rqtr_id = #{memId}
		<if test="searchType == &quot;A&quot;"> </if>
		<if test="searchType != &quot;A&quot;">
		and a.ELEC_APRV_STATUS_CD not in ('091') 
		</if> 	       
		<!-- and a.accnt_id = #{accntId} -->
		and ${strSVCType}   
		and ${strWhere}	
		ORDER BY ${strOrderby}		
		${strEndPaging}	
	</select>
	
	
	 <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyAprvCount)
	============================================
	-	제목					: 승인 요청한 캠페인 목록 조회
	-	설명					: 1. 승인 요청한 캠페인 목록 조회
							  2. 승인 요청한 캠페인 건수와 미승인건 횟수 조회
	-	결과형태				: 단일
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		aprvReq			    : 요청 건
		lastApvrReq			: 미승인 건
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMyAprvCount" parameterType="com.icignal.onlineapproval.dto.request.AprvCountReqDto" 
								   resultType="com.icignal.onlineapproval.dto.response.AprvCountResDto">
		/* OnlineApprovalMapper.selectMyAprvCount */
		select 
			  ( select  count(id) FROM com.com_elec_aprv a with(nolock)
			  					where ELEC_APRV_RQTR_ID = #{memId} 
		  						 and flag = 1 
		  						 and ELEC_APRV_STATUS_CD NOT IN  ('001','002')	  						 
		  						 ) as aprvReq
			, ( select  count(id) FROM com.com_elec_aprv a with(nolock)
			  					where ELEC_APRV_RQTR_ID = #{memId} 
		  						 and flag = 1 
		  						 and ELEC_APRV_STATUS_CD IN  ('010')	  						 
		  						 ) as lastApvrReq
	</select>
	
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyAgreeCount)
	============================================
	-	제목					: 내가 승인할 캠페인 목록 조회
	-	설명					: 1. 내가 승인할 캠페인 목록 조회
							  2. 내가 승인할 캠페인 건수
	-	결과형태				: 복수
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		aprvReq			    : 요청 건
		lastApvrReq			: 미승인 건
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMyAgreeCount" parameterType="com.icignal.onlineapproval.dto.request.AprvCountReqDto"
									 resultType="com.icignal.onlineapproval.dto.response.AprvCountResDto">
		/* OnlineApprovalMapper.selectMyAgreeCount */
		SELECT   
			  count(a.id) as aprvReq  
		FROM com.com_elec_aprv a with(nolock)
		left outer join com.com_elec_aprv_item b with(nolock) on b.flag = '1' and b.elec_aprv_id = a.id
		where a.flag = '1'
		and b.apvr_id = #{memId}
		and a.ELEC_APRV_STATUS_CD = '010'	
		and b.ELEC_APRV_STATUS_CD = '013'
	</select>
	
	  <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyAgreeCount)
	============================================
	-	제목					: 내가 승인할 캠페인 목록 조회
	-	설명					: 1. 내가 승인할 캠페인 목록 조회
							  2. 내가 승인할 캠페인 건수
	-	결과형태				: 단일
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		aprvReq			    : 요청 건
		lastApvrReq			: 미승인 건
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMyRefCount" parameterType="com.icignal.onlineapproval.dto.request.AprvCountReqDto" 
								  resultType="com.icignal.onlineapproval.dto.response.AprvCountResDto">
		/* OnlineApprovalMapper.selectMyRefCount */
		SELECT  
			  count(mea.id) as aprvReq   
		FROM com.com_elec_aprv mea with(nolock)
		join com.com_elec_aprv_item c4 with(nolock) on c4.elec_aprv_id = mea.id and c4.flag = 1 and c4.apvr_id = #{memId}
		and c4.apvr_type_cd = '10'
		where mea.flag = 1
	</select>
	    

    <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyElapproval2)
	============================================
	-	제목					: 내가 승인할 캠페인 목록 조회
	-	설명					: 내가 승인할 캠페인 목록 조회
	-	결과형태				: 복수
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		elecAprvNo			: 전자 결재 번호
		camName				: 캠페인 명
		camDd				: 날짜
		camType				: 캠페인 유형
		elecAprvStatusCd	: 상태
		lastApvrName		: 최종 결재자 명
		aslastApvDd			: 최종 결재 일자
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMyElapproval2" parameterType="com.icignal.onlineapproval.dto.request.ApprovalListReqDto" 
			resultType="com.icignal.onlineapproval.dto.response.ApprovalListResDto">	
    	/* OnlineApprovalMapper.selectMyElapproval2 */
		SELECT 
			  a.id
			, a.elec_aprv_no      as elecAprvNo  
			, a.elec_aprv_title   as elecAprvTitle
			, convert(varchar,a.create_date,20)       as createDate
			, f.apv_dd		      as lastApvDd
			, a.elec_aprv_type_cd as aprvType
			, a.cam_id 			  as recordRid
			, a.elec_aprv_type_cd         as elecAprvTypeCode
			, a.ELEC_APRV_STATUS_CD         as elecAprvStatusCode
			, e.name 	          as elecAprvRqtrId 
			, g.name 	          as lastApvrId
			, h.id				  as itemId    
			, h.elec_aprv_seq     as seq 
			, h.apvr_type_cd 	  as apvrTypeCd       
	        , ${strColumn}
		from com.com_elec_aprv a with(nolock)
		left outer join com.com_elec_aprv_item h with(nolock) on h.elec_aprv_id = a.id and h.flag = '1'
		left outer join com.employee  e with(nolock) on a.elec_aprv_rqtr_id  = e.id
		left outer join com.com_elec_aprv_item  f with(nolock) ON f.elec_aprv_id = a.id AND f.flag = '1' AND f.APVR_TYPE_CD='9'
		left outer join com.employee  g with(nolock) ON f.apvr_id = g.id
		where ${strCondWhere}
		and  a.flag = '1'
		and  a.ELEC_APRV_STATUS_CD = '010'
		and  h.ELEC_APRV_STATUS_CD = '013'
		and  h.apvr_id = #{memId}
		and ${strSVCType}
		and ${strWhere}	
		ORDER BY ${strOrderby}		
		${strEndPaging}	
	</select>
	
	  <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMyElapproval2)
	============================================
	-	제목					: 내가 참조된 캠페인 목록 조회
	-	설명					: 내가 참조된 캠페인 목록 조회
	-	결과형태				: 복수
	============================================
	-	입력
		memId				: 접속자 ID
	-	출력
		elecAprvNo			: 전자 결재 번호
		camName				: 캠페인 명
		camDd				: 날짜
		camType				: 캠페인 유형
		elecAprvStatusCd	: 상태
		lastApvrName		: 최종 결재자 명
		aslastApvDd			: 최종 결재 일자
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectRefElapproval" parameterType="com.icignal.onlineapproval.dto.request.ApprovalListReqDto" 
		resultType="com.icignal.onlineapproval.dto.response.ApprovalListResDto">	
		/* OnlineApprovalMapper.selectRefElapproval */
		SELECT mea.id 			as id   
			, mea.elec_aprv_no 	as elecAprvNo   
			, c1.cam_nm 		as camName   
			, convert(varchar,replace(convert(date,c1.cam_start_dd),1900-01-01,''), 23) ||'~'||convert(varchar,replace(convert(date,c1.cam_end_dd),1900-01-01,''),23) as camDd  
			, c1.CAM_TYPE_CD    as camTypeCd
			, mea.create_date 	as createDd 
			, mea.ELEC_APRV_STATUS_CD	as elecAprvStatusCode  
			, c5.name 			as lastApvrName   
			, c6.apv_dd 		as lastApvDd   
			, c4.id 			as itemId  
			, ac.code_name 		as itemStatus
			, ${strColumn}
		FROM com.com_elec_aprv mea with(nolock)
		left outer join mkt.mkt_cam_mst c1 with(nolock) on c1.id = mea.cam_id
		left outer join com.comm_code 	c3 with(nolock) on c3.flag = 1 and c3.code_name = mea.ELEC_APRV_STATUS_CD   and c3.lang = #{lang} and c3.group_code = 'EL_APPROVAL_STATUS_CD'
		join com.com_elec_aprv_item 	c4 with(nolock) on c4.elec_aprv_id = mea.id and c4.flag =1 and c4.apvr_id = #{memId} and c4.apvr_type_cd = '10'
		left outer join com.comm_code 	ac with(nolock) on ac.flag = 1 and ac.code_name = c4.apvr_type_cd and ac.lang = #{lang} and ac.group_code = 'EL_APPROVER_TYPE_CD'
		left outer join com.com_elec_aprv_item c6 with(nolock) on c6.elec_aprv_id = mea.id and c6.flag =1 and c6.apvr_type_cd = '9'
		left outer join com.employee 	c5 with(nolock) on c5.id = c6.APVR_ID
		where ${strCondWhere}
		and  mea.flag = '1'
		and ${strSVCType}
		and ${strWhere}
		group by mea.id
		ORDER BY ${strOrderby}		
		${strEndPaging}	
	</select>
   
	    <!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectDetailAprv)
	============================================
	-	제목					: 결재 캠페인 상세 조회
	-	설명					: 결재 캠페인 상세 조회
	-	결과형태				: 복수
	============================================
	-	입력
		id				    : 고유 아이디
		accntId				: 접속자 아이디
	-	출력
		camNm				: 캠페인명
		camDesc				: 캠페인 설명
		camId				: 캠페인 아이디
		createBy			: 기안요청자
		Dept				: 부서
		createDd			: 기안 요청 일자
		rqtDd				: 결재 요청 일자
		status				: 상태
		aprvDesc			: 설명
		contetnt			: 내용
		fileName			: 파일명
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectDetailAprv" parameterType="com.icignal.onlineapproval.dto.request.ApprovalDetailReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalDetailResDto">
		/* OnlineApprovalMapper.selectDetailAprv */
    	SELECT
    		  mea.id                  	as id
    		, mea.cam_id             	as camId
    	    , mea.create_by           	as createId
    	    , mea.elec_aprv_desc     	as aprvDesc
    		, mea.elec_aprv_sbst      	as contetnt
            , mea.elec_aprv_rqtr_id     as elecAprvRqtrId
            , mea.elec_aprv_status_cd   as elecAprvStatusCd
            , c4.name                   as elecAprvRqtrNm
            
            , mea.elec_aprv_rqtr_org_id as elecAprvRqtrOrgId
            , ac2.div_nm                as elecAprvRqtrOrgNm
            , mea.elec_aprv_type_cd     as elecAprvTypeCd
            
    		, convert(varchar, replace(convert(date, mea.create_date),1900-01-01,''),23)            as createDd
    		, convert(varchar, replace(convert(date, mea.elec_aprv_cmplt_rqt_dd),1900-01-01,''),23)    as rqtDd   
            
    		, mcm.cam_nm   as camNm
    		, mcm.cam_desc as camDesc
    	    
    	    , d1.div_nm    as Dept
    	    , c2.code_name as status 
    		, c3.file_name as fileName
            
    	FROM com.com_elec_aprv           mea with(nolock)
    	left outer join mkt.mkt_cam_mst  mcm with(nolock) on mcm.id = mea.cam_id
    	left outer join com.crm_user     u1  with(nolock) on u1.rid = mea.create_by
    	left outer join com.employee     c1  with(nolock) on c1.id = u1.id_employee
        left outer join com.crm_division d1  with(nolock) on d1.rid = c1.rid_division
    	join com.comm_code               c2  with(nolock) on c2.flag = 1 and c2.code_name = mea.elec_aprv_status_cd and c2.lang = #{lang} and c2.group_code = 'EL_APPROVAL_STATUS_CD'
    	left outer join com.com_file     c3  with(nolock) on c3.parent_id = mea.id
        
        left outer join com.employee     c4  with(nolock) on c4.id = mea.elec_aprv_rqtr_id
        left outer join com.crm_division ac2 with(nolock) on ac2.rid = c4.rid_division
        where mea.flag = '1'
        and mea.id = #{id}
    	<!-- and mea.accnt_id = #{accntId} -->
    	and ${strSVCType}
          
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(getMyApproverList)
	============================================
	-	제목					: 승인할 유저 목록 조회
	-	설명					: 승인할 유저 목록 조회
	-	결과형태				: 단일
	============================================
	-	입력
		memId				: 접속자 아이디
	-	출력
		id					: 고유 아이디
		elecAprvNo			: 순서
		elecAprvTypeCd		: 결제자 타입
		elecAprvCmpltRqtDd	: 부서
		elecAprvStatusCd	: 상태
		createBy			: 유저명
		lastApvDd			: 경제 승일 일자
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="getMyApproverList" parameterType="com.icignal.onlineapproval.dto.request.ApprovalListReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalListResDto">
		/* OnlineApprovalMapper.getMyApproverList */
		select mea.id 			 as id
		  , mea.ELEC_APRV_NO as elecAprvNo
		  , c1.CAM_NM 		 as camName 
		  , convert(varchar, replace(convert(date,c1.cam_start_dd),1900-01-01,''),23) ||'~'|| convert(varchar,replace(convert(date,c1.cam_end_dd),1900-01-01,''),23) as elecAprvTypeCd
		  , convert(varchar, replace(convert(date,mea.ELEC_APRV_CMPLT_RQT_DD),1900-01-01,''),23)  as elecAprvCmpltRqtDd
		  , mea.ELEC_APRV_STATUS_CD 	 as elecAprvStatusCode
		  , mea.create_by 	 as createBy
		  , convert(varchar, replace(convert(date, mea.LAST_APV_DD),1900-01-01,''),23) as lastApvDd
		  , ${strColumn}
		from com.com_elec_aprv mea with(nolock)
		join mkt.mkt_cam_mst   c1 with(nolock) on c1.id = mea.CAM_ID
		where mea.flag = '1' and mea.LAST_APVR_ID like #{memId}
		and ${strSVCType}
		and ${strWhere}
		ORDER BY ${strOrderby}		
		${strEndPaging}	
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selectAprvList)
	============================================
	-	제목					: 결재 승인자 조회
	-	설명					: 1. 결재 등록 상세페이지 접속
							  2. 결재 승인자 목록
	-	결과형태				: 복수
	============================================
	-	입력
		id				    : 고유 아이디
	-	출력
		id                  : 고유 아이디
		seq				    : 순서
		apprvType			: 결제자 유형
		apprvName			: 성명
		elApproveStatus		: 상태
		apprvDept			: 소속
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectAprvList" parameterType="com.icignal.onlineapproval.dto.request.ApprvReqReqDto"
	 resultType="com.icignal.onlineapproval.dto.response.ApprvReqResDto">
	/* OnlineApprovalMapper.selectAprvList */
SELECT 
		  meai.ID as id
		, meai.ELEC_APRV_SEQ as seq
		, c1.MARK_NAME as apprvType
		, meai.APVR_TYPE_CD as apprvCode
	    , c3.NAME as apprvName
		, c2.MARK_NAME as elApproveStatus
		, meai.ELEC_APRV_STATUS_CD as elApproveStatusCd
		, di.div_nm as apprvDept
		, convert(varchar, meai.apv_dd, 23) as apvDd
		, meai.apvr_org_id as acId
		, meai.apvr_id as apvrId
	FROM com.com_elec_aprv_item meai with(nolock)
	left outer join com.comm_code   c1 with(nolock) on c1.flag = 1 and c1.code_name = meai.APVR_TYPE_CD and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD'
	left outer join com.comm_code   c2 with(nolock) on c2.flag = 1 and c2.code_name = meai.ELEC_APRV_STATUS_CD and c2.lang = #{lang} and c2.group_code = 'EL_APL_ITEM_STATUS_CD'
	left outer join com.employee    c3 with(nolock) on c3.id = meai.APVR_ID
    left outer join com.crm_division di with(nolock) on di.rid = c3.RID_DIVISION
	where meai.flag = '1'
	and meai.ELEC_APRV_ID = #{id}
	and c1.CODE_NAME != 10
	and ${strSVCType}
	order by meai.elec_aprv_seq asc
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selecReftAprvList)
	============================================
	-	제목					: 결재 참조자 조회
	-	설명					: 1. 결재 등록 상세페이지 접속
							  2. 결재 참조자 목록
	-	결과형태				: 복수
	============================================
	-	입력
		id				    : 고유 아이디
	-	출력
		id                  : 고유 아이디
		seq				    : 순서
		apprvType			: 결제자 유형
		apprvName			: 성명
		elApproveStatus		: 상태
		apprvDept			: 소속
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selecReftAprvList" parameterType="com.icignal.onlineapproval.dto.request.ApprvReqReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprvReqResDto">
	/* OnlineApprovalMapper.selecReftAprvList */
	SELECT meai.ID as id
		, meai.ELEC_APRV_SEQ as seq
	    , c3.NAME as apprvName
		, CONCAT(c5.name,'&gt;',c6.name) as apprvDept
		, meai.apvr_org_id as acId
		, meai.apvr_id as apvrId  
		, ${strColumn}  
	FROM com.com_elec_aprv_item meai with(nolock)
	left outer join com.comm_code   c1 with(nolock) on c1.flag = 1 and c1.code_name = meai.APVR_TYPE_CD and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD'
	left outer join com.comm_code   c2 with(nolock) on c2.flag = 1 and c2.code_name =  meai.ELEC_APRV_STATUS_CD and c2.lang = #{lang} and c2.group_code = 'EL_APL_ITEM_STATUS_CD'
	left outer join com.employee  c3 with(nolock) on c3.id = meai.APVR_ID
	left outer join com.account c5 with(nolock) on c5.id = meai.APVR_ORG_ID
	left outer join com.account c6 with(nolock) on c6.id = c5.par_acc_id
	where meai.flag = '1'
	and c1.CODE_NAME = '10'
	and meai.ELEC_APRV_ID = #{id}
	and ${strSVCType}

	</select>
	
	
		<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selectApproverStatus)
	============================================
	-	제목					: 결재 참조자 조회
	-	설명					: 1. 승인 진행 상태 조회
							  2. 테이블의 컬럼 선택시 승인 진행 상태를 화면에 뿌려준다.
	-	결과형태				: 복수
	============================================
	-	입력
		id				    : 고유 아이디
	-	출력
		id                  : 고유 아이디
		seq				    : 순서
		apprvType			: 결제자 유형
		apprvCode           : 결제자 코드
		apprvName			: 성명
		elApproveStatus		: 상태
		statusCode          : 상태 코드
		apvDd				: 승인 일자
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectApproverStatus" parameterType="com.icignal.onlineapproval.dto.request.ApprvReqReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprvReqResDto">
	/* OnlineApprovalMapper.selectApproverStatus */
	SELECT 
		  meai.ID as id
		, meai.ELEC_APRV_SEQ as seq
		, c1.MARK_NAME as apprvType
		, c1.code_name as apprvCode
	    , SUBSTRING(c3.NAME , 1, 8)as apprvName
		, isnull(c2.MARK_NAME,'-') as elApproveStatus   
		, isnull(c2.code_name,'-') as statusCode 
		, isnull(convert(varchar,replace(convert(date,meai.apv_dd),1900-01-01,''),23),' - ') as apvDd
	FROM com.com_elec_aprv_item meai with(nolock)
	join com.comm_code c1 with(nolock) on c1.flag = 1 and c1.code_name = meai.APVR_TYPE_CD  and c1.CODE_NAME != '10' and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD'
	left outer join com.comm_code c2 with(nolock) on c2.flag = 1 and c2.code_name =  meai.ELEC_APRV_STATUS_CD and c2.lang = #{lang} and c2.group_code = 'EL_APL_ITEM_STATUS_CD'
	join com.employee    c3 with(nolock) on c3.id = meai.APVR_ID
	where meai.flag = '1'
	and meai.ELEC_APRV_ID = #{id}
	Order by c1.CODE_NAME asc, meai.ELEC_APRV_SEQ
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selectCampaign)
	============================================
	-	제목					: 캠페인 목록 조회
	-	설명					: 1. 캠페인 목록 조회
	-	결과형태				: 복수
	============================================
	-	출력
		id                  : 고유 아이디
		description		    : 설명
		camNm				: 캠페인명
		statDD				: 시작일
		endDD				: 종료일
		camStatus			: 상태
		camType				: 유형
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectCampaign" parameterType="com.icignal.onlineapproval.dto.request.ApprvReqReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprvCamListResDto">
	/* OnlineApprovalMapper.selectCampaign */
	SELECT mcm.id
		, mcm.cam_desc as description  
		, mcm.cam_nm as camNm
		, convert(varchar,replace(convert(date,mcm.CAM_START_DD),1900-01-01,''),23)  as statDD
		, convert(varchar,replace(convert(date,mcm.CAM_END_DD),1900-01-01,''),23)  as endDD
		, c2.mark_name as camStatus
		, c1.MARK_NAME as camType
		, ${strColumn}
    FROM mkt.mkt_cam_mst mcm with(nolock)
	join com.comm_code c1 with(nolock) on c1.code_name = mcm.cam_type_cd and c1.lang = #{lang} and c1.flag = 1 and c1.group_code = 'MKT_CAM_TYPE_CD'
	join com.comm_code c2 with(nolock) on c2.code_name = mcm.cam_status_cd and c2.lang = #{lang} and c2.flag = 1 and c2.group_code = 'MKT_CAM_STAT'
	where ${strSVCType}
	<!-- and mcm.accnt_id = #{accntId} -->
	and ${strDataAuthWhere}
	and ${strDataAuthWhere}
	and ${strWhere}
	and mcm.flag = 1
	and c1.code_name != 'QUICK'
	and (c2.code_name = 'W' or c2.code_name = 'A')
	and mcm.id not in (select cam_id from com.com_elec_aprv ea with(nolock) where flag = 1)
	ORDER BY ${strOrderby}		
	${strEndPaging}	
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(createAprvNo)
	============================================
	-	제목					: 전자 결재 번호 출력
	-	설명					: 전자 결재 번호 출력
	-	결과형태				: 단일
	============================================
	-	출력
		elecAprvNo          : 전자 결재 번호
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->	
	<select id="createAprvNo" parameterType="com.icignal.onlineapproval.dto.request.ApprovalInsertReqDto" 
	resultType="java.lang.String">
	/* OnlineApprovalMapper.createAprvNo */
	select (convert(varchar,year(getdate()))+'010'+isnull(format(right(max(elec_aprv_no), 5) + 1,'00000'),'00001')) as elecAprvNo
	from com.com_elec_aprv with(nolock)
	where elec_aprv_no like (convert(varchar,year(getdate()))+'%')
	</select>

	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(insertApproval)
	============================================
	-	제목					: 전자 결제 등록 
	-	설명					: 전자 결제 등록 
	-	결과형태				: 단일
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvNo          : 전자결재번호
        elecAprvTypeCd      : 유형
        elecAprvDivCd       : 구분
        camId               : 캠페인 ID
        elecAprvTitle       : 제목
        elecAprvSbst        : 내용
        elecAprvStatusCd    : 상태
        elecAprvRqtrId      : 상진자 ID
        elecAprvRqtrOrgId   : 결제상신자 소속부서 ID
        elecAprvCmpltRqtDd  : 결재완료 요청일자
        lastApvDd           : 최종 승인 일자
        lastApvrId          : 최종 승인자 ID
        elecAprvDesc        : 설명
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<insert id="insertApproval" parameterType="com.icignal.onlineapproval.dto.request.ApprovalInsertReqDto">
	/* OnlineApprovalMapper.insertApproval */
	insert into com.com_elec_aprv(
			  id
			, create_by
			, modify_by
			, create_date
			, modify_date
			, flag
			<!-- , country -->
			<!-- , app_service_type -->
			<!-- , accnt_id -->
			, elec_aprv_no
			, elec_aprv_type_cd
			, elec_aprv_div_cd
			, cam_id
			, elec_aprv_title
			, elec_aprv_sbst
			, elec_aprv_status_cd
			, elec_aprv_rqtr_id
			, elec_aprv_rqtr_org_id
			, elec_aprv_cmplt_rqt_dd
			, last_apv_dd
			, last_apvr_id
			, elec_aprv_desc
	)values(
			  #{id}   
	 	    , #{memId}
			, #{memId}
			, getdate()   
			, getdate()
			, '1'
			<!-- , #{country} -->
			<!-- , #{appServiceId} -->
			<!-- , #{accntId} -->     	 
			, #{elecAprvNo}         
			, #{elecAprvTypeCd}
			, '1'   
			, #{camId}             
			, #{elecAprvTitle}     
			, #{elecAprvSbst}      
			, '001'   
			, #{elecAprvRqtrId}     
			, #{elecAprvRqtrOrgId}  
			, #{elecAprvCmpltRqtDd} 
			, #{lastApvDd}          
			, #{lastApvrId}      
			, #{elecAprvDesc} 
	)
	<selectKey keyProperty="" resultType="java.lang.String">
			select id from com.com_elec_aprv with(nolock) where id = #{id}
	</selectKey>
	</insert>
	
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selectItemSeq)
	============================================
	-	제목					: 전자 결재 승인자 순서 출력
	-	설명					: 전자 결재 승인자 순서 출력
	-	결과형태				: 단일
	============================================
	-	출력
		elecAprvNo          : 전자 결재 승인자 순서
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->	
	<select id="selectItemSeq" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectItemSeq */
	SELECT isnull( max(elec_aprv_seq),0)+1
    FROM com.com_elec_aprv_item with(nolock)
	where ELEC_APRV_ID = #{aprvId} and flag = 1
	and APVR_TYPE_CD != '10' 
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(selectItemSeq)
	============================================
	-	제목					: 전자 결재 참조자 순서 출력
	-	설명					: 전자 결재 참조자 순서 출력
	-	결과형태				: 단일
	============================================
	-	출력
		elecAprvNo          : 전자 결재 참조자 순서
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->	
	<select id="selectRefItemSeq" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectRefItemSeq */
	SELECT isnull( max(elec_aprv_seq),100)+1
    FROM com.com_elec_aprv_item with(nolock)
	where ELEC_APRV_ID = #{aprvId} and flag = 1
	and APVR_TYPE_CD = '10' 
	</select>

	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(insertItemApproval)
	============================================
	-	제목					: 전자 결재 참조자 순서 출력
	-	설명					: 전자 결재 참조자 순서 출력
	-	결과형태				: 단일
	============================================
	-	출력
		elecAprvNo          : 전자 결재 참조자 순서
		,aprvId             : 결재 번호
		,seq				: 순서
		,arvrId				: 유저 ID
		,orgId				: 부서 ID
		,apvDD				: 결재 일자
		,apvrType  			: 승인자 유형
		,aprbStatus			: 결재 유형
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->	    
	<insert id="insertItemApproval" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
	/* OnlineApprovalMapper.insertItemApproval */
	insert into com.com_elec_aprv_item(
	 		  id
			, create_by
			, modify_by
			, create_date
			, modify_date
			, flag
			<!-- , country -->
			<!-- , app_service_type -->
			, ELEC_APRV_ID
			, ELEC_APRV_SEQ
			, APVR_ID
			, APVR_ORG_ID
			, APV_DD
			, APVR_TYPE_CD
			, ELEC_APRV_STATUS_CD)
	values(
	 	      #{id}  
		 	, #{memId}
			, #{memId}
			, getdate()   
			, getdate()
			, '1'
			<!-- , #{country} -->
			<!-- , #{appServiceId} -->
			, #{aprvId}
			, #{seq}
			, #{arvrId}
			, #{orgId}
			, #{apvDD}
			, #{apvrType}    
			, #{aprbStatus}  
	)    	    
	<selectKey keyProperty="" resultType="java.lang.String">
			select id from com.com_elec_aprv_item with(nolock) where id = #{id}
	</selectKey>
	</insert>   
	
	
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateElapproval)
	============================================
	-	제목					: 전자 결제 수정
	-	설명					: 전자 결제 수정 
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvTypeCd      : 유형
        elecAprvDivCd       : 구분
        camId               : 캠페인 ID
        elecAprvTitle       : 제목
        elecAprvSbst        : 내용
        elecAprvStatusCd    : 상태
        elecAprvRqtrId      : 상진자 ID
        elecAprvRqtrOrgId   : 결제상신자 소속부서 ID
        elecAprvCmpltRqtDd  : 결재완료 요청일자
        lastApvDd           : 최종 승인 일자
        lastApvrId          : 최종 승인자 ID
        elecAprvDesc        : 설명
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateElapproval" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto">
	/* OnlineApprovalMapper.updateElapproval */
	    UPDATE com.com_elec_aprv
        SET
			  modify_by = #{memId}
			, modify_date = getdate()
			, cam_id = #{camId}
            
			, elec_aprv_type_cd      = #{elecAprvTypeCd} 
			, elec_aprv_div_cd       = #{elecAprvDivCd} 
			, elec_aprv_title        = #{elecAprvTitle} 
			, elec_aprv_sbst         = #{elecAprvSbst} 
			, elec_aprv_status_cd    = #{elecAprvStatusCd}   
			, elec_aprv_cmplt_rqt_dd = #{elecAprvCmpltRqtDd}
			, elec_aprv_desc         = #{elecAprvDesc}          
            , elec_aprv_rqtr_id      = #{elecAprvRqtrId}
            , elec_aprv_rqtr_org_id  = #{elecAprvRqtrOrgId}
            
			, last_apv_dd = #{lastApvDd}
			, last_apvr_id = #{lastApvrId}
        where id = #{id}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateAprvType)
	============================================
	-	제목					: 전자 결제 타입 수정
	-	설명					: 1. 전자 결제 등록.
							  2. 전자 결제 유형에 따른 수정(상신/재상신/작성 중)
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvStatusCd    : 상태
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateAprvType" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto">
	/* OnlineApprovalMapper.updateAprvType */
	UPDATE com.com_elec_aprv SET
			  modify_by = #{memId}
			, modify_date = getdate()
			, elec_aprv_status_cd =  #{elecAprvStatusCd}           
	where id = #{id}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateAprvType)
	============================================
	-	제목					: 전자 결제 승인 및 반려
	-	설명					: 1. 전자 결제 승인 및 반려
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvStatusCd    : 상태
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateReject" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemRejectReqDto">
	/* OnlineApprovalMapper.updateReject */
	UPDATE com.com_elec_aprv_item SET
			  modify_by = #{memId}
			, modify_date = getdate()
			<if test="apvDd != null and apvDd != ''"> 
			, apv_dd = getdate()
			</if>
			<if test="rejectRsn != null and rejectRsn != ''"> 
			, REJECT_RSN = #{rejectRsn}   
			, REJECT_DD = getdate() 
			</if> 
			, elec_aprv_status_cd = #{statusCode}     
	where elec_aprv_id = #{id} 
	  and apvr_id = #{apvrId}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateAprvType)
	============================================
	-	제목					: 전자 결제 승인 및 반려
	-	설명					: 1. 전자 결제 승인 및 반려
							  2. 반려 데이터의 다음 값 아이디 검색
							  3. 해당 값을 통해 결제 검토로 상태 값 변경
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvStatusCd    : 상태
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateReStatus" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemRejectReqDto">
	/* OnlineApprovalMapper.updateReStatus */
	UPDATE com.com_elec_aprv_item SET
			  modify_by = #{memId}
			, modify_date = getdate()
			, elec_aprv_status_cd = '013'     
	where id = #{id}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectRejectNxId)
	============================================
	-	제목					: 전자 결제 승인 및 반려에 따른 결재 검토 업데이트하기 위한 아이디 가져오기.
	-	설명					: 1. 전자 결제 승인 및 반려
							  2. 다음 순서의 아이디 가져오기
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvStatusCd    : 상태
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectRejectNxId" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemRejectReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectRejectNxId */
	SELECT meai.id
	FROM com.com_elec_aprv_item meai with(nolock)
	join com.com_elec_aprv_item c1 with(nolock) on c1.elec_aprv_id = meai.elec_aprv_id and c1.flag = 1
	where meai.flag = 1 
	and  meai.elec_aprv_id = #{id}
	and meai.ELEC_APRV_SEQ = (
			select ELEC_APRV_SEQ+1 from com.com_elec_aprv_item with(nolock)
			where flag = 1 
			and id = #{itemId}) 
	group by meai.id
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectElCode)
	============================================
	-	제목					: 재상신 값 체크를 위한 코드 가져오기
	-	설명					: 1. 재상신 값 체크를 위한 코드 가져오기
	-	결과형태				: 
	============================================
	-	출력
        c1.code_name        : 결재 코드 유형
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectElCode" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectElCode */
	SELECT
		c1.code_name
	FROM com.com_elec_aprv mea with(nolock)
	join com.comm_code c1 with(nolock) on c1.flag = 1 and c1.code_name = mea.ELEC_APRV_STATUS_CD and c1.lang = #{lang} and c1.group_code = 'EL_APPROVAL_STATUS_CD'
	where mea.id= #{id} 
	</select>



	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateItemType)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 승인자 Insert 전에 동작
							  2. 결제 승인자의 유형은 중간 승인자로 모두 바꾼다.
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateItemType" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
	/* OnlineApprovalMapper.updateItemType */
	UPDATE com.com_elec_aprv_item 
    SET
       	APVR_TYPE_CD = '2'  
	where ELEC_APRV_ID = #{aprvId} 
    and flag = 1
	and APVR_TYPE_CD != '10' 
	</update>
	
		<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateItemStatusType)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 상신
							  2. 결제 승인자들의 상태를 결제 검토로 바꾼다.
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateItemStatusType" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto">
	/* OnlineApprovalMapper.updateItemStatusType */
	UPDATE com.com_elec_aprv_item 
    SET
       	elec_aprv_status_cd = '013'  
	where ELEC_APRV_ID = #{id} 
    and flag = 1
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateItemStatusType)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 재상신
							  2. 결제 승인자들의 상태를 없앤다
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateItemReStatusType" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto">
	/* OnlineApprovalMapper.updateItemReStatusType */
	UPDATE com.com_elec_aprv_item SET
         	elec_aprv_status_cd = '' 
	where ELEC_APRV_ID = #{id} 
    and flag = 1
	</update>
	
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(deleteItem)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 승인자 선택
							  2. 결제 승인자 제거
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="deleteItem" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemDeleteReqDto">
	/* OnlineApprovalMapper.deleteItem */
	 UPDATE com.com_elec_aprv_item SET
	      modify_by = #{memId}
		, modify_date = getdate()
		, flag = '0'  
	 where ${strSVCType} 
     and elec_aprv_id = #{id}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(updateItem)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 승인자 선택
							  2. 결제 승인자 제거
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="updateItem" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemDeleteReqDto">
	/* OnlineApprovalMapper.updateItem */
	 UPDATE com.com_elec_aprv_item SET
	      modify_by = #{memId}
		, modify_date = getdate() 
		, elec_aprv_id = #{elecId}
	 where ${strSVCType} 
	 <if test="listChannelFlowId.size() != 0">
	 and id in
	    <foreach collection="listChannelFlowId" item="item" separator="," close=")" open="(">
			#{item}
		</foreach>
	</if>
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(deleteItemLogSave)
	============================================
	-	제목					: 결제 승인자 유형 바꾼 후 로그 남기기
	-	설명					: 1. 결제 승인자의 유형이 바뀐다.
							  2. 결제 승인자의 로그를 남기기 위해 해당 데이터를 0으로 업데이트	 
	-	결과형태				: 
	============================================
	-	입력
        id                  : 고유 아이디
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="deleteItemLogSave" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto">
	/* OnlineApprovalMapper.deleteItemLogSave */
	 update com.com_elec_aprv_item set 
		  modify_by = #{memId}
		, modify_date = getdate()
		, flag = '0'
	where id = #{id}
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectSeqOne)
	============================================
	-	제목					: 결제 상신으로 유형 변동 시 해당 값 업데이트를 위한 Row 뽑기.
	-	설명					: 1. 결제 상신으로 유형이 변동
							  2. 결제 상신으로 유형 변동 시 가장 첫번째 Row를 가져오기.
	-	결과형태				: 
	============================================
	-	입력
        memId               : 접속 ID
        elecAprvStatusCd    : 상태
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectSeqOne" parameterType="com.icignal.onlineapproval.dto.request.ApprovalUpdateReqDto" 
	resultType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
	/* OnlineApprovalMapper.selectSeqOne */
	SELECT 
		  meai.id 					as id
		, meai.create_by 			as createBy
		, meai.modify_by 			as modifyBy
		, meai.elec_aprv_id 		as aprvId
		, meai.elec_aprv_seq 		as seq
		, meai.apvr_id 				as arvrId
		, meai.apvr_org_id 			as orgId
		, meai.apv_dd 				as apvDD
		<!-- , c1.code_name 				as apvrType -->
		, meai.apvr_type_cd			as apvrTypeCd
		, meai.ELEC_APRV_STATUS_CD 	as aprbStatus
		, meai.reject_dd 			as rejectDd
		, meai.reject_rsn 			as rejectRsn
	FROM com.com_elec_aprv_item meai with(nolock)
	<!-- join com.comm_code c1 on c1.flag = 1 and c1.code_name = meai.apvr_type_cd  and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD' -->
	where meai.elec_aprv_id = #{id}
	and meai.flag = 1
    and meai.elec_aprv_seq = '1' 
	and (meai.elec_aprv_status_cd is null or meai.elec_aprv_status_cd = '')
	</select>
	
		<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(deleteItemAlignSeq)
	============================================
	-	제목					: 결제 승인자 유형 바꾸기
	-	설명					: 1. 결제 승인자 제거
							  2. 시퀀스 재정렬
	-	결과형태				: 
	============================================
	-	입력
        aprvId              : 전자 결제 아이디
        seq                 : 시퀀스
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<update id="deleteItemAlignSeq" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemDeleteReqDto">
	/* OnlineApprovalMapper.deleteItemAlignSeq */
	UPDATE com.com_elec_aprv_item 
    SET
         	elec_aprv_seq = elec_aprv_seq - 1 
	where ELEC_APRV_ID = #{aprvId} 
    and flag = 1 
    and elec_aprv_seq &gt; #{seq}
	</update>


	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectApproverList)
	============================================
	-	제목					: 전자 결제 결제가 조회
	-	설명					: 1. 전자 결제 등록 페이지
							  2. 경제 승인자 추가 버튼 클릭 후 결제자 리스트 조회
	-	결과형태				: 복수
	============================================
	-	출력
        empNm               : 이름
        email      			: 이메일
        accNm       		: 부서명
        paraccNM            : 상위 부서명
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
	============================================
	-	수정자					: hy.jun
	-	수정일					: 2018.03.03
	-   설명 						: 캠페인 필수결재승인자일 경우 목록노출 제외. 결재저장 시 자동으로 최종아이템으로 추가된다.
    ***************************************/ -->
	<select id="selectApproverList" parameterType="com.icignal.onlineapproval.dto.request.ApprovalEmpListReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalEmpListResDto">
	/*MKTElapproval.selectApproverList*/
	select DISTINCT(em.id)    as id
		, em.name  as empNm
		, em.email as email
        
        <!-- 소속부서 -->
        , di1.div_nm as accNm
        , di1.rid    as acId
        
        <!-- 상위부서 -->
        , di2.div_nm as paraccNM
        , di2.rid    as paraccId
        
		, ${strColumn}
	from com.employee em with(nolock)
    left outer join com.crm_division di1 with(nolock) on di1.rid = em.RID_DIVISION
    left outer join com.crm_division di2 with(nolock) on di2.rid = di1.RID_PAR_DIV

    left outer join com.comm_code c2 with(nolock) on c2.group_code = 'MKT_EL_APPROVAL_REQUIRED' and c2.code_name = em.emp_no and c2.lang = #{lang} and c2.flag = 1
	join com.comm_code c1 with(nolock) on c1.flag = 1 and c1.code_name = em.work_status and c1.code_name = 'HOLDOFFICE' and c1.lang = #{lang} and c1.group_code = 'WORK_STATUS'
	where ${strSVCType}
	  and ${strWhere}
	  and c2.code_name is null	
     <if test="empId.size() != 0">
          and em.id not in 
          <foreach collection="empId" item="item" separator="," close=")" open="(">
        	   #{item}
       	  </foreach>
	 </if>
	ORDER BY ${strOrderby}
	${strEndPaging}
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(selectMember)
	============================================
	-	제목					: 전자 결제 기안자 및 깅나자 부서 조회
	-	설명					: 1. 기안자 및 기안자 부서 조회
	-	결과형태				: 단일
	============================================
	-	출력
        empNm               : 이름
        email      			: 이메일
        accNm       		: 부서명
        paraccNM            : 상위 부서명
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="selectMember" parameterType="com.icignal.onlineapproval.dto.request.ApprovalEmpReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalEmpResDto">
	/* OnlineApprovalMapper.selectMember */
	select 
	      em.id as id
		, em.name as empNm
		, ac1.name as accNm
		, ac1.id as acId
		, ac2.name as paraccNM
	from com.employee em with(nolock)
	join com.emp_acc_rel ear with(nolock) on ear.EMP_ID = em.id
	join com.account ac1 with(nolock) on ac1.id = ear.account_Id
	left outer join com.account ac2 with(nolock) on ac2.id = ac1.PAR_ACC_ID
	where ${strSVCType}
	and em.id = #{memId} OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY
	</select>
	
	
					
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(getApproverCount)
	============================================
	-	제목					: 결제 승인자 조회
	-	설명					: 결제 승인자 등록을 위한 결제 승인자 Count
	-	결과형태				: 단일
	============================================
	-	입력
		elApproveId			: 승인자 ID
	-	출력
		count(SEQ)			: 승인자 수 조회
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="getApproverCount" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.getApproverCount */
	SELECT 
		  count(t1.ID) 
	FROM com.com_elec_aprv_item t1 with(nolock)
	left outer join com.comm_code c1 with(nolock) on c1.flag = 1 and c1.code_name = t1.APVR_TYPE_CD and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD'
	where t1.flag = '1'
	and t1.ELEC_APRV_ID = #{aprvId}
	and c1.CODE_NAME != 10
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTTargetingDAO.java(getRefApproverCount)
	============================================
	-	제목					: 결제 참조자 조회
	-	설명					: 결제 참조자 등록을 위한 결제 참조자 Count
	-	결과형태				: 단일
	============================================
	-	입력
		elApproveId			: 승인자 ID
	-	출력
		count(SEQ)			: 참조자 수 조회
	============================================
	-	작성자					: 박지열
	-	작성일					: 2015.09.23
    ***************************************/ -->
	<select id="getRefApproverCount" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.getRefApproverCount */
	SELECT 
		  count(t1.ID) 
	FROM com.com_elec_aprv_item	 t1 with(nolock)
	left outer join com.comm_code c1 with(nolock) on c1.flag =1 and c1.code_name = t1.APVR_TYPE_CD and c1.lang = #{lang} and c1.group_code = 'EL_APPROVER_TYPE_CD'
	where t1.flag = '1'
	and t1.ELEC_APRV_ID = #{aprvId}
	and c1.CODE_NAME = 10
	</select>  
	
	
	<select id="selectReqApprovalMstInfo" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.CommonReqApprovalMstInfoResDto">
	/* OnlineApprovalMapper.selectReqApprovalMstInfo */
	 select elec_aprv_type  as elecAprvType ,
			elec_aprv_tbl_nm as elecAprvTblNm,
			rid_elec_req_tmpl as ridElecReqTmpl,
			rid_elec_aprv_tmpl as ridElecAprvTmpl,
			rid_elec_rjt_tmpl as ridElecRjtTmpl,
			elec_req_func_nm as elecReqFuncNm,
			elec_aprv_func_nm as elecAprvFuncNm,
			elec_rjt_func_nm as elecRjtFuncNm,			  
			( select case when id is null then 0 else 1 end   from com.employee with(nolock)where id = #{reqRid} ) as reqRidSuc,
			( select case when id is null then 0 else 1 end   from com.employee with(nolock) where id = #{fstRid} ) as fstRidSuc,
			( select case when id is null then 0 else 1 end   from com.employee with(nolock) where id = #{secRid} ) as secRidSuc,
			( select email   from com.employee with(nolock) where id = #{reqRid} ) as reqEmail,
			( select email   from com.employee with(nolock) where id = #{fstRid} ) as fstEmail,
			( select email   from com.employee with(nolock) where id = #{secRid} ) as secEmail,
			a.elec_req_automail_id     	as elecReqAutomailId,
			a.elec_aprv_automail_id     as elecAprvAutomailId,
			a.elec_rjt_automail_id     	as elecRjtAutomailId
	 	from com.com_elec_aprv_mst a with(nolock)
	 	where a.elec_aprv_type = #{aprvType}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
	 	  and a.flag =1
	 	
	 
	</select>
	
	<select id="selectEmpEmail" parameterType="java.lang.String" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectEmpEmail */
	 	select email  from com.employee with(nolock) where id = #{param}
	 	
	 
	</select>
	
	<select id="selectTableRecordExist" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto" resultType="java.lang.String">
	/* OnlineApprovalMapper.selectTableRecordExist */
	 select CASE when rid is not null then 'Y' ELSE 'N' END 
	 	from  ${elecAprvTblNm} with(nolock)
	 	where rid = #{recordRid}
	 	
	 
	</select>
	
	
	
	<insert id="insertApprovalHeader" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto">
	/* OnlineApprovalMapper.insertApprovalHeader */
		insert into com.com_elec_aprv(
				  id
				, create_by
				, modify_by
				, create_date
				, modify_date
				, flag
				<!-- , country -->
				<!-- , app_service_type -->
				<!-- , accnt_id -->
				, elec_aprv_no
				, elec_aprv_type_cd				
				, elec_aprv_title				
				, elec_aprv_status_cd
				, elec_aprv_rqtr_id
				, elec_aprv_rqtr_org_id
				, cam_id
				
				
		)values(
				  #{rid}   
		 	    , #{createBy}
				, #{createBy}
				, getdate()   
				, getdate()
				, '1'
				<!-- , #{country} -->
				<!-- , #{appServiceId} -->
				<!-- , #{accountId} -->     	 
				, lpad(loy.fn_get_seq_no('SEQ_APPR_NO'),10,'0')
				, #{aprvType}				
				, #{aprvTitle}			 	
				, '010'
				, #{reqRid}
				, (select rid_division from com.employee with(nolock) where id = #{reqRid})
				, #{recordRid}
				
			
				
		)
	</insert>
	<insert id="insertApprovalItem" parameterType="com.icignal.onlineapproval.dto.request.ApproverListReqDto">
	/* OnlineApprovalMapper.insertApprovalItem */
		insert into com.com_elec_aprv_item(
				  id
				, create_by
				, modify_by
				, create_date
				, modify_date
				, flag
				<!-- , country -->
				<!-- , app_service_type -->				
				, elec_aprv_id
				, apvr_id
				, elec_aprv_seq		
				, apvr_type_cd		
				, elec_aprv_status_cd 
				    
		)values(
				  com.getNewID('A')  
		 	    , #{createBy}
				, #{createBy}
				, getdate()   
				, getdate() 
				, '1'
				<!-- , #{country} -->
				<!-- , #{appServiceId} -->  				
				, #{apprRid}
				, #{id}
				, #{seq}	
				, #{apvrTypeCd}			
				, case when #{seq} = '1' then '013' else null end		
		)
	</insert>
	
	<insert id="insertApprovalItem2" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto">
	/* OnlineApprovalMapper.insertApprovalItem2 */
		insert into com.com_elec_aprv_item(
				  id
				, create_by
				, modify_by
				, create_date
				, modify_date
				, flag
				<!-- , country -->
				<!-- , app_service_type -->				
				, elec_aprv_id
				, apvr_id
				, elec_aprv_seq
				, apvr_type_cd
				, elec_aprv_status_cd 
				
		)values(
				  com.getNewID('A')  
		 	    , #{createBy}
				, #{createBy}
				, getdate()   
				, getdate()
				, '1'
				<!-- , #{country} -->
				<!-- , #{appServiceId} -->				
				, #{rid}
				, #{secRid}
				, '2'   
				, '9'  
				, null				
		)
	</insert>
	
	<select id="selectApprovalAdminList" parameterType="com.icignal.onlineapproval.dto.request.ApprovalAdminListReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalAdminListResDto">
	/* OnlineApprovalMapper.selectApprovalAdminList */
	SELECT 
			 a.rid					as id
		    ,a.elec_aprv_type            as elecAprvTypeCd
			,a.elec_aprv_tbl_nm     as elecAprvTblNm
			,h.conts_nm	            as ridElecReqTmpl
			,a.elec_req_func_nm     as elecReqFuncNm
			,i.conts_nm	            as ridElecAprvTmpl
			,a.elec_aprv_func_nm    as elecAprvFuncNm
			,j.conts_nm	            as ridElecRjtTmpl
			,a.elec_rjt_func_nm     as elecRjtFuncNm
			,a.elec_req_automail_id     	as elecReqAutomailId
			,a.elec_aprv_automail_id     	as elecAprvAutomailId
			,a.elec_rjt_automail_id     	as elecRjtAutomailId
			,a.create_date          as createDate
			,e.name		          	as createBy
			,a.modify_date          as modifyDate
			,g.name		            as modifyBy   
			,a.elec_aprv_type       as aprvType     
			,${strColumn}
		FROM com.com_elec_aprv_mst a with(nolock)
			left outer join com.crm_user c with(nolock) on a.create_by  = c.rid
			left outer join com.employee e with(nolock) on c.id_employee = e.id
			left outer join com.crm_user d with(nolock) on a.modify_by = d.rid
			left outer join com.employee g with(nolock) on d.id_employee = g.id
			left outer join mkt.mkt_conts_mst h with(nolock) on a.rid_elec_req_tmpl = h.id
			left outer join mkt.mkt_conts_mst i with(nolock) on a.rid_elec_aprv_tmpl = i.id
			left outer join mkt.mkt_conts_mst j with(nolock) on a.rid_elec_rjt_tmpl = j.id
			where ${strCondWhere}
			and a.flag = 1 			
			<!-- and a.accnt_id = #{accountId} -->
			and ${strSVCType}
			and ${strWhere}	
			ORDER BY ${strOrderby}		
			${strEndPaging}	
	
	</select>
	
	
	<select id="selectApprovalAdminDetail" parameterType="com.icignal.onlineapproval.dto.request.ApprovalAdminDetailReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApprovalAdminDetailResDto">
	/* OnlineApprovalMapper.selectApprovalAdminDetail */
	SELECT  
			 a.rid					 as id
		    ,a.elec_aprv_type        as elecAprvType
			,a.elec_aprv_tbl_nm      as elecAprvTblNm
			,a.rid_elec_req_tmpl     as ridElecReqTmpl
			,h.conts_nm				 as elecReqTmpl
			,a.elec_req_func_nm      as elecReqFuncNm
			,a.rid_elec_aprv_tmpl    as ridElecAprvTmpl
			,i.conts_nm				 as elecAprvTmpl
			,a.elec_aprv_func_nm     as elecAprvFuncNm
			,a.rid_elec_rjt_tmpl     as ridElecRjtTmpl
			,j.conts_nm				 as elecRjtTmpl
			,a.elec_rjt_func_nm      as elecRjtFuncNm
			,a.elec_req_automail_id  as elecReqAutomailId
			,a.elec_aprv_automail_id as elecAprvAutomailId
			,a.elec_rjt_automail_id  as elecRjtAutomailId
			,a.create_date           as createDate
			,e.name		          	 as createBy
			,a.modify_date           as modifyDate
			,g.name		             as modifyBy   

		FROM com.com_elec_aprv_mst a with(nolock)
			left outer join com.crm_user c with(nolock) on a.create_by  = c.rid
			left outer join com.employee e with(nolock) on c.id_employee = e.id
			left outer join com.crm_user d with(nolock) on a.modify_by = d.rid
			left outer join com.employee g with(nolock) on d.id_employee = g.id
			left outer join mkt.mkt_conts_mst h with(nolock) on a.rid_elec_req_tmpl = h.id
			left outer join mkt.mkt_conts_mst i with(nolock) on a.rid_elec_aprv_tmpl = i.id
			left outer join mkt.mkt_conts_mst j with(nolock) on a.rid_elec_rjt_tmpl = j.id
			where a.rid = #{id}
	        
	</select>
	
	<insert id="insertApprovalAdminDetail" parameterType="com.icignal.onlineapproval.dto.request.ApprovalAdminDetailReqDto" useGeneratedKeys="false">
	/*MKTElapproval.insertApprovalAdminDetail*/
	INSERT INTO  com.com_elec_aprv_mst(
	 rid,
	 elec_aprv_type, 
	 elec_aprv_tbl_nm,   
	 rid_elec_req_tmpl, 
	 elec_req_func_nm, 
	 rid_elec_aprv_tmpl,
	 elec_aprv_func_nm, 
	 rid_elec_rjt_tmpl, 
	 elec_rjt_func_nm, 
	 create_date, 
	 create_by, 
	 modify_date, 
	 modify_by,
	 flag,
	 <!-- COUNTRY, -->
	 <!-- CURRENCY, -->
	 <!-- APP_SERVICE_TYPE, -->
	 <!-- ACCNT_ID, -->
	 elec_req_automail_id,
	 elec_aprv_automail_id,
	 elec_rjt_automail_id
	 ) 
		VALUES(
	com.getNewID('A') ,	
	#{elecAprvType}, 
	#{elecAprvTblNm}, 
	#{ridElecReqTmpl}, 
	#{elecReqFuncNm}, 
	#{ridElecAprvTmpl}, 
	#{elecAprvFuncNm}, 
	#{ridElecRjtTmpl}, 
	#{elecRjtFuncNm}, 
	getdate(), 
	#{createBy}, 
	getdate(), 
	#{modifyBy},
	1,
 	<!-- #{country}, -->
 	<!-- 'KRW', -->   
 	<!-- #{appServiceId}, -->
 	<!-- #{accountId}, -->
 	#{elecReqAutomailId},
 	#{elecAprvAutomailId},
 	#{elecRjtAutomailId}
	)
	</insert>
	
	<update id="updateApprovalAdminDetail" parameterType="com.icignal.onlineapproval.dto.request.ApprovalAdminDetailReqDto">
	/* OnlineApprovalMapper.updateApprovalAdminDetail */
			UPDATE	 com.com_elec_aprv_mst
			SET		elec_aprv_type = #{elecAprvType},
					elec_aprv_tbl_nm = #{elecAprvTblNm},
					rid_elec_req_tmpl = #{ridElecReqTmpl},
					elec_req_func_nm = #{elecReqFuncNm},
					rid_elec_aprv_tmpl = #{ridElecAprvTmpl},
					elec_aprv_func_nm = #{elecAprvFuncNm},
					rid_elec_rjt_tmpl = #{ridElecRjtTmpl},
					elec_rjt_func_nm = #{elecRjtFuncNm},	
					elec_req_automail_id = #{elecReqAutomailId},	
					elec_aprv_automail_id = #{elecAprvAutomailId},	
					elec_rjt_automail_id = #{elecRjtAutomailId},	
					modify_date = getdate(),
					modify_by = #{modifyBy}
			WHERE	rid = #{id}
			
	</update>
	
	<update id="deleteApprovalAdminDetail" parameterType="com.icignal.onlineapproval.dto.request.ApprovalAdminDetailReqDto">
	/* OnlineApprovalMapper.deleteApprovalAdminDetail */
			UPDATE	 com.com_elec_aprv_mst
			SET		flag = flag + 1
			WHERE	rid = #{id}
			
	</update>
	
	<select id="selectMenualApproval" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto" 
	resultType="com.icignal.onlineapproval.dto.request.ManualDtlValidCheckReqDto"> 
	/* OnlineApprovalMapper.selectMenualApproval */
	     SELECT lvr.RQT_TYPE as dtlRqtType
           ,lvr.POINT_TYPE as dtlPointType
           ,lvr.RQT_POINT as dtlRqtPoint
           ,lvr.HNDOP_ACU_STBL_RSN as hndopAcuStblRsn
           ,lvr.HNDOP_ACU_STBL_DESC as hndopAcuStblDesc
           ,lm.MBR_NO as dtlMbrNo
           ,lct.CUST_NM as dtlCustNm
           ,lvr.MEM_DIV as dtlMemDiv
           ,lvr.MEM_GRADE as dtlMemGrade
           ,lc.CHNL_NO as dtlChnlNo
           ,lc.CHNL_NM as dtlChnlNm
           ,lvr.BIZR_NO as dtlBizrNo
           ,lvr.APV_RQT_INSTN as dtlApvRqtInstn
           ,lvr.TRT_STATUS as dtlTrtStatus
           ,lvr.CREATE_BY as dtlCreateBy
           ,lvr.DEAL_DT as dtlDealDt
           ,lvr.APV_NO as dtlApvNo
           ,lvr.RPY_MSG as dtlRpyMsg
           ,lvr.DEAL_TRCK_NO as dtlDealTrckNo
           ,lvr.APV_RPY as dtlApvRpy
           ,e2.name as dtlRidActc
           ,lvr.ACTC_RQT_DT as dtlActcRqtDt
           ,lvr.ACTC_TRT_DT as dtlActcTrtDt
           ,e1.name as dtlRidApv
           ,lvr.APV_RQT_DT as dtlApvRqtDt
           ,lvr.APV_RJT_DT as dtlApvRjtDt
           ,lvr.APV_RJT_RSN as dtlApvRjtRsn
           ,lvr.RID_CHNL as ridChnl
           ,lvr.RID_MBR as ridMbr
    	   ,lvr.RID_ACTC as ridActc
    	   ,lvr.RID_APV as ridApv
    	   ,lp.ENIS_SETL_METH as enisSetlMeth
    	   ,lvr.HNDOP_ACU_STBL_RSN as hndopAcuStblRsn
    	   ,lvr.rid as rid
    	   ,lvr.ACTC_RJT_RSN as dtlActcRjtRsn
    	   ,lvr.VAN_APV_DT as dtlVanApvDt
    	   ,lvr.STBL_AFTR_POINT_BLNC as dtlStblAftrPointBlnc
    	   ,lvr.APV_DT as dtlApvDt
        FROM loy.loy_voc_rqt lvr with(nolock)
        LEFT OUTER JOIN loy.loy_mbr lm with(nolock) on lm.rid = lvr.RID_MBR
        LEFT OUTER JOIN loy.loy_cust lct with(nolock) on lct.rid= lm.RID_CUST
        LEFT OUTER JOIN LOY.LOY_CHNL lc with(nolock) on lc.rid= lvr.RID_CHNL
        LEFT OUTER JOIN com.employee e1 with(nolock) on e1.id= lvr.RID_APV
  		LEFT OUTER JOIN com.employee e2 with(nolock) on e2.id = lvr.RID_ACTC
  		LEFT OUTER JOIN loy.loy_prod lp with(nolock) on lp.rid = lvr.RID_PROD
        left outer JOIN com.comm_code cc with(nolock) on cc.CODE_NAME = lvr.POINT_TYPE AND cc.lang=#{lang}  AND cc.GROUP_CODE='TXN_TYPE_CD_TM'
        LEFT OUTER JOIN com.comm_code cc1 with(nolock) on cc1.CODE_NAME = lvr.HNDOP_ACU_STBL_RSN AND cc1.lang=#{lang} and cc1.GROUP_CODE='TXN_REASON_ALL_TYPE'
        LEFT OUTER JOIN com.comm_code cc2 with(nolock) on cc2.CODE_NAME = lvr.MEM_DIV AND cc2.lang=#{lang}  AND cc2.GROUP_CODE='MEMBER_TYPE'
        LEFT OUTER JOIN com.comm_code cc with(nolock) on cc3.CODE_NAME = lvr.MEM_GRADE AND cc3.lang=#{lang} AND cc3.GROUP_CODE= 'MEMBER_GRADE'
        LEFT OUTER JOIN com.comm_code cc4 with(nolock) on cc4.CODE_NAME = lvr.APV_RQT_INSTN AND cc4.lang=#{lang} and cc4.GROUP_CODE= 'TXN_TERMINAL'
        LEFT OUTER JOIN com.comm_code cc5 with(nolock) on cc5.CODE_NAME = lvr.TRT_STATUS AND cc5.lang=#{lang} AND cc5.GROUP_CODE = 'TXN_STATUS_CD'
        LEFT OUTER JOIN com.comm_code cc6 with(nolock) on cc6.CODE_NAME = lvr.APV_RPY AND cc6.lang=#{lang} AND cc6.GROUP_CODE ='VAN_RETURN_CODE'
        LEFT OUTER JOIN com.comm_code cc7 with(nolock) on cc7.CODE_NAME = lvr.RQT_TYPE AND cc7.lang=#{lang} AND cc7.GROUP_CODE ='REQ_TYPE'
        WHERE lvr.rid= #{recordRid}
    </select>
	
	<select id="selectApproverDetail" parameterType="com.icignal.onlineapproval.dto.request.ApproverListReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.ApproverListResDto">
	/* OnlineApprovalMapper.selectApproverDetail */
		select case when id is null then 'N' else 'Y' end as valid   
			   ,id as rid
			   ,email as email
			   
		from com.employee with(nolock)
		where id = #{id}
	</select>
       <!-- 캠페인ID로 전자결제정보 조회 -->
    <select id="selectDetailAprvByCamId" parameterType="com.icignal.onlineapproval.dto.request.ApprovalDetailReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.ApprovalDetailResDto">
    /* OnlineApprovalMapper.selectDetailAprvByCamId */
        SELECT
              mea.id                    as id
            , mea.cam_id                as camId
            , mea.create_by             as createId
            , mea.elec_aprv_desc        as aprvDesc
            , mea.elec_aprv_sbst        as contetnt
            , mea.elec_aprv_rqtr_id     as elecAprvRqtrId
            , mea.elec_aprv_status_cd   as elecAprvStatusCd
            , c4.name                   as elecAprvRqtrNm
            , mea.elec_aprv_rqtr_org_id as elecAprvRqtrOrgId
            , ac2.name                  as elecAprvRqtrOrgNm
            , mea.elec_aprv_type_cd     as elecAprvTypeCd
            , convert(varchar,replace(convert(date,mea.create_date),1900-01-01,''),23)            as createDd
            , convert(varchar,replace(convert(date,mea.elec_aprv_cmplt_rqt_dd),1900-01-01,''),23)  as rqtDd
            , mcm.cam_nm   as camNm
            , mcm.cam_desc as camDesc
            , ac.name      as Dept
            , c1.name      as createBy
            , c2.code_name as status 
            , c3.file_name as fileName
        FROM com.com_elec_aprv           mea with(nolock)
        left outer join mkt.mkt_cam_mst  mcm with(nolock) on mcm.id = mea.cam_id
        left outer join com.crm_user     u1  with(nolock) on u1.rid = mea.create_by
        left outer join com.employee     c1 with(nolock)  on c1.id = u1.id_employee
        left outer join com.account      ac with(nolock) on ac.id = u1.accnt_id
        join com.comm_code               c2 with(nolock) on c2.flag = 1 and c2.code_name = mea.elec_aprv_status_cd and c2.lang = #{lang} and c2.group_code = 'EL_APPROVAL_STATUS_CD'
        left outer join com.com_file     c3 with(nolock) on c3.parent_id = mea.id
        left outer join com.employee     c4 with(nolock) on c4.id = mea.elec_aprv_rqtr_id
        left outer join com.account      ac2 with(nolock) on ac2.id = mea.elec_aprv_rqtr_org_id
        
        where mea.flag = '1'
          and mcm.id = #{id}
          
    </select>
	
	
	
	<select id="selectMailTemplate" parameterType="com.icignal.onlineapproval.dto.request.AprvTemplateReqDto" 
	resultType="com.icignal.onlineapproval.dto.response.AprvTemplateResDto">
        /* OnlineApprovalMapper.selectMailTemplate */
		select b.CONTS_TITLE as title, 
				b.conts_html as content
				<if test="apvStatus == 10">		
				, a1.elec_req_automail_id as automailID
				</if>
				<if test="apvStatus == 20">		
				, a1.elec_rjt_automail_id as automailID
				</if>
				<if test="apvStatus == 30">		
				, a1.elec_req_automail_id as automailID
				</if>
				<if test="apvStatus == 40">		
				, a1.elec_aprv_automail_id as automailID
				</if>
		from com.com_elec_aprv_mst a with(nolock)
		left outer join mkt.mkt_conts_mst b with(nolock) on
		<if test="apvStatus == 10">		
		a.rid_elec_req_tmpl
		</if> 
		<if test="apvStatus == 20">
		a.rid_elec_rjt_tmpl
		</if>
		<if test="apvStatus == 30">
		a.rid_elec_req_tmpl
		</if>
		<if test="apvStatus == 40">
		a.rid_elec_aprv_tmpl
		</if>
		= b.id and b.flag= 1
		left outer join com.com_elec_aprv_mst a1 with(nolock) on a.rid = a1.rid and a1.flag = 1
		where 1=1 
		and a.flag =1 
		and a.elec_aprv_type = #{apvType}
    </select>
	
    <!-- 결제정보 삭제 -->
	<update id="deleteElapproval" parameterType="com.icignal.onlineapproval.dto.request.ApprovalReqDto">
	/* OnlineApprovalMapper.deleteElapproval */
        update com.com_elec_aprv
        set 
              modify_by = #{modifyBy}
            , modify_date = getdate()
            , flag = flag + 1
        where id = #{id}
    </update>
     <select id="selectEmailTargetInfo" parameterType="com.icignal.onlineapproval.dto.request.ApprovalEmailTargetReqtDto"
resultType="com.icignal.onlineapproval.dto.response.ApprovalEmailTargetResDto">
	 /* OnlineApprovalMapper.selectEmailTargetInfo */
		select a.cam_id as recordRid  ,
			c.elec_aprv_tbl_nm as tableNm , 
	        a.elec_aprv_type_cd as aprvType , 
	        a.elec_aprv_rqtr_id as rqtrRid ,
	        b.apvr_id as apvrRid,
	        d.email as apvrEmail,
	        e.email as rqtrEmail,          
	        d.name  as apvrNm,          
	        e.name  as rqtrNm          
		from com.com_elec_aprv  a with(nolock)
		left outer join  com.com_elec_aprv_item b with(nolock) on b.elec_aprv_id = a.id
		left outer join  com.com_elec_aprv_mst c with(nolock) on a.elec_aprv_type_cd = c.elec_aprv_type
		left outer join  com.employee d with(nolock) on b.apvr_id = d.id
		left outer join  com.employee e with(nolock) on a.elec_aprv_rqtr_id = e.id
		where 1=1
		and a.flag = 1 
		and b.flag = 1
		and c.flag = 1
		and a.id = #{aprvRid}
		<if test="type == 10">
			and b.elec_aprv_status_cd = '013'
		</if>
		<if test="type == 20">
			and b.elec_aprv_status_cd = '021'
		</if>
		<if test="type == 30">
			and b.elec_aprv_status_cd = '013' 
		</if>
		<if test="type == 40">
			and b.elec_aprv_status_cd = '014' 
		</if>
		order by b.elec_aprv_seq desc
		OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY
		
		
	</select>
	
	 <select id="selectEmailInfo" parameterType="com.icignal.onlineapproval.dto.request.ApprovalEmailTargetReqtDto" 
	 resultType="com.icignal.onlineapproval.dto.response.ApprovalEmailInfoResDto">
	 /* OnlineApprovalMapper.selectEmailInfo */
		select  d.name as apvrNm,
      			e.name as rqtrNm,
		        <if test="type == 10">
		        '승인 요청' as type,
		        </if>
		        <if test="type == 20">
		        '승인 반려' as type,
		        </if>
		        <if test="type == 30">
		        '승인 요청' as type,
		        </if>
		        <if test="type == 40">
		        '최종 승인 완료' as type,
		        </if>
		        c.elec_aprv_type as elecAprvType,
		        b.reject_rsn as rejectRsn
		from com.com_elec_aprv  a with(nolock)
		left outer join  com.com_elec_aprv_item b with(nolock) on b.elec_aprv_id = a.id
		left outer join  com.com_elec_aprv_mst c with(nolock) on a.elec_aprv_type_cd = c.elec_aprv_type
		left outer join  com.employee d with(nolock) on b.apvr_id = d.id
		left outer join  com.employee e with(nolock) on a.elec_aprv_rqtr_id = e.id
		where 1=1
		and a.flag = 1 
		and b.flag = 1
		and c.flag = 1
		and a.id = #{aprvRid}
		<if test="type == 10">
			and b.elec_aprv_status_cd = '013'
		</if>
		<if test="type == 20">
			and b.elec_aprv_status_cd = '021'
		</if>
		<if test="type == 30">
			and b.elec_aprv_status_cd = '014' 
		</if>
		<if test="type == 40">
			and b.elec_aprv_status_cd = '014' 
		</if>
		order by elec_aprv_seq desc
		OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY
		
	</select>
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(editLastItemApproval)
	============================================
	-	제목					: 마지막 결재승인자 최종승인자로 변경
	-	설명					: 마지막 결재승인자 최종승인자로 변경
	-	결과형태				: 단일
	============================================
	-	입력
	============================================
	-	작성자				: hy.jun
	-	작성일				: 2018.03.03
    ***************************************/ -->
	<update id="editLastItemApproval" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
		/* OnlineApprovalMapper.editLastItemApproval */
		update 	com.com_elec_aprv_item
		set 	apvr_type_cd = '9'
				, modify_date = getdate()
				, modify_by = #{createBy}
		where 	elec_aprv_id = #{aprvId}
			and elec_aprv_seq = #{seq}
			and flag = 1
	</update>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(getRequiredItemApproval)
	============================================
	-	제목					: 필수 결재승인자 목록 조회
	-	설명					: 필수 결재승인자 목록 조회
	-	결과형태				: 복수
	============================================
	-	입력
	============================================
	-	작성자				: hy.jun
	-	작성일				: 2018.03.06
    ***************************************/ -->
	<select id="getRequiredItemApproval" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" 
	resultType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
		/* OnlineApprovalMapper.getRequiredItemApproval */
		select 	c1.seq as seq
				, emp.id as arvrId
				, emp.rid_division as orgId
		from 	com.comm_code c1 with(nolock)
		join 	com.employee emp with(nolock) on emp.emp_no = c1.code_name
								and emp.flag = 1
		where 	c1.group_code = 'MKT_EL_APPROVAL_REQUIRED'
			and c1.lang = #{lang}
			and c1.flag = 1
		order by c1.seq asc
	</select>
	
	<!-- /**************************************
	-	관련 파일				: MKTElapprovalDAO.java(getRequiredItemApproval)
	============================================
	-	제목					: 필수결재승인자 제외한 현재 등록된 결재승인자 목록 조회
	-	설명					: 필수결재승인자 제외한 현재 등록된 결재승인자 목록 조회
	-	결과형태				: 복수
	============================================
	-	입력
	============================================
	-	작성자				: hy.jun
	-	작성일				: 2018.03.06
    ***************************************/ -->
	<select id="getNoRequiredItemApproval" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto" 
	resultType="com.icignal.onlineapproval.dto.request.ApproverItemInsertReqDto">
		/* OnlineApprovalMapper.getNoRequiredItemApproval */
		select 	meai.elec_aprv_id as aprvId
				, meai.apvr_id as arvrId
				, meai.apvr_org_id as orgId
		from 	com.com_elec_aprv_item meai with(nolock)
		join 	com.employee emp with(nolock) on meai.elec_aprv_id = #{aprvId}
								and meai.flag = 1
								and emp.id = meai.apvr_id 
								and emp.flag = 1
		left outer join com.comm_code c1 with(nolock) on c1.group_code = 'MKT_EL_APPROVAL_REQUIRED'
										and c1.code_name = emp.emp_no 
										and c1.lang = #{lang}
										and c1.flag = 1
		where c1.id is null
		order by meai.elec_aprv_seq asc
	</select>
	<!--	관련 파일				: MKTElapprovalDAO.java(setApprovalItemSave)
	============================================
	-	제목					: 결재저장시 결재아이템 저장
	-	설명					: 결재저장시 결재아이템 저장 
	-	결과형태				: 단일
	============================================
	-	입력
	============================================
	-	작성자				: hy.jun
	-	작성일				: 2018.03.13
    ***************************************/ -->
	<insert id="setApprovalItemSave" parameterType="com.icignal.onlineapproval.dto.request.ApproverListReqDto">
		/* OnlineApprovalMapper.setApprovalItemSave */
		insert into com.com_elec_aprv_item (
			id
			, create_by
			, modify_by
			, create_date
			, modify_date
			, flag
			<!-- , country -->
			<!-- , app_service_type -->
			, elec_aprv_id
			, apvr_id
			, elec_aprv_seq
			, apvr_type_cd
			, elec_aprv_status_cd
		) values (
			com.getNewID('A')
			, #{createBy}
			, #{createBy}
			, getdate()
			, getdate()
			, '1'
			<!-- , #{country} -->
			<!-- , #{appServiceId} -->
			, #{apprRid}
			, #{id}
			, #{seq}	
			, #{apvrTypeCd}
			, null	
		)
		<!-- <selectKey keyProperty="" resultType="java.lang.String">
				select 1;
		</selectKey> -->
	</insert>
	
	<!-- 캠페인 정보 조회 By 전자결제 헤더 아이디 -->
	<select id="getCampaignInfoByElecAprvId" parameterType="com.icignal.onlineapproval.dto.response.ApprovalEmailInfoResDto" resultType="hashmap">
		/* OnlineApprovalMapper.getCampaignInfoByElecAprvId */
		select 	mcm.disp_no as "dispNo"
				, mcm.cam_nm as "camNm"
				, mcm.cam_desc as "camDesc"
				, c1.mark_name as "pntAccntBigTypeCdNm"
				, c2.mark_name as "pntAccntMidTypeCdNm"
				, c3.mark_name as "pntAccntSmlTypeCdNm"
				, c4.mark_name as "pntAccntDetailTypeCdNm"
				, mcm.pnt_accnt_cust_disp_txt as "pntAccntCustDispTxt"
				, convert(varchar,mcm.cam_start_dd, 20) as "camStartDd"
				, convert(varchar, mcm.cam_end_dd, 20) as "camEndDd"
		from 	com.com_elec_aprv mea with(nolock)
		join 	mkt.mkt_cam_mst mcm with(nolock) on mcm.id = mea.cam_id and mcm.flag = 1
		left outer join com.comm_code c1 with(nolock) on c1.group_code = 'PNT_TXN_TYPE' 				and c1.code_name = mcm.pnt_accnt_big_type_cd and c1.lang = 'ko' and c1.flag = 1
		left outer join com.comm_code c2 with(nolock) on c2.group_code = 'PNT_TXN_DTL_TYPE' 			and c2.code_name = mcm.pnt_accnt_mid_type_cd and c2.lang = 'ko' and c2.flag = 1
		left outer join com.comm_code c3 with(nolock) on c3.group_code = 'DA_PNT_ACCNT_SML_TYPE' 	and c3.code_name = mcm.pnt_accnt_sml_type_cd and c3.lang = 'ko' and c3.flag = 1
		left outer join com.comm_code c4 with(nolock) on c4.group_code = 'DA_PNT_ACCNT_DETAIL_TYPE' 	and c4.code_name = mcm.pnt_accnt_detail_type_cd and c4.lang = 'ko' and c4.flag = 1
		where 	mea.flag = 1
		and mea.id = #{aprvRid}
	</select>
	
	<update id="removeApprovalHeaderCampaign" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto">
		/* OnlineApprovalMapper.removeApprovalHeaderCampaign */
		update com.com_elec_aprv
		   set flag = flag + 1
		     , modify_by = #{modifyBy}
		     , modify_date = getdate()
		 where cam_id = #{recordRid}
		   and flag = 1
	</update>
	
	<update id="removeApprovalItemCampaign" parameterType="com.icignal.onlineapproval.dto.request.CommonApprovalReqDto">
		/* OnlineApprovalMapper.removeApprovalItemCampaign */
		update com.com_elec_aprv_item
		   set flag = flag + 1
		     , modify_by = #{modifyBy}
		     , modify_date = getdate()
		 where elec_aprv_id in (select id from com.com_elec_aprv where cam_id = #{recordRid})
		   and flag = 1
	</update>
	
	 <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getCampaignDefaultInfo)
    ============================================
    -   제목                    : 캠페인 기본정보
    -   설명                    : 캠페인 기본정보
    -   결과형태                : 단수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        camNm                   : 캠페인명
        camStartDd              : 시작일
        camEndDd                : 종료일
        camTypeCd               : 캠페인유형명
        camTypeNm               : 캠페인유형코드
        camDesc                 : 내용
        camScopeTypeCd          : 조직코드
        camScopeTypeNm          : 조직명
        promYn                  : 프로모션여부
        fatiExceptYn            : 피로도미적용여부
        ridIntactType           : 트리거이벤트유형RID
        intactType1Cd           :
        intactType1Nm           :
        intactType2Cd           :
        intactType2Nm           :
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectCampaignDefaultInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportCampaignResDto">
        /* OnlineApprovalMapper.selectCampaignDefaultInfo */
        select
              t1.cam_nm             as camNm
            , convert(varchar, t1.cam_start_dd, 23) as camStartDd         <!-- 시작일               -->
            , convert(varchar, t1.cam_end_dd, 23)   as camEndDd           <!-- 종료일               -->
            , t1.cam_type_cd        as camTypeCd          <!-- 캠페인유형명         -->
            , t1.cam_desc           as camDesc            <!-- 내용                 -->
            , t1.cam_scope_type_cd  as camScopeTypeCd     <!-- 조직코드             -->
            , t1.prom_yn            as promYn             <!-- 프로모션여부         -->
            , t1.fati_except_yn     as fatiExceptYn       <!-- 피로도미적용여부     -->
            , t1.rid_intact_type    as ridIntactType      <!-- 트리거이벤트유형RID  -->
            <!-- , t2.intact_type_1_cd   as intactType1Cd
            , t2.intact_type_2_cd   as intactType2Cd -->
            , t1.PRMS_EXCEPT_Yn		as prmsExceptYn		  <!--  퍼미션 적용 여부   -->
            , ce.NAME			    as camPlner			  <!--  등록자 -->
            , mea.ELEC_APRV_STATUS_CD			as oldAprStatCode		  <!--  결재 상태 -->
        from mkt.mkt_cam_mst t1 with(nolock)
        left outer join com.com_elec_aprv mea with(nolock) on mea.cam_id = t1.id and mea.flag = 1
        <!-- left outer join loy.MKT_INTACT_type t2 on t2.flag = 1 and t2.rid = t1.rid_intact_type -->
        left outer join COM.EMPLOYEE ce with(nolock) on ce.ID =  t1.CAM_PLNER
        where t1.id = #{campaingId}
    </select>

    <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getApprovalList)
    ============================================
    -   제목                    : 승인자 목록
    -   설명                    : 승인자 목록
    -   결과형태                : 복수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        elecAprvSeq             : 결제순번
        aprvId                  : 요청자ID
        aprvNm                  : 요청자명
        statusCd                : 결제상태
        statusNm                : 결제상태명
        aprvDd                  : 승인일자
        aprvYn                  : 승인자여부
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectApprovalList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportAprvResDto">
        /* OnlineApprovalMapper.selectApprovalList */
        select
              0                         as elecAprvSeq  <!-- 결제순번   -->
            , t2.elec_aprv_rqtr_id      as aprvId       <!-- 요청자ID   -->
            , u1.name                   as aprvNm       <!-- 요청자명   -->
            , ''                        as statusCd     <!-- 결제상태   -->
            , t2.create_date            as aprvDd       <!-- 승인일자   -->
            , 0                         as aprvYn       <!-- 승인자여부 -->
        from  com.com_elec_aprv t2
        left outer join com.employee u1 with(nolock) on u1.flag = 1 and u1.id = t2.elec_aprv_rqtr_id
        where t2.flag = 1
          and t2.cam_id = #{campaingId}
        union
        select
              t1.elec_aprv_seq          as elecAprvSeq  <!-- 결제순번   -->
            , t1.apvr_id                as aprvId       <!-- 승인자RID  -->
            , u1.name                   as aprvNm       <!-- 승인자 명  -->
            , t1.elec_aprv_status_cd    as statusCd     <!-- 결제상태   -->
            , t1.apv_dd                 as aprvDd       <!-- 승인일자   -->
            , 1                         as aprvYn       <!-- 승인자여부 -->
        from com.com_elec_aprv_item t1 with(nolock)
        left outer join com.com_elec_aprv t2 with(nolock) on t2.flag = 1 and t2.id = t1.elec_aprv_id
        left outer join com.employee      u1 with(nolock) on u1.flag = 1 and u1.id = t1.apvr_id
        where t1.flag = 1
          and t2.cam_id = #{campaingId}
        order by elecAprvSeq ASC
    </select>

    <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getOfferInfo)
    ============================================
    -   제목                    : 오퍼 정보
    -   설명                    : 오퍼 정보
    -   결과형태                : 단수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        offerNm                 : 오퍼명
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectOfferInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportOfferResDto">
        /* OnlineApprovalMapper.selectOfferInfo */
        select
              t1.offer_nm               as offerNm              <!-- 오퍼명           -->
            , t1.offer_desc             as offerDesc            <!-- 오퍼내용         -->
            , t1.offer_type_cd          as offerTypeCd          <!-- 오퍼유형코드     -->
            , t1.offer_sub_type_cd      as offerSubTypeCd       <!-- 오퍼유형상세코드 -->
            , t1.ref_key                as refKey               <!-- 참조값 rid       -->
            , t3.prod_nm                as prodNm               <!-- 참조값명         -->
            , t1.offer_use_desk_div_cd  as offerUseDeskDivCd    <!-- 사용처 코드      -->
            , t1.offer_ecnrs_div_cd     as offerEcnrsDivCd      <!-- 재원             -->
            , loed.divid_val			as divIdVal				<!-- 분담율          -->
            , loed.dividor				as dividName			<!-- 분담처 -->
            
            , lopd.valid_startdt_bas_cd  		 	as vsBasCode				<!-- 포인트 기준일자 유형 -->
            , lopd.valid_start_dtnum    as startDtnum			<!-- 혜택 시작일 -->
            , lopd.valid_end_dtnum      as vsDtnum				<!-- 소멸예정일 -->
            , convert(varchar,t1.aply_start_dd , 23) as aplyStartDd  <!-- 유효일자 시작일-->
            , convert(varchar,t1.aply_end_dd , 23)	as aplyEndDd	  <!-- 유효일자 종료일 -->	
            , t1.OFFER_APLY_DAY 		as offerAplyDay			<!-- 오퍼 적용기준일 -->
            , t1.SELF_TOT_AMT			as selfTotAmt			<!-- 지급 포인트 -->
            , lc.COUPN_USE_GDNC1		as offerNotiOne         <!-- 쿠폰유의사항 1 -->
            , lc.COUPN_USE_GDNC2		as offerNotiTwo         <!-- 쿠폰유의사항 2 -->
            , lc.COUPN_USE_GDNC3		as offerNotiThree       <!-- 쿠폰유의사항 3 -->
        from mkt.mkt_offer_mst        t1 with(nolock)
		left outer JOIN loy.LOY_OFFER_EXP_DIVID  loed with(nolock) ON loed.RID_MKT_OFFER_MST = t1.ID AND loed.FLAG = 1
		left outer join loy.loy_offer_pnt_dtl	 lopd with(nolock) on lopd.RID_MKT_OFFER_MST = t1.id and lopd.flag = 1
        join mkt.mkt_cam_offer_rel    t2 with(nolock) on t2.flag = 1 and t2.offer_id = t1.id
        left outer join loy.loy_prod  t3 with(nolock) on t3.flag = 1 and t3.rid = t1.ref_key
        left outer join loy.LOY_COUPN lc with(nolock) on lc.rid = t1.RID_COUPN AND lc.FLAG = 1
        where t1.flag = 1
          and t2.cam_id = #{campaingId}
    </select>


    <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getCoupnInfo)
    ============================================
    -   제목                    : 쿠폰 정보
    -   설명                    : 쿠폰 정보
    -   결과형태                : 단수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        coupnNm                 : 쿠폰명
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectCoupnInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportCoupnResDto">
        /* OnlineApprovalMapper.selectCoupnInfo */
        select
              t1.coupn_nm           as coupnNm
            , convert(varchar,t1.use_start_dt, 23) as useStartDt
            , convert(varchar,t1.use_end_dt, 23)   as useEndDt
            , t1.coupn_desc         as coupnDesc
            , t1.coupn_use_gdnc1    as coupnUseGdnc1
            , t1.coupn_use_gdnc2    as coupnUseGdnc2
            , t1.coupn_use_gdnc3    as coupnUseGdnc3
            , t1.coupn_use_gdnc4    as coupnUseGdnc4
            , t1.coupn_use_gdnc5    as coupnUseGdnc5
            , t1.coupn_use_gdnc6    as coupnUseGdnc6
            , t1.coupn_use_gdnc7    as coupnUseGdnc7
            , t1.coupn_use_gdnc8    as coupnUseGdnc8
            , t1.coupn_use_gdnc9    as coupnUseGdnc9
            , t1.coupn_use_gdnc10   as coupnUseGdnc10
        from loy.loy_coupn t1 with(nolock)
        where t1.flag = 1
          and t1.rid_mkt_cam_mst  = #{campaingId}
    </select>

    <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getTargetingInfo)
    ============================================
    -   제목                    : 타겟팅 정보
    -   설명                    : 타겟팅 정보
    -   결과형태                : 단수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        coupnNm                 : 쿠폰명
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectTargetingInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto"
     resultType="com.icignal.onlineapproval.dto.response.AprvReportTargetingResDto">
        /* OnlineApprovalMapper.selectTargetingInfo */

        select
              t1.cam_tgt_type_cd as camTgtTypeCd <!-- 타겟팅유형코드 -->
            , t1.cam_tgt_cnt     as camTgtCnt    <!-- 타겟팅건수     -->
            , t2.tgt_group_desc  as tgtGroupDesc <!-- 설명           -->
        from mkt.mkt_tgt_had t1 with(nolock)
        left outer join anl.anl_tgt_group t2 with(nolock) on t2.flag = 1 and t2.id = t1.tgt_group_id
        where t1.flag = 1
          and t1.cam_id = #{campaingId}

    </select>

    <!-- /**************************************
    -   관련 파일               : MKTElApprovalReportDAO.java(getPromInfo)
    ============================================
    -   제목                    : 프로모션 정보
    -   설명                    : 프로모션 정보
    -   결과형태                : 단수
    ============================================
    -   입력
        campaingId              : 캠페인 ID
        lang                    : 언어
    -   출력
        promStartDt             : 시작일
        promEndDt               : 종료일
        acrlType                : 보상유형코드
        acrlTypeNm              : 보상유형명
        acrlAmt                 : 금액(율)
        allianceTypeCd          : 제휴사코드
        allianceTypeNm          : 제휴사명
        monthLmtPoint           : 월한도포인트
        rulesetDesc             : 내용
        promTypeCd              : 프로모션 유형코드
        promTypeNm              : 프로모션 유형명
        promCyclTypeCd          : 반복주기
        promCyclStartDd         : 시작일
        promCyclEndDd           : 종료일
    ============================================
    -   작성자                  : jh.kim
    -   작성일                  : 2018.02.28
    ***************************************/ -->
    <select id="selectPromInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportPromInfoResDto">
        /* OnlineApprovalMapper.selectPromInfo */
        select
              convert(varchar,t1.prom_start_dt, 20) as promStartDt <!-- 시작일 -->
            , convert(varchar,t1.prom_end_dt, 20)   as promEndDt   <!-- 종료일 -->
           <!--  , t2.acrl_type          as acrlType   -->      <!-- 보상유형코드      -->
        <!--     , t2.acrl_amt           as acrlAmt     -->     <!-- 금액(율)          -->
            , t1.alliance_type_cd   as allianceTypeCd  <!-- 제휴사코드        -->
            , t1.month_lmt_point    as monthLmtPoint   <!-- 월한도포인트      -->
            , t1.ruleset_desc       as rulesetDesc     <!-- 내용              -->
            , t1.prom_type_cd       as promTypeCd      <!-- 프로모션 유형코드 -->
            , t1.prom_cycl_type_cd  as promCyclTypeCd  <!-- 반복주기          -->
            , t1.prom_cycl_start_dd as promCyclStartDd <!-- 시작일            -->
            , t1.prom_cycl_end_dd   as promCyclEndDd   <!-- 종료일            -->
        from loy.loy_ruleset t1 with(nolock)
        <!-- left outer join loy.loy_ruleset_prv_bnf t2 on t2.flag = 1 and t2.ruleset_id = t1.rid -->

        where t1.flag = 1
          and t1.rid_mkt_cam_mst = #{campaingId}
    </select>

    <!-- 실행정보조회 -->
    <select id="selectSchedulingInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportSchedulingResDto">
        /* OnlineApprovalMapper.selectSchedulingInfo */
        select
              convert(varchar,t1.exe_start_dd, 23) as exeStartDd       <!-- 실행 시작일자            -->
            , convert(varchar,t1.exe_end_dd, 23)   as exeEndDd         <!-- 실행 종료일자            -->
            , t1.exe_cycl_type_cd   as exeCyclTypeCd    <!-- 반복주기유형코드         -->
            , t1.exe_month_type_cd  as exeMonthTypeCd   <!-- 매월선택                 -->
            , t1.exe_sun_yn         as exeSunYn         <!-- 일요일 실행여부          -->
            , t1.exe_mon_yn         as exeMonYn         <!-- 월요일 실행여부          -->
            , t1.exe_tue_yn         as exeTueYn         <!-- 화요일 실행여부          -->
            , t1.exe_wed_yn         as exeWedYn         <!-- 수요일 실행여부          -->
            , t1.exe_thu_yn         as exeThuYn         <!-- 목요일 실행여부          -->
            , t1.exe_fri_yn         as exeFriYn         <!-- 금요일 실행여부          -->
            , t1.exe_sat_yn         as exeSatYn         <!-- 토요일 실행여부          -->
            , t1.exe_dd             as exeDd            <!-- 실행일자                 -->
            , t1.exe_day            as exeDay           <!-- 실행일                   -->
            , t1.exe_hour           as exeHour          <!-- 실행시간                 -->
            , t1.exe_mnut           as exeMnut          <!-- 실행분                   -->
            , t1.div_send_time      as divSendTtime     <!-- 분할전송시 기준시간      -->
            , t1.div_send_cnt       as divSendCnt       <!-- 분할전송시 1회 발송 건수 -->
            , t1.max_send_cnt       as maxSendCnt       <!-- 분할전송시 최대건수      -->
        from mkt.mkt_exe_info t1 with(nolock)
        where flag = 1
          and t1.cam_id = #{campaingId}
    </select>

    <!-- 실행 상세 목록 조회 -->
    <select id="selectSchedulingDtlList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
resultType="com.icignal.onlineapproval.dto.response.AprvReportSchedulingDtlResDto">
        /* OnlineApprovalMapper.selectSchedulingDtlList */
        select
              t1.exe_seq      						as exeSeq      <!-- 실행순차   -->
            , convert(varchar,t1.exe_dt, 20) as exeDt       <!-- 실행일시   -->
            , t1.exe_tgt_amt  						as exeTgtAmt   <!-- 실행대상수 -->
        from mkt.mkt_exe_info_item t1 with(nolock)
        where t1.flag = 1 
          and t1.cam_id = #{campaingId}
        order by t1.exe_seq asc
    </select>

    <!-- 컨텐츠 목록 조회 -->
    <select id="selectContsList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportContsResDto">
 		/* OnlineApprovalMapper.selectContsList */
		select 
			  t1.id 				as contsId
			, t1.exe_chnl_type_cd	as exeChnlTypeCd   	 <!-- 실행유형 -->
			, t1.conts_title        as contsTitle        <!-- 제목     -->
			, t1.conts_sbst         as contsSbst         <!-- 내용     -->
			, t1.conts_html         as contsHtml         <!-- html내용 -->
			, t1.conts_push_type_cd as contsPushTypeCd 	 <!-- 푸시유형 -->
			, t1.conts_bottom 		as contsBottom		 <!-- 수신거부번호 -->
			, t1.img_id				as imgId 			 <!-- 이미지ID -->
			, t1.sub_img_id			as subImgId 		 <!-- 이미지ID -->
			, (i1.image_folder + i1.image_file_name + i1.image_file_type) as imgSrc
			, (i2.image_folder + i2.image_file_name + i2.image_file_type) as subImgSrc
			, t1.attrib02 			as attrib02
			, t1.attrib03 			as attrib03
		from mkt.mkt_conts_mst t1  with(nolock)
		left outer join mkt.mkt_conts_chnl_rel t2 with(nolock) on t2.flag = 1 and t2.contents_id = t1.id
		left outer join com.image              i1 with(nolock) on i1.id = t1.img_id
		left outer join com.image              i2 with(nolock) on i2.id = t1.sub_img_id
		where t1.flag = 1 
		  and t2.cam_id = #{campaingId}
		order by t1.create_date desc 
    </select>
    
    <!-- 컨텐츠 정보 조회 -->
    <select id="selectContsInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportContsResDto">
 		/* OnlineApprovalMapper.selectContsInfo */
		select 
			  t1.id 				as contsId
			, t1.exe_chnl_type_cd	as exeChnlTypeCd   	 <!-- 실행유형 -->
			, t1.conts_title        as contsTitle        <!-- 제목     -->
			, t1.conts_sbst         as contsSbst         <!-- 내용     -->
			, t1.conts_html         as contsHtml         <!-- html내용 -->
			, t1.conts_push_type_cd as contsPushTypeCd 	 <!-- 푸시유형 -->
			, t1.conts_bottom 		as contsBottom		 <!-- 수신거부번호 -->
			, t1.img_id				as imgId 			 <!-- 이미지ID -->
			, t1.sub_img_id			as subImgId 		 <!-- 이미지ID -->
			, (i1.image_folder + i1.image_file_name + i1.image_file_type) as imgSrc
			, (i2.image_folder + i2.image_file_name + i2.image_file_type) as subImgSrc
			, t1.attrib02 			as attrib02
			, t1.attrib03 			as attrib03
		from mkt.mkt_conts_mst t1  with(nolock)
		left outer join mkt.mkt_conts_chnl_rel t2 with(nolock) on t2.flag = 1 and t2.contents_id = t1.id
		left outer join com.image              i1 with(nolock) on i1.flag = 1 and i1.id = t1.img_id
		left outer join com.image              i2 with(nolock) on i2.flag = 1 and i2.id = t1.sub_img_id
		where t1.flag = 1 
		  and t2.id = #{contsId}
		order by t1.create_date desc 
    </select>
    
    <!-- 시작노드 목록 조회 -->
    <select id="selectStartNodeList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportNodeResDto">
    	/* OnlineApprovalMapper.selectStartNodeList */
		select 
		  	   t1.id			as id
		     , t3.node_type_cd 	as nodeTypeCd
		     , t1.act_task_id 	as actTaskId
		     , t2.id 			as taskNodeId
		from mkt.mkt_cam_wf_rel t1 with(nolock)
		join com.wf_task_node 	t2 with(nolock) on t2.flag = 1 and t2.id = t1.task_nm
		join com.wf_node_mst 	t3 with(nolock) on t3.flag = 1 and t3.id = t2.node_id
		join com.wf_task_cnctr 	t4 with(nolock) on t4.flag = 1 and t2.id = t4.target_node
		join com.wf_task_node 	t5 with(nolock) on t5.flag = 1 and t5.id = t4.source_node
		join com.wf_node_mst 	t6 with(nolock) on t6.flag = 1 and t6.id = t5.node_id
		where 1 = 1
		  and t1.flag = 1
		  and t1.cam_id = #{campaingId}
		  and (t3.node_type_cd in ('ETCOND', 'ETACT')
		       or t3.node_type_cd in (select code_name from com.comm_code with(nolock) where flag = 1 and lang = #{lang} and group_code='MKT_CAM_CHNL_TYPE_CD')
		      )
		  and t6.node_type_cd not in ('ETCOND', 'ETACT')
		  and t6.node_type_cd not in (select code_name from com.comm_code with(nolock) where flag = 1 and lang = #{lang} and group_code='MKT_CAM_CHNL_TYPE_CD')
		order by t2.off_set_x
    
    </select>
    
    <!-- 하위노드 목록조회 -->
    <select id="selectChildNodeList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportNodeResDto">
    	/* OnlineApprovalMapper.selectChildNodeList */
	    select 
	    	  @pv:=target_node  as sNode
		    , t1.id 			as id
		    , t3.node_type_cd	as nodeTypeCd
		    , t1.act_task_id 	as actTaskId
		from mkt.mkt_cam_wf_rel t1 with(nolock)
		join com.wf_task_node t2 with(nolock) on t2.flag = 1 and t2.id = t1.task_nm
		join com.wf_node_mst t3 with(nolock) on t3.flag = 1 and t3.id = t2.node_id
		join com.wf_task_cnctr t4 with(nolock) on t4.flag = 1 and t4.target_node = t2.id
		join (select @pv:= #{taskNodeId}) tmp
		where t4.source_node = @pv
    
    </select>
    
    <!-- 룰정보 조회 -->
    <select id="selectRuleInfo" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto" 
    resultType="com.icignal.onlineapproval.dto.response.AprvReportRuleResDto">
    	/* OnlineApprovalMapper.selectRuleInfo */
		select 
		     t1.title           as title
		   , t1.type       		as typeCd
		   , t3.input_scrn      as subInputScrn
		   , t1.desctxt         as desctxt
		from loy.et_cam_node t1 with(nolock)
 		left outer join loy.et_cam_act_val   t2 with(nolock) on t2.flag = 1 and t1.rid = t2.rid_cam_node
		left outer join loy.et_node_sub_type t3 with(nolock) on t3.flag = 1 and t3.rid = t1.rid_node_sub_type
		left outer join com.comm_code c2 with(nolock) on c2.flag = 1 and c2.lang = #{lang} and c2.group_code ='MKT_CAM_NODE_TYPE' and c2.code_name = t3.sub_type_cd
		where t1.flag = 1
		  and t1.rid = #{actTaskId}
	</select>
	
	<!-- 연관 캠페인 목록 -->
	<select id="selectRelCampaignList" parameterType="com.icignal.onlineapproval.dto.request.AprvReportReqDto"
	 resultType="com.icignal.onlineapproval.dto.response.AprvReportCampaignResDto">
		/* OnlineApprovalMapper.selectRelCampaignList */
		select
			  t1.cam_nm 			as camNm
			, convert(varchar,t1.cam_start_dd, 23)	as camStartDd
			, convert(varchar,t1.cam_end_dd, 23)	as camEndDd
			, ( select string_agg( c1.mark_name,' ' ) WITHIN GROUP(ORDER by c1.MARK_NAME)
				from mkt.mkt_conts_mst a1   with(nolock)
				left outer join mkt.mkt_conts_chnl_rel a2 with(nolock) on a2.flag = 1 and a2.contents_id = a1.id
				left outer join com.comm_code c1 with(nolock) on c1.flag = 1 and c1.lang = #{lang} and c1.group_code = 'MKT_CAM_CHNL_TYPE_CD' and c1.code_name = a1.exe_chnl_type_cd
				where a1.flag = 1      
				  and a2.cam_id = t1.id 
			  ) as targetChnl
		from mkt.mkt_cam_mst t1 with(nolock)
		where t1.flag = 1
		  and PAR_CAM_ID is not null 
		  and PAR_CAM_ID != ''
		  and PAR_CAM_ID = (select PAR_CAM_ID from mkt.mkt_cam_mst with(nolock) where flag = 1 and id = #{campaingId})
	</select>
	
	<insert id="insertTierApproval" parameterType="com.icignal.loyalty.membership.dto.request.LoyTierApprovalReqDto">
	/* OnlineApprovalMapper.insertTierApproval */
	insert into com.com_elec_aprv(
			  id
			, create_by
			, modify_by
			, create_date
			, modify_date
			, flag
			, elec_aprv_no
			, elec_aprv_type_cd
			, elec_aprv_div_cd
			, cam_id
			, elec_aprv_title
			, elec_aprv_sbst
			, elec_aprv_status_cd
			, elec_aprv_rqtr_id
			, elec_aprv_rqtr_org_id
			, last_apv_dd
			, last_apvr_id
			, elec_aprv_desc
			, ATRIB_1
			, ATRIB_2
			, ATRIB_3
			, ATRIB_4
			, ATRIB_5
			, ATRIB_6
			, ATRIB_7
			, ATRIB_8
			, ATRIB_9
	)values(
			  #{rid}   
	 	    , #{createBy}
			, #{modifyBy}
			, getdate()   
			, getdate()
			, '1' 	 
			, #{elecAprvNo}         
			, '06'
			, '1'   
			, ''            
			, '등급변경'   
			, #{tierReason}
			, '010'   
			, #{reqEmpId}     
			, #{reqEmpDivId}  
			, ''         
			, ''      
			, '등급 수동 변경'
			, #{tierHistRid}
			, #{mbrRid}
			, #{tierGrpRid}
			, #{tierRid}
			, #{tierMnlReasonDesc}
			, #{upKeepMm}
			, #{mbrTierCol}
			, #{tierRstCd}
			, #{tierMnlReasonCd}
	)
	</insert>
	
	<insert id="insertTierApprovalItem" parameterType="com.icignal.loyalty.membership.dto.request.LoyTierApprovalReqDto">
	/* OnlineApprovalMapper.insertTierApprovalItem */
	insert into com.com_elec_aprv_item(
	 		  id
			, create_by
			, modify_by
			, create_date
			, modify_date
			, flag
			, ELEC_APRV_ID
			, ELEC_APRV_SEQ
			, APVR_ID
			, APVR_ORG_ID
			, APV_DD
			, APVR_TYPE_CD
			, ELEC_APRV_STATUS_CD)
	values(
	 	      #{rid}  
		 	, #{createBy}
			, #{modifyBy}
			, getdate()   
			, getdate()
			, '1'
			, #{aprvoRid}
			, '1'
			, #{empId}
			, #{modifyOrgID}
			, ''
			, '2'   
			, '013'
	)    	    
	</insert>
	
	<select id="selectModfiyTier" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemRejectReqDto" 
    resultType="com.icignal.loyalty.membership.dto.request.LoyMbrTiersDetailReqDto">
    	/* OnlineApprovalMapper.selectModfiyTier */
		select cea.ATRIB_2 AS mbrRid
		     , cea.ATRIB_3 AS tierGrpRid
		     , cea.ATRIB_4 AS tierRid
		     , cea.ATRIB_5 AS tierMnlReasonDesc
		     , cea.ATRIB_6 AS upKeepMm
		     , cea.ATRIB_7 AS mbrTierCol
		     , cea.ATRIB_8 AS tierRstCd 
		     , cea.ATRIB_9 AS tierMnlReasonCd 
		from COM.COM_ELEC_APRV cea with(nolock)
		where cea.flag = 1
		  and cea.id = #{id}
	</select>
	
	<update id="updateApprovalStatCd" parameterType="com.icignal.onlineapproval.dto.request.ApproverItemRejectReqDto">
	/* OnlineApprovalMapper.updateApprovalStatCd */
	UPDATE com.com_elec_aprv SET
			  modify_by = #{memId}
			, modify_date = getdate()
			, ELEC_APRV_STATUS_CD = '090'
			, ELEC_APRV_CMPLT_RQT_DD = getdate()
			, LAST_APV_DD			 = getdate()
			, LAST_APVR_ID           = #{apvrId}
	where id = #{id} 
	</update>
	
	<update id="updateApprovalAttr" parameterType="com.icignal.loyalty.membership.dto.request.LoyMbrTiersDetailReqDto">
	/* OnlineApprovalMapper.updateApprovalAttr */
	UPDATE com.com_elec_aprv SET
			  modify_by = #{modifyBy}
			, modify_date = getdate()
			, ATRIB_10     = #{rid}
	where id = #{approValId} 
	</update>
	
</mapper>