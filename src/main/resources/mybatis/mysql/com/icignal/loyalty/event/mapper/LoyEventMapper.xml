<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icignal.loyalty.event.mapper.LoyEventMapper">

	<select id="selectEventPlanExcutionList" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventPlanExcutionResDto">
	/* LoyEventMapper.selectEventPlanExcutionList */
	SELECT ${strColumn}
		  ,t1.rid AS rid 
		  ,t1.EVT_NO  AS evtNo
		  ,t2.MARK_NAME AS evtType
		  <!-- ,t3.MARK_NAME AS evtCategory -->
		  ,t1.EVT_NM AS evtNm
		  ,t1.EVT_CAT_CD as evtCatcd
		  ,t4.MARK_NAME AS evtStatus
		  ,t1.evt_status_cd AS evtStatusCd 
		  ,to_char(t1.APPLY_START_DT ,'YYYY-MM-DD') AS evtStartDt
		  ,to_char(t1.APPLY_END_DT , 'YYYY-MM-DD') AS evtEndDt
		  <!-- ,(SELECT COUNT(DISTINCT(a1.RID_MBR)) FROM loy.LOY_EVT_APPLCT a1 WHERE a1.RID_EVT = t1.RID and a1.flag = 1) AS evtApplMbrCnt -->
		  ,(SELECT count(DISTINCT lea.rid)  FROM loy.LOY_EVT_APPLCT lea  WHERE lea.FLAG = 1   AND lea.rid_evt = t1.RID) AS evtApplCnt
		  ,(SELECT count(DISTINCT lew.rid)  FROM loy.LOY_EVT_WINNER lew  WHERE lew.FLAG = 1   AND lew.rid_evt = t1.RID) AS evtWinnerCnt
<!-- 		  ,(SELECT COUNT(DISTINCT(a1.RID_MBR)) FROM loy.LOY_EVT_APPLCT a1 WHERE a1.RID_EVT = t1.RID and a1.flag = 1) AS evtApplCnt -->
<!-- 		  ,(SELECT count(DISTINCT lea.rid) -->
<!-- 			FROM loy.LOY_EVT_APPLCT lea -->
<!-- 			JOIN loy.LOY_MBR lm ON lea.RID_MBR = lm.RID AND lm.FLAG = 1 -->
<!-- 			WHERE lea.FLAG = 1 -->
<!-- 			AND lea.rid_evt = t1.RID) AS evtApplTicketCnt -->
	  	  , EVT_SEQ as evtSeq
	  	  , t1.WIN_CMPLT_YN as winCmpltYn
		  , TO_CHAR(t1.WIN_CMPLT_DT, 'YYYY-MM-DD HH24:MI') as winCmpltDt
		  , t1.TIER_LIMIT_YN AS tierLimitYn
		  , NVL2(t1.MAIN_IMG, 'Y', 'N') AS mainImageYn
		  , TO_CHAR(T1.CREATE_DATE,'YYYY-MM-DD HH24:MI:SS') AS createDate
		  , TO_CHAR(T1.MODIFY_DATE,'YYYY-MM-DD HH24:MI:SS') AS modifyDate
	 FROM loy.LOY_EVT_MST t1  
	 LEFT OUTER JOIN com.COMM_CODE t2 ON t1.EVT_TYPE_CD = t2.CODE_NAME AND t2.GROUP_CODE = 'EVT_TYPE_CD' AND t2.flag = 1 and t2.lang = #{lang}
	 <!-- LEFT OUTER JOIN com.COMM_CODE t3 ON t1.EVT_CAT_CD  = t3.CODE_NAME AND t3.GROUP_CODE = 'EVT_CATEGORY_CD' and t3.flag= 1 and t3.lang = #{lang} -->
	 LEFT OUTER JOIN com.comm_code t4 on t1.evt_status_cd = t4.code_name and t4.group_code = 'EVT_STATUS_CD' and t4.flag=1 and t4.lang = #{lang}
	WHERE ${strCondWhere}
	  and ${strWhere}
	  and t1.flag = 1
	  <if test="eventType != null and eventType != ''">
      and t1.EVT_TYPE_CD=#{eventType}
      </if>
 order by ${strOrderby}
		  ${strEndPaging}
	</select>
	
	<select id="getPromotionPopUpList" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventPlanExcutionResDto">
	/* LoyEventMapper.getPromotionPopUpList */
	SELECT${strColumn},
		 t1.ID AS id ,
	     t1.DISP_NO AS dispNo,
	     t1.CAM_NM  AS camNm,
	     TO_CHAR(t1.CAM_START_DD,'YYYY-MM-DD') AS startDd,
	     TO_CHAR(t1.CAM_END_DD,'YYYY-MM-DD')   AS endDd,
	     t2.MARK_NAME AS accntSmlType,
	     t3.MARK_NAME AS accntDetailType,
	     t6.MARK_NAME AS offerType,
	   	 t7.MARK_NAME AS promType,
    	 t8.MARK_NAME AS promSubType,
    	 t5.self_tot_amt as selfTotAmt
	FROM mkt.MKT_CAM_MST t1
	LEFT OUTER JOIN com.COMM_CODE t2 	ON t2.FLAG = 1 AND t2.LANG = #{lang} AND t2.GROUP_CODE = 'DA_PNT_ACCNT_SML_TYPE' 	AND t1.PNT_ACCNT_SML_TYPE_CD = t2.CODE_NAME
	LEFT OUTER JOIN com.COMM_CODE t3 	ON t3.FLAG = 1 AND t3.LANG = #{lang} AND t3.GROUP_CODE = 'DA_PNT_ACCNT_DETAIL_TYPE' AND t1.PNT_ACCNT_DETAIL_TYPE_CD = t3.CODE_NAME
	JOIN mkt.MKT_CAM_OFFER_REL t4 		ON t4.cam_id = t1.ID AND t4.FLAG = 1
	JOIN mkt.MKT_OFFER_MST t5 			ON t4.OFFER_ID = t5.ID AND t5.FLAG = 1
	LEFT OUTER JOIN com.COMM_CODE t6 	ON t6.FLAG = 1 AND t6.LANG = #{lang} AND t6.GROUP_CODE = 'OFFER_TYPE_CD' 		AND t6.CODE_NAME = t5.OFFER_TYPE_CD
	LEFT OUTER JOIN com.comm_code t7 	ON t7.FLAG = 1 AND t7.LANG = #{lang} AND t7.GROUP_CODE = 'LOY_PROM_TYPE' 		AND t7.CODE_NAME = t1.PROM_TYPE 
	LEFT OUTER JOIN com.comm_code t8 	ON t8.FLAG = 1 AND t8.LANG = #{lang} AND t8.GROUP_CODE = 'LOY_PROM_SUB_TYPE' 	AND t8.CODE_NAME = t1.prom_sub_type 
   WHERE t1.cam_type_cd = #{camTypeCd}  
     AND t1.CAM_STATUS_CD = 'A'
     AND t1.CAM_START_DD <![CDATA[<=]]> SYSDATE
     AND t1.CAM_END_DD <![CDATA[>=]]> SYSDATE
	 AND t1.FLAG = 1
	 AND ${strWhere}
	 <if test="@com.icignal.common.util.StringUtil@isNotEmpty(smlTypeCd)">
	 AND t1.PNT_ACCNT_SML_TYPE_CD = #{smlTypeCd}
	 </if>
order by ${strOrderby}
     	 ${strEndPaging}
	</select>
	
	<insert id="insertSaveEventPlane" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.insertSaveEventPlane */
	INSERT
	INTO LOY.LOY_EVT_MST (
		RID,
		CREATE_BY,
		MODIFY_BY,
		CREATE_DATE,
		MODIFY_DATE,
		FLAG,
		EVT_NO,
		EVT_NM,
		EVT_TYPE_CD,
		EVT_CAT_CD,
		APPLY_START_DT,
		APPLY_END_DT,
		<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventDate)">
		EVT_DT,
		</if>
		<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventWiningDate)">
		WIN_DT,
		</if>
		EVT_PLACE,
		THUMBNAIL_IMG,
		MAIN_IMG,
		DETAIL_IMG1,
		DETAIL_IMG2,
		DETAIL_IMG3,
		DOWN_FILE,
		DOWN_URL,
		NOTE_TXT,
		ONE_APPLY_TICKET,
		RID_MKT_CAM_MST,
		EVT_STATUS_CD,
		DOWN_FILE_NM,
		EVT_SEQ,
		WIN_CMPLT_YN,
		WIN_CMPLT_DT,
		ADDR_REG_YN,
		DAY_LIMIT_CNT,
		DEVICE_REG_YN,
		TIER_LIMIT_YN,
		USE_PNT_AMT,
		RID_USE_OFR,
		USE_OFR_AMT,
		EVT_WIN_TYPE_CD,
		WIN_MBR_CNT,
		WIN_RATE,
		MAX_APPLY_CNT,
		TOT_LIMIT_CNT,
		BNFT_OFR_AMT,
		EFF_STRT_DAY_CNT,
		RID_BNFT_OFR
		)
	VALUES(
		#{rid},
		#{createBy},
		#{modifyBy},
		SYSDATE,
		SYSDATE,
		1,
		(select loy.fn_get_event_no from dual),
		#{eventNm},
		#{eventType},
		#{eventCategory},
		TO_DATE(#{voteStartDate}, 'YYYY-MM-DD'),
		TO_DATE(#{voteEndDate}, 'YYYY-MM-DD'),
		<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventDate)">
		TO_DATE(#{eventDate} || #{eventTime},'YYYY-MM-DD HH24:MI'),
		</if>
		<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventWiningDate)">
		TO_DATE(#{eventWiningDate}, 'YYYY-MM-DD'),
		</if>
		#{eventPlace},
		#{thumImg},
		#{mainImg},
		#{detailImg1},
		#{detailImg2},
		#{detailImg3},
		#{downFile}, 
		#{downURL},
		#{noteText},
		#{oneEventVoteTicketCnt},
		#{promotionRid},
		'W',
		#{downFileNm},
		#{eventSeq},
		'N',
		NULL,
		#{addrRegYn},
		#{oneMaxCnt},
		#{devRegYn},
		#{tierLimitYn},
		#{usePntAmt},
		#{ofrUseRid},
		#{useOfrAmt},
		#{evtWinTypeCd},
		#{winMbrCnt},
		#{winRate},
		#{maxApplyCnt},
		#{totLimitCnt},
		#{bnftOfrAmt},
		#{effStrtDayCnt},
		#{bnftOfrRid}
		)
	</insert>
	
	<select id="selectEventPlanDetail" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventPlanExcutionDetailResDto">
	/* LoyEventMapper.selectEventPlanDetail */
	SELECT  
		t1.EVT_NO AS evtNo ,
		t1.EVT_NM AS evtNm ,
		t1.EVT_TYPE_CD AS evtTypeCd,
		t1.EVT_CAT_CD AS evtCatCd,
		to_char(t1.APPLY_START_DT,'YYYY-MM-DD')AS applyStartDt,
		to_char(t1.apply_end_dt,'YYYY-MM-DD') as applyEndDt,
		t1.EVT_DT AS evtDt,
		t1.EVT_PLACE AS evtPlace,
		to_char(t1.WIN_DT,'YYYY-MM-DD')AS winDt,
		t1.THUMBNAIL_IMG AS thumbNailImg,
		t1.MAIN_IMG	AS mainImg,
		t1.DETAIL_IMG1 AS detailImg1,
		t1.DETAIL_IMG2 AS detailImg2,
		t1.DETAIL_IMG3 AS detailImg3,
		t1.DOWN_FILE AS downFile,
		t1.DOWN_URL AS downUrl,
		t1.ONE_APPLY_TICKET AS oneApplyTicket,
		t1.MAX_APPLY_CNT AS maxApplyCnt,
		t1.NOTE_TXT AS noteText,
		t1.DOWN_FILE_NM as fileNm,
		t1.EVT_SEQ	as evtSeq,
		t1.EVT_STATUS_CD as evtStatusCd,
		t1.WIN_CMPLT_YN as winCmpltYn,
		TO_CHAR(t1.WIN_CMPLT_DT, 'YYYY-MM-DD HH24:MI') as winCmpltDt,
		t1.ADDR_REG_YN as addrRegYn,
		t1.RID_MKT_CAM_MST as promotionRid,
		t1.DAY_LIMIT_CNT AS oneMaxApplyCnt,
		t1.TOT_LIMIT_CNT AS totLimitCnt,
		t1.DEVICE_REG_YN as devRegYn,
		t1.TIER_LIMIT_YN as tierLimitYn,
		t1.USE_PNT_AMT   as usePntAmt,
		t1.RID_USE_OFR   as ofrUseRid,
		t1.USE_OFR_AMT   as useOfrAmt,
		t1.EVT_WIN_TYPE_Cd  as evtWinTypeCd,
		t1.WIN_MBR_CNT		AS winMbrCnt,
		t1.WIN_RATE 		AS winRate,
		t1.MAX_APPLY_CNT    AS maxApplyCnt,
		t1.EFF_STRT_DAY_CNT AS effStrtDayCnt,
		t1.BNFT_OFR_AMT		AS bnftOfrAmt,
		lo.OFR_NM			AS ticketOfrNm,
		lo2.OFR_NM			AS bnftOfrNm,
		t1.RID_BNFT_OFR	AS bnftOfrRid
	FROM loy.LOY_EVT_MST t1
	LEFT OUTER JOIN LOY.LOY_OFR lo ON t1.RID_USE_OFR = lo.RID AND lo.FLAG = 1
	LEFT OUTER JOIN LOY.LOY_OFR lo2 ON t1.RID_BNFT_OFR = lo2.RID AND lo2.FLAG = 1
	 WHERE t1.RID = #{rid}
	</select>
	
	<update id="updateEventPlane" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.updateEventPlane */
	UPDATE loy.LOY_EVT_MST
	    SET MODIFY_BY 		= #{modifyBy},
	    	MODIFY_DATE 	= sysdate,
	     	EVT_NM 			= #{eventNm},
	    	EVT_TYPE_CD 	= #{eventType},
	    	EVT_CAT_CD 		= #{eventCategory},
	    	APPLY_START_DT  = TO_DATE(#{voteStartDate}, 'YYYY-MM-DD'),
	    	APPLY_END_DT    = TO_DATE(#{voteEndDate}, 'YYYY-MM-DD'),
	    	<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventDate)">
	    	EVT_DT          = TO_DATE(#{eventDate} || #{eventTime},'YYYY-MM-DD HH24:MI'),
	    	</if>
	    	<if test="@com.icignal.common.util.StringUtil@isEmpty(eventDate)">
	    	EVT_DT          = NULL,
	    	</if>
	    	EVT_PLACE       = #{eventPlace},
	    	<if test="@com.icignal.common.util.StringUtil@isNotEmpty(eventWiningDate)">
	    	WIN_DT          = TO_DATE(#{eventWiningDate}, 'YYYY-MM-DD'),
	    	</if>
	    	<if test="@com.icignal.common.util.StringUtil@isEmpty(eventWiningDate)">
	    	WIN_DT          = NULL,
	    	</if>
	    	THUMBNAIL_IMG   = #{thumImg},
	    	MAIN_IMG        = #{mainImg},
	    	DETAIL_IMG1     = #{detailImg1},
	    	DETAIL_IMG2     = #{detailImg2},
	    	DETAIL_IMG3     = #{detailImg3},
	    	DOWN_FILE       = #{downFile},
	    	DOWN_URL        = #{downURL},
	    	NOTE_TXT        = #{noteText},
	    	ONE_APPLY_TICKET = #{oneEventVoteTicketCnt},
	    	RID_MKT_CAM_MST  = #{promotionRid},
	    	DOWN_FILE_NM	 = #{downFileNm},
	    	EVT_SEQ			 = #{eventSeq},
	    	ADDR_REG_YN      = #{addrRegYn},
            DAY_LIMIT_CNT    = #{oneMaxCnt},
            DEVICE_REG_YN    = #{devRegYn},
            TIER_LIMIT_YN    = #{tierLimitYn},
            MAX_APPLY_CNT   = #{maxApplyCnt},
            USE_PNT_AMT      = #{usePntAmt},
			RID_USE_OFR		 = #{ofrUseRid},
			USE_OFR_AMT      = #{useOfrAmt},
			EVT_WIN_TYPE_Cd  = #{evtWinTypeCd},
			WIN_MBR_CNT      = #{winMbrCnt},
			WIN_RATE         = #{winRate},
			BNFT_OFR_AMT	 = #{bnftOfrAmt},
			EFF_STRT_DAY_CNT = #{effStrtDayCnt},
			RID_BNFT_OFR	 = #{bnftOfrRid},
			TOT_LIMIT_CNT    = #{totLimitCnt}
  	WHERE flag = 1 
	AND RID = #{rid}
	</update>
	
	<!-- 이벤트 당첨 완료 -->
	<update id="updateEventWinCmplt" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
		/* LoyEventMapper.updateEventWinCmplt */
		UPDATE loy.LOY_EVT_MST
		   SET MODIFY_BY    	= #{modifyBy}
		 	   , MODIFY_DATE 	= SYSDATE
		 	   , WIN_CMPLT_YN	= 'Y'
		 	   , WIN_CMPLT_DT	= SYSDATE
		 where rid = #{rid}    
	</update>
	
	<update id="deleteEventPlan"  parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deleteEventPlan */
	UPDATE loy.loy_evt_mst
	   SET MODIFY_BY    = #{modifyBy},
	 	       MODIFY_DATE 	= sysdate,
	 	       flag = flag + 1
	 where rid = #{rid}    
	</update>
	
	<update id="deleteEvtApplct" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deleteEvtApplct */
	UPDATE loy.loy_evt_applct
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   flag = flag + 1
	 WHERE rid_evt = #{rid}
	</update>
	
	<update id="deleteEvtProdEntry" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deleteEvtProdEntry */
	UPDATE loy.LOY_EVT_MST
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   flag = flag + 1
	 WHERE rid = #{rid}
	</update>
	
	<update id="deleteEvtWinner" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deleteEvtWinner */
	UPDATE loy.loy_evt_winner
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   flag = flag + 1
	 WHERE rid_evt = #{rid}
	</update>
	
	<update id="updateStartEventPlan" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.updateStartEventPlan */
	UPDATE loy.LOY_EVT_MST
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   EVT_STATUS_CD = 'A'
	 WHERE rid = #{rid}
	</update>
	
	<update id="updateFinishEventPlan" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.updateFinishEventPlan */
	UPDATE loy.LOY_EVT_MST
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   EVT_STATUS_CD = 'E'
	 WHERE rid = #{rid}
	</update>
	
	<update id="updateStopEventPlan" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.updateStopEventPlan */
	UPDATE loy.LOY_EVT_MST
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   EVT_STATUS_CD = 'S'
	 WHERE rid = #{rid}
	</update>
	
	<select id="validEventPlan" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventPlanExcutionDetailResDto">
	/* LoyEventMapper.validEventPlan */
	select evt_status_cd as evtStatusCd
	  from loy.loy_evt_mst 
	where rid = #{rid}
	</select>
	
	<select id="evtApplctList" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto" fetchSize="5000">
		/* LoyEventMapper.evtApplctList */
		SELECT  	 ${strColumn}
					,rid           		 AS rid     
					,mbr_No        		 AS mbrNo
					,rid_Mbr       		 AS ridMbr   
					,cust_Nm       		 AS custNm  
					,sbsc_type_Cd		 AS sbscTypeCd
					,hhp_No        		 AS hhpNo   
					,mbr_Status    		 AS mbrStatus
		            ,applct_Dt           AS applctDt         
		            ,applct_Ticket_Cnt   AS applctTicketCnt   
		            ,sns_Id              AS snsId            
		            ,applct_Url          AS applctUrl        
		            ,rid_Evt_Winner      AS ridEvtWinner     
		            ,win_Yn              AS winYn         
		            ,win_Dt              AS winDt 
	          		,bnf_Yn    		     AS bnfYn
	      		    ,bnf_Dt        		 AS bnfDt       
		            ,age                 AS age           
		            ,gender              AS gender        
		            ,upload_Path         AS uploadPath    
		            , ${strColumn}
		FROM (
				SELECT     
					       t1.RID	 			AS rid
				    	 , t3.MBR_NO 			AS mbr_No
				    	 , t1.RID_MBR 			AS rid_Mbr
				    	 , t4.CUST_NM			AS cust_Nm
				    	 , t3.SBSC_TYPE_CD		AS sbsc_type_cd
				    	 <!-- , t3.WEB_ID -->
				    	 , t4.HHP				AS hhp_No
				    	 , cc1.MARK_NAME 		AS mbr_Status
				    	 , TO_CHAR(t1.APPLCT_DT,'YYYY-MM-DD HH24:MI')
				    	 						AS applct_Dt
				    	 , t1.APPLCT_TICKET_CNT AS applct_Ticket_Cnt
				    	 , t1.SNS_ID			AS sns_Id
				    	 , t1.APPLCT_URL 		AS applct_Url
				    	 , t5.RID 				AS rid_Evt_Winner
				    	 , (CASE WHEN t5.RID IS NOT NULL THEN 'Y' ELSE 'N' END) 
				    	 						AS win_Yn
				    	 , TO_CHAR(t5.WIN_DT, 'YYYY-MM-DD HH24:MI')
				    	 						AS win_Dt
				    	 , t5.BNF_YN 			AS bnf_Yn
				    	 , TO_CHAR(t5.BNF_DT, 'YYYY-MM-DD HH24:MI') 
				    	 						AS bnf_Dt
				    	 , TO_CHAR(SYSDATE, 'YYYY') - SUBSTR(TO_CHAR(t4.BIRTH_DATE,'YYYY-MM-DD'), 1, 4) + 1   
				    	 						AS age
				    	 , t6.MARK_NAME 		AS gender
				    	 , t1.MBR_UPLOAD_PATH 	AS upload_Path
				    	 <!-- , t3.ECOMM_MBR_NO AS ecommMbrNo -->
			    FROM loy.LOY_EVT_APPLCT t1
			   	JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
			    JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
			    JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
			    <if test="eventType != &quot;UGC&quot;">
				LEFT OUTER JOIN loy.LOY_EVT_WINNER t5 ON t5.FLAG = 1 AND t5.RID_EVT = t2.RID AND t5.RID_MBR = t1.RID_MBR AND t1.RID = t5.RID_EVT_APPLCT
			    </if>
			    <if test="eventType == &quot;UGC&quot;">
				JOIN LOY.LOY_EVT_WINNER t5 ON t5.FLAG = 1 AND t5.RID_EVT = t2.RID AND t5.RID_MBR = t1.RID_MBR AND t1.RID = t5.RID_EVT_APPLCT    
			    </if>
			    LEFT OUTER JOIN com.COMM_CODE cc1 ON  cc1.CODE_NAME = t3.MBR_STAT_CD AND cc1.GROUP_CODE = 'LOY_MBR_STAT_CD' AND cc1.FLAG = 1 AND cc1.LANG = #{lang}
			    LEFT OUTER JOIN com.COMM_CODE t6 ON t6.CODE_NAME = t4.GEN_CD AND t6.GROUP_CODE = 'LOY_GEN_CD' AND t6.FLAG = 1 AND t6.LANG = #{lang}
			    WHERE t1.FLAG = 1
				  AND t1.rid_evt = #{rid}
		)
		WHERE 1=1
		AND ${strCondWhere}
		AND ${strWhere}
		ORDER BY ${strOrderby}
		${strEndPaging}
	</select>
	
	<!-- 해당 이벤트의 '당첨완료'여부를 체크 -->
	<select id="selectEventWinCompleteYn" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" 
			resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto">
		/* LoyEventMapper.selectEventWinCompleteYn */
		SELECT lem.WIN_CMPLT_YN 	 AS winCmpltYn
		FROM LOY_EVT_MST lem
		WHERE 1=1
			AND lem.RID = #{eventRid}
			AND lem.FLAG = 1
	</select>
	
	<!-- 특정 이벤트의 현재 참여자들 중에서, 당첨된 회원이 있는지 여부를 체크 -->
	<select id="isThereWinnerInApplicant" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" 
			resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto">
		/* LoyEventMapper.isThereWinnerInApplicant */
		SELECT 	lew.RID			AS rid        
               ,lew.RID_MBR     AS ridMbr
		       ,lew.MBR_NO     	AS mbrNo
		       ,lew.WIN_DT		AS winDt
		FROM loy.LOY_EVT_WINNER lew 
		WHERE 1=1
		AND lew.FLAG = 1
		AND lew.RID_EVT = #{eventRid}
		AND lew.MBR_NO IN (
							SELECT lea.MBR_NO
							FROM loy.LOY_EVT_APPLCT lea 
							WHERE 1=1
							AND lea.FLAG = 1
							AND lea.RID_EVT = #{eventRid}
							)
	</select>
	
	<!-- [이벤트>응모/참여형>당첨자 탭] 당첨자 목록 조회 -->
	<select id="prodEntryList" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventProdEntryResDto" fetchSize="5000">
		/* LoyEventMapper.prodEntryList */
		SELECT   rid           		 AS rid     
				,rid_Mbr       		 AS ridMbr  
				,mbr_No        		 AS mbrNo   
				,cust_Nm       		 AS custNm  
				,sbsc_type_cd		 AS sbscTypeCd
				,hhp_No        		 AS hhpNo   
				,age           		 AS age      
				,mbr_Status    		 AS mbrStatus
				,bnf_Yn        		 AS bnfYn    
				,bnf_Type_Cd   	 	 AS bnfTypeCd
				,bnf_Dt         	 AS bnfDt       
				,bnf_Type_Dtl     	 AS bnfTypeDtl  
				,create_Date     	 AS createDate  
				,create_By      	 AS createBy    
				,upload_Path   		 AS uploadPath  
				,${strColumn}
		FROM (
			SELECT    t1.RID 				AS rid
					, t1.RID_MBR 			AS rid_Mbr
					, t1.MBR_NO				AS mbr_No
					, t4.CUST_NM			AS cust_Nm
					, t3.SBSC_TYPE_CD		AS sbsc_type_cd
					<!-- , t3.WEB_ID -->
					, t4.HHP				AS hhp_No
					, TO_CHAR(SYSDATE, 'YYYY') - SUBSTR(TO_CHAR(t4.BIRTH_DATE,'YYYY-MM-DD'), 1, 4) + 1 
											AS age
					, t5.MARK_NAME 			AS mbr_Status
					, CASE WHEN t1.BNF_YN = 'Y' THEN '지급' WHEN t1.BNF_YN = 'N' THEN '미지급'
							ELSE (CASE WHEN t1.BNF_CANCEL_DT IS NULL THEN '' ELSE '지급 취소' END)
							END 			AS bnf_Yn
					, t6.MARK_NAME 			AS bnf_Type_Cd
					, TO_CHAR(t1.BNF_DT,'YYYY-MM-DD HH24:MI') 	
											AS bnf_Dt 
					, CASE WHEN T1.WIN_TYPE_CD = '02' THEN '추가적립' 
							ELSE '기본적립' 
							END		 		AS bnf_Type_Dtl
					, TO_CHAR(t1.CREATE_DATE,'YYYY-MM-DD HH24:MI')
											AS create_Date
					, t8.NAME 				AS create_By
					, CASE WHEN T1.WIN_TYPE_CD = '02' THEN '' 
							ELSE t9.MBR_UPLOAD_PATH 
							END 			AS upload_Path
					, ${strColumn}
			FROM loy.LOY_EVT_WINNER t1
			 JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
			 JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
			 JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
			 LEFT OUTER JOIN loy.LOY_EVT_APPLCT t9 ON t1.RID_EVT_APPLCT = t9.RID AND t9.FLAG = 1
			 LEFT OUTER JOIN com.COMM_CODE t5 ON	t5.CODE_NAME = t3.MBR_STAT_CD AND t5.GROUP_CODE = 'LOY_MBR_STAT_CD'	AND t5.FLAG = 1	AND t5.lang = #{lang}
			 LEFT OUTER JOIN com.COMM_CODE t6 ON	t6.CODE_NAME = t1.BNF_TYPE_CD AND t6.GROUP_CODE = 'BNFT_TYPE_CD'	AND t6.FLAG = 1	AND t6.lang = #{lang}
			 LEFT OUTER JOIN com.CRM_USER t7 ON t7.RID = t1.CREATE_BY
			 LEFT OUTER JOIN com.EMPLOYEE t8 ON t8.ID = t7.ID_EMPLOYEE
			WHERE t1.FLAG = 1
			  AND t1.rid_evt = #{rid}
		)
		WHERE 1=1
		AND ${strCondWhere}
		AND ${strWhere}
		ORDER BY ${strOrderby}
		${strEndPaging}
	</select>
	
	<insert id="insertTransferWinner" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.insertTransferWinner */
	INSERT 
	INTO loy.loy_evt_winner(
		rid
		,CREATE_BY
		,MODIFY_BY
		,CREATE_DATE
		,MODIFY_DATE
		,FLAG
		<!-- ,COUNTRY
		,APP_SERVICE_TYPE
		,ACCNT_ID -->
		,RID_EVT
		,RID_MBR
		,MBR_NO
		,WIN_DT
		,BNF_YN
		,RID_EVT_APPLCT
	)
	SELECT com.getNewId('') 
		,#{createBy} 
		,#{modifyBy}
		,SYSDATE
		,SYSDATE
		,1
		<!-- ,#{country}
		,#{appServiceId}
		,#{accountId} -->
		,t1.RID_EVT
		,t1.RID_MBR
		,t1.MBR_NO
		,SYSDATE
		,'N'
		,RID
	 FROM loy.LOY_EVT_APPLCT t1
	WHERE t1.RID = #{rid}
	</insert>
	
	<select id="validWinnerTransfer" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="java.lang.Integer" >
	/* LoyEventMapper.validWinnerTransfer */
	SELECT COUNT(1)
	  FROM loy.LOY_EVT_WINNER  
	 WHERE RID_EVT = #{rid} 
	   AND MBR_NO = #{mbrNo}
	   AND flag = 1 
	</select>
	
	<parameterMap id="cancelVoteMap" type="map"> 
		<parameter property="eventNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rid" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="modifyBy" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rst" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstCd" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstmsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
 	</parameterMap>
	<update id="cancelVote" parameterMap="cancelVoteMap" statementType="CALLABLE">
	/* LoyEventMapper.cancelVote */
	{
		CALL  LOY.PKG_LOY_BO_EVENT.PROC_EVENT_APPLY_CANCEL(?, ?, ?, ?, ?, ?) 
	}
	</update>
	
	<insert id="insertEvtWinner" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.insertEvtWinner */
	INSERT 
	INTO loy.loy_evt_winner(
		rid
		,CREATE_BY
		,MODIFY_BY
		,CREATE_DATE
		,MODIFY_DATE
		,FLAG
		<!-- ,COUNTRY
		,APP_SERVICE_TYPE
		,ACCNT_ID -->
		,RID_EVT
		,RID_MBR
		,MBR_NO
		,WIN_DT
		,BNF_YN
	)VALUES(
	   com.getNewId('') 
		,#{createBy} 
		,#{modifyBy}
		,SYSDATE
		,SYSDATE
		,1
		<!-- ,#{country}
		,#{appServiceId}
		,#{accountId} -->
		,#{rid}
		,#{ridMbr}
		,#{mbrNo}
		,SYSDATE
		,'N'
	)
	</insert>
	
	<insert id="insertEvtApplict" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.insertEvtApplict */
	INSERT 
	INTO loy.LOY_EVT_APPLCT(
		rid
		,CREATE_BY
		,MODIFY_BY
		,CREATE_DATE
		,MODIFY_DATE
		,FLAG
		,RID_EVT
		,RID_MBR
		,MBR_NO
		,APPLCT_DT
		,APPLCT_TICKET_CNT
	)VALUES(
	   com.getNewId('') 
		,#{createBy} 
		,#{modifyBy}
		,SYSDATE
		,SYSDATE
		,1
		,#{rid}
		,#{ridMbr}
		,#{mbrNo}
		,SYSDATE
		,1
	)
	</insert>
	
	<update id="deleteEventWinner"  parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.deleteEventWinner */
	UPDATE loy.LOY_EVT_WINNER
	   SET flag = flag + 1 ,
	   	   MODIFY_BY = #{modifyBy},
	   	   MODIFY_DATE = SYSDATE
	 WHERE RID = #{rid}
	</update>
	
	<update id="eventWinnerReset"  parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.eventWinnerReset */
	UPDATE loy.LOY_EVT_WINNER
	   SET flag = flag + 1 ,
	   	   MODIFY_BY = #{modifyBy},
	   	   MODIFY_DATE = SYSDATE
	 WHERE 1=1
	 	AND RID_EVT = #{rid}
	 	AND FLAG = 1
	   /*AND BNF_YN = 'N'*/
	</update>
	
	<update id="eventApplicantReset"  parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto">
	/* LoyEventMapper.eventApplicantReset */
	UPDATE loy.LOY_EVT_APPLCT
		SET  flag = flag + 1
			,MODIFY_BY = #{modifyBy}
		   	,MODIFY_DATE = SYSDATE
	WHERE 1=1
		AND RID_EVT = #{eventRid} 
		AND FLAG = 1
	</update>
	
	
	<parameterMap id="cancelWinnertMap" type="map">
		<parameter property="eventNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rid" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="modifyBy" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rst" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstCd" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstmsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
 	</parameterMap>
 	<!-- 당첨 취소 -->
	<update id="cancelWinner" parameterMap="cancelWinnertMap" statementType="CALLABLE">
	/* LoyEventMapper.cancelWinner */
	{
		CALL  LOY.PKG_LOY_BO_EVENT.PROC_EVENT_WIN_CANCEL(?, ?, ?, ?, ?, ?) 
	}
	</update>
	
	<parameterMap id="benefitPaymentMap" type="map">
		<parameter property="eventNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rid" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="pType" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="modifyBy" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rst" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstCd" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstmsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
 	</parameterMap>
	<update id="benefitPayment" parameterMap="benefitPaymentMap" statementType="CALLABLE">
	/* LoyEventMapper.benefitPayment */
	{
		CALL LOY.PKG_LOY_BO_EVENT.PROC_EVENT_BNF(?, ?, ?, ?, ?, ?, ?) 
	}
	</update>
	
	<parameterMap id="cancleBenefitPaymentMap" type="map">
		<parameter property="eventNo" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rid" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="modifyBy" jdbcType="VARCHAR" javaType="java.lang.String" mode="IN"/>
		<parameter property="rst" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstCd" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
		<parameter property="rstmsg" jdbcType="VARCHAR" javaType="java.lang.String" mode="OUT"/>
 	</parameterMap>
 	<!-- 혜택 지급 취소 -->
	<update id="cancleBenefitPayment" parameterMap="cancleBenefitPaymentMap" statementType="CALLABLE">
	/* LoyEventMapper.cancelBenefitPayment */
	{
		CALL  LOY.PKG_LOY_BO_EVENT.PROC_EVENT_BNF_CANCEL(?, ?, ?, ?, ?, ?) 
	}
	</update>
	
	<select id="selectOverlapCnt" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="java.lang.Integer" >
	/* LoyEventMapper.selectOverlapCnt */
	SELECT COUNT(1) as validCnt
	  FROM loy.LOY_EVT_WINNER  
	 WHERE RID_EVT = #{eventRid} 
	   AND MBR_NO = #{mbrNo}
	   AND flag = 1 
	</select>
	
	<select id="selectMbrInfo" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto" >
	/* LoyEventMapper.selectMbrInfo */
	  SELECT RID AS ridMbr 
	    FROM loy.LOY_MBR  
	   WHERE FLAG = 1 
   	     AND MBR_NO = #{mbrNo}
	</select>
	
	<update id="updateSendSuccess" parameterType="com.icignal.loyalty.event.dto.request.LoyProdEntryReqDto">
	UPDATE loy.LOY_EVT_PROD_ENTRY
   	   SET MODIFY_BY = #{modifyBy}
   	    ,  MODIFY_DATE = SYSDATE
   	    ,  SEND_YN = 'Y'
   	    ,  SEND_DT = SYSDATE
     WHERE FLAG = 1 
       AND RID = #{rid}
       AND SEND_YN = 'N'
	</update>
	
	<update id="updateSendCancel" parameterType="com.icignal.loyalty.event.dto.request.LoyProdEntryReqDto">
	UPDATE loy.LOY_EVT_PROD_ENTRY
   	   SET MODIFY_BY = #{modifyBy}
   	    ,  MODIFY_DATE = SYSDATE
   	    ,  SEND_YN = 'N'
   	    ,  SEND_DT = NULL
     WHERE FLAG = 1 
       AND RID = #{rid}
       AND SEND_YN = 'Y'
	</update>
	
	<select id="selectOverLapProdEntry" parameterType="com.icignal.loyalty.event.dto.request.LoyProdEntryReqDto" resultType="java.lang.Integer">
	SELECT COUNT(1) as validCnt
	  FROM LOY.LOY_EVT_PROD_ENTRY
	 WHERE RID_EVT = #{eventRid} 
	   AND rid_mbr = #{ridMbr}  
	   AND flag = 1 
	   AND SEND_YN = 'Y'
	</select>
	
	<select id="getMbrInfo" parameterType="com.icignal.loyalty.event.dto.request.LoyProdEntryReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyProdEntryResDto">
	SELECT rid as ridMbr
	  FROM loy.loy_mbr
	 WHERE MBR_NO = #{mbrNo} 
	   AND FLAG = 1
	</select>
	
	<select id="evtAppliClearMask" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto">
	/* LoyEventMapper.evtAppliClearMask */ 
	SELECT t1.RID	 as rid
    	 , t3.MBR_NO as mbrNo
    	 , t4.CUST_NM as unMaskCustNm 
    	 , t4.HHP AS unMaskHhp
    FROM loy.LOY_EVT_APPLCT t1
   	JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
    JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
    JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
    LEFT OUTER JOIN com.COMM_CODE t5 ON  t5.CODE_NAME = t3.MBR_STAT_CD AND t5.GROUP_CODE = 'LOY_MBR_STAT_CD' AND t5.FLAG = 1 AND t5.LANG = #{lang}
    WHERE t1.FLAG = 1
	  AND t1.rid = #{rid}
	</select>
	
	<select id="getWinnerExcelDownList" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventProdEnrtyExcelResDto" fetchSize="5000">
	/* LoyEventMapper.getWinnerExcelDownList */
	SELECT  t1.RID 		AS rid
		, t1.RID_MBR 	AS ridMbr
		, t1.MBR_NO		AS mbrNo
		<!-- , t4.CUST_NM	AS custNm -->
		, t3.SBSC_TYPE_CD AS sbscTypeCd
		<!-- , t3.WEB_ID -->
		<!-- , t4.HHP		AS hhpNo -->
		, TO_CHAR(SYSDATE, 'YYYY') - SUBSTR(TO_CHAR(t4.BIRTH_DATE,'YYYY-MM-DD'), 1, 4) + 1 
											AS age
		, t5.MARK_NAME 	AS mbrStatus
		, CASE WHEN t1.BNF_YN = 'Y' THEN '지급' WHEN t1.BNF_YN = 'N' THEN '미지급'
				ELSE (CASE WHEN t1.BNF_CANCEL_DT IS NULL THEN '' ELSE '지급 취소' END)  END AS bnfYn
		, t6.MARK_NAME 	AS bnfTypeCd
		, TO_CHAR(t1.BNF_DT,'YYYY-MM-DD HH24:MI') 	AS bnfDt 
		, CASE WHEN T1.WIN_TYPE_CD = '02' THEN '추가적립' 
				ELSE '기본적립' END 		AS bnfTypeDtl
		, TO_CHAR(t1.CREATE_DATE,'YYYY-MM-DD HH24:MI') AS createDate
		, t8.NAME AS createBy
		, CASE WHEN T1.WIN_TYPE_CD = '02' THEN '' 
				ELSE t9.MBR_UPLOAD_PATH END AS uploadPath
		, ${strColumn}
	 FROM loy.LOY_EVT_WINNER t1
	 JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
	 JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
	 JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
	 LEFT OUTER JOIN loy.LOY_EVT_APPLCT t9 ON t1.RID_EVT_APPLCT = t9.RID AND t9.FLAG = 1
	 LEFT OUTER JOIN com.COMM_CODE t5 ON	t5.CODE_NAME = t3.MBR_STAT_CD AND t5.GROUP_CODE = 'LOY_MBR_STAT_CD'	AND t5.FLAG = 1	AND t5.lang = #{lang}
	 LEFT OUTER JOIN com.COMM_CODE t6 ON	t6.CODE_NAME = t1.BNF_TYPE_CD AND t6.GROUP_CODE = 'BNFT_TYPE_CD'	AND t6.FLAG = 1	AND t6.lang = #{lang}
	 LEFT OUTER JOIN com.CRM_USER t7 ON t7.RID = t1.CREATE_BY
	 LEFT OUTER JOIN com.EMPLOYEE t8 ON t8.ID = t7.ID_EMPLOYEE
	WHERE t1.FLAG = 1
	  AND t1.rid_evt = #{rid}
	  and ${strCondWhere}
	  and ${strWhere}
 order by ${strOrderby}
		  ${strEndPaging}
	</select>
	
	<select id="evtWinnerClearMask" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtWinnerResDto" >
	/* LoyEventMapper.evtWinnerClearMask */
	SELECT t1.RID 		AS rid
		, t4.CUST_NM	AS unMaskCustNm
		, t4.HHP		AS unMaskHhp 
	 FROM loy.LOY_EVT_WINNER t1
	 JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
	 JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
	 JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
	 LEFT OUTER JOIN com.COMM_CODE t5 ON	t5.CODE_NAME = t3.MBR_STAT_CD AND t5.GROUP_CODE = 'LOY_MEM_STAT_CD'	AND t5.FLAG = 1	AND t5.lang = #{lang}
	 LEFT OUTER JOIN com.COMM_CODE t6 ON	t6.CODE_NAME = t1.BNF_TYPE_CD AND t6.GROUP_CODE = 'BNFT_TYPE_CD'	AND t6.FLAG = 1	AND t6.lang = #{lang}
	 LEFT OUTER JOIN com.CRM_USER t7 ON t7.RID = t1.CREATE_BY
	 LEFT OUTER JOIN com.EMPLOYEE t8 ON t8.ID = t7.ID_EMPLOYEE
	WHERE t1.FLAG = 1
	  AND t1.rid = #{rid}
	</select>
	
	<select id="getEvtApplicantDown" parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctExcelResDto" fetchSize="5000">
	/* LoyEventMapper.getEvtApplicantDown */ 
	SELECT ${strColumn}
	     , t1.RID	 as rid
    	 , t3.MBR_NO as mbrNo
    	 , t1.RID_MBR AS ridMbr
    	 <!-- , t4.CUST_NM	AS custNm -->
    	 , t3.SBSC_TYPE_CD AS sbscTypeCd
    	 <!-- , t4.HHP		AS hhpNo -->
    	 , cc1.MARK_NAME as mbrStatus
    	 , TO_CHAR(t1.APPLCT_DT,'YYYY-MM-DD HH24:MI') as applctDt
    	 , t1.APPLCT_TICKET_CNT as applctTicketCnt
    	 , t1.SNS_ID as snsId
    	 , t1.APPLCT_URL as applctUrl
    	 , t5.RID as ridEvtWinner
    	 , (CASE WHEN t5.RID IS NOT NULL THEN 'Y' ELSE 'N' END) AS winYn
    	 , TO_CHAR(t5.WIN_DT, 'YYYY-MM-DD HH24:MI') as winDt
    	 , t5.BNF_YN as bnfYn
    	 , TO_CHAR(t5.BNF_DT, 'YYYY-MM-DD HH24:MI') as bnfDt
    	 , TO_CHAR(SYSDATE, 'YYYY') - SUBSTR(TO_CHAR(t4.BIRTH_DATE,'YYYY-MM-DD'),1,4) + 1 as age
    	 , t6.MARK_NAME as gender
    	 , t1.MBR_UPLOAD_PATH AS uploadPath
    	 , ${strColumn}
    FROM loy.LOY_EVT_APPLCT t1
   	JOIN loy.LOY_EVT_MST t2 ON t1.RID_EVT = t2.RID AND t2.FLAG = 1
    JOIN loy.LOY_MBR t3 ON t1.RID_MBR = t3.RID AND t3.FLAG = 1
    JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
    <if test="eventType != &quot;UGC&quot;">
	LEFT OUTER JOIN loy.LOY_EVT_WINNER t5 ON t5.FLAG = 1 AND t5.RID_EVT = t2.RID AND t5.RID_MBR = t1.RID_MBR AND t1.RID = t5.RID_EVT_APPLCT
    </if>
    <if test="eventType == &quot;UGC&quot;">
	JOIN LOY.LOY_EVT_WINNER t5 ON t5.FLAG = 1 AND t5.RID_EVT = t2.RID AND t5.RID_MBR = t1.RID_MBR AND t1.RID = t5.RID_EVT_APPLCT    
    </if>
    LEFT OUTER JOIN com.COMM_CODE cc1 ON  cc1.CODE_NAME = t3.MBR_STAT_CD AND cc1.GROUP_CODE = 'LOY_MBR_STAT_CD' AND cc1.FLAG = 1 AND cc1.LANG = #{lang}
    LEFT OUTER JOIN com.COMM_CODE t6 ON t6.CODE_NAME = t4.GEN_CD AND t6.GROUP_CODE = 'LOY_GEN_CD' AND t6.FLAG = 1 AND t6.LANG = #{lang}
    WHERE t1.FLAG = 1
	  AND t1.rid_evt = #{rid}
	  and ${strCondWhere}
	  and ${strWhere}
 order by ${strOrderby}
	</select>
	
	<!-- 이벤트 미리보기 토큰 등록 -->
	<insert id="insertEvtPreviewToken" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPreviewTokenReqDto">
		/* LoyEventMapper.insertEvtPreviewToken */
		INSERT INTO LOY.LOY_EVT_PREVIEW_TOKEN (
			RID
			, CREATE_BY
			, MODIFY_BY
			, CREATE_DATE
			, MODIFY_DATE
			, FLAG
			<!-- , COUNTRY
			, APP_SERVICE_TYPE
			, ACCNT_ID -->
			, RID_MBR
			, FO_USER_ID
			, TOKEN
			, VALID_DT
		) VALUES (
			#{rid}
			, #{createBy}
			, #{modifyBy}
			, SYSDATE
			, SYSDATE
			, 1
			,<!--  #{country}
			, #{appServiceId}
			, #{accountId} -->
			, #{ridMbr}
			, #{foUserId}
			, #{token}
			, SYSDATE + (#{validTime}/24/60)
		)
	</insert>
	
	<!-- 이벤트  미리보기 토큰 조회 -->
	<select id="selectEvtPreviewToken" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPreviewTokenReqDto">
		/* LoyEventMapper.selectEvtPreviewToken */
		SELECT RID 			AS rid
		     , RID_MBR 		AS ridMbr
		     , FO_USER_ID 	AS foUserId
		     , TOKEN 		AS token
		     , VALID_DT 	AS validDt
		     , (SELECT ATTRIB02 FROM COM.COMM_CODE WHERE FLAG = 1 AND LANG = #{lang} AND GROUP_CODE = 'SERVER_URL' AND CODE_NAME = 'GLOLIVE') AS url
		  FROM LOY.LOY_EVT_PREVIEW_TOKEN
		 WHERE FLAG = 1
		 <if test="@com.icignal.common.util.StringUtil@isNotEmpty(rid)">
		   AND RID = #{rid}
		 </if>
		 <if test="@com.icignal.common.util.StringUtil@isEmpty(rid)">
		   AND CREATE_BY = #{createBy}
		   AND FO_USER_ID = #{foUserId}
		 </if>
		   AND VALID_DT <![CDATA[>=]]> SYSDATE
		   AND ROWNUM = 1
		 ORDER BY CREATE_DATE DESC
	</select>
	
	<!-- 이벤트 미리보기 토큰 삭제 -->
	<update id="deleteEvtPreviewToken" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPreviewTokenReqDto">
		UPDATE LOY.LOY_EVT_PREVIEW_TOKEN
		   SET MODIFY_BY = #{modifyBy}
		     , MODIFY_DATE = SYSDATE
		     , flag = flag + 1
		 WHERE FLAG = 1 
		 <if test="@com.icignal.common.util.StringUtil@isNotEmpty(rid)">
		   AND RID = #{rid}
		 </if>
		 <if test="@com.icignal.common.util.StringUtil@isEmpty(rid)">
		   AND CREATE_BY = #{createBy}
		   AND FO_USER_ID = #{foUserId}
		 </if>
	</update>
	
	

 


	
	<!-- 추가혜택 조회 -->
	<select id="SelectAddPromList" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyAddPromResDto">
	/* LoyEventMapper.SelectAddPromList */			  
	 SELECT ${strColumn}
		   ,le.rid AS rid
           ,mc.CAM_NM AS camNm
           ,mc.DISP_NO AS dispNo
           ,le.RID_MKT_CAM_MST as camRid
           ,le.COND_TYPE_CD AS conCd
           ,cc1.MARK_NAME AS condType
           ,le.COND_VAL AS condVal
           ,om.self_tot_amt as selfTotAmt
     FROM loy.LOY_EVT_ADD_PROM le
     LEFT OUTER JOIN mkt.MKT_CAM_MST mc ON le.RID_MKT_CAM_MST = mc.ID AND mc.FLAG = 1
     LEFT OUTER JOIN com.COMM_CODE cc1 ON cc1.CODE_NAME = le.COND_TYPE_CD AND cc1.FLAG = 1 AND cc1.GROUP_CODE = 'COND_TYPE_CD' AND cc1.Lang = 'ko'
     JOIN mkt.MKT_CAM_OFFER_REL ore ON ore.cam_id = mc.ID AND ore.FLAG = 1
     JOIN mkt.MKT_OFFER_MST om ON ore.OFFER_ID = om.ID AND om.FLAG = 1
     WHERE le.flag = 1
     	AND le.RID_EVT_MST = #{rid}
	 	AND ${strCondWhere}
	  	AND ${strWhere}
	 order by ${strOrderby}
			  ${strEndPaging}
	</select>
	
	<!-- 추가혜택 등록 -->
	<insert id="insertAddPromSave" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto">
	/* LoyEventMapper.insertAddPromSave */
	INSERT
	INTO LOY.LOY_EVT_ADD_PROM (
		RID,
		CREATE_BY,
		MODIFY_BY,
		CREATE_DATE,
		MODIFY_DATE,
		FLAG,
		<!-- COUNTRY,
		APP_SERVICE_TYPE,
		ACCNT_ID, -->
		RID_EVT_MST,
		COND_TYPE_CD,
		COND_VAL,
		RID_MKT_CAM_MST
		)
	VALUES(
		com.getNewId(''),
		#{createBy},
		#{modifyBy},
		SYSDATE,
		SYSDATE,
		1,
		<!-- #{country},
		#{appServiceId},
		#{accountId}, -->
		#{evtRid},
		#{conCd},
		#{condVal},
		#{camRid}
		)
	</insert>
	
	<!-- 추가혜택 삭제 -->
	<update id="deleteProm" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto">
	/* LoyEventMapper.deleteProm */
	UPDATE LOY.LOY_EVT_ADD_PROM
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   flag = flag + 1
	 WHERE RID = #{rid}
	</update>
	
	<!-- 부정회원 등록 -->
	<insert id="InsertLimitMbr" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto">
	/* LoyEventMapper.InsertLimitMbr */
	INSERT
	INTO LOY.LOY_EVT_LIMIT_MBR (
		RID,
		CREATE_BY,
		MODIFY_BY,
		CREATE_DATE,
		MODIFY_DATE,
		FLAG,
		<!-- COUNTRY,
		APP_SERVICE_TYPE,
		ACCNT_ID, -->
		RID_EVT_MST,
		RID_MBR,
		STATUS,
		START_DT,
		END_DT,
		LIMIT_DESC
		)
	VALUES(
		com.getNewId(''),
		#{createBy},
		#{modifyBy},
		SYSDATE,
		SYSDATE,
		1,
		<!-- #{country},
		#{appServiceId},
		#{accountId}, -->
		#{evtRid},
		#{ridMbr},
		'A',
		TO_DATE(#{startDt}, 'YYYY-MM-DD'),
		TO_DATE(#{endDt}, 'YYYY-MM-DD'),
		#{limitDesc}
		)
	</insert>
	
	<!-- 부정회원 중복체크 -->
	<select id="validLimitMbr" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto" resultType="java.lang.Integer" >
	/* LoyEventMapper.validLimitMbr */
	SELECT COUNT(1)
	  FROM loy.LOY_EVT_LIMIT_MBR
	 WHERE RID_EVT_MST = #{evtRid} 
	   AND RID_MBR = #{ridMbr}
	   AND STATUS = 'A'
	   AND FLAG = 1
	   AND to_char(SYSDATE,'yyyy-mm-dd') BETWEEN START_DT AND END_DT
	</select>
	
	<!-- 부정회원 조회 -->
	<select id="SelectLimitMbrList" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyLimitMbrResDto">
	/* LoyEventMapper.SelectLimitMbrList */
	SELECT ${strColumn},
	 		limMbr.RID AS rid,
	 		limMbr.RID_MBR AS ridMbr,
     		t3.MBR_NO AS mbrNo,
 	 		t4.CUST_NM as custNm,
      		to_char(limMbr.START_DT ,'YYYY-MM-DD') AS startDt,
      		to_char(limMbr.END_DT ,'YYYY-MM-DD') AS endDt,
      		limMbr.STATUS AS statusCd,
      		cc1.MARK_NAME AS status,
      		limMbr.LIMIT_DESC AS limDesc,
      		limMbr.RELEA_DESC AS relDesc
    FROM loy.LOY_EVT_LIMIT_MBR limMbr
	JOIN loy.LOY_EVT_MST t2 ON limMbr.RID_EVT_MST = t2.RID AND t2.FLAG = 1
	JOIN loy.LOY_MBR t3 ON limMbr.RID_MBR = t3.RID AND t3.FLAG = 1
	JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
	LEFT OUTER JOIN com.COMM_CODE cc1 ON cc1.CODE_NAME = limMbr.STATUS AND cc1.FLAG = 1 AND cc1.GROUP_CODE = 'LOY_CHNL_STAT_CD' AND cc1.Lang = 'ko'
    WHERE limMbr.FLAG=1
    	AND limMbr.RID_EVT_MST = #{rid}
		AND ${strCondWhere}
	  	AND ${strWhere}
	order by ${strOrderby}
			 ${strEndPaging}
	</select>
	
	<!-- <select id="selectPointMallPreviewToken" parameterType="infavor.loyalty.event.dto.request.LOYEventPreviewTokenRequestDTO" resultType="infavor.loyalty.event.dto.response.LOYEventPreviewTokenResponseDTO">
	/* LoyEventMapper.selectEvtPreviewToken */
	SELECT RID 			AS rid
	     , RID_MBR 		AS ridMbr
	     , FO_USER_ID 	AS foUserId
	     , TOKEN 		AS token
	     , VALID_DT 	AS validDt
	     , (SELECT ATTRIB02 FROM COM.COMM_CODE WHERE FLAG = 1 AND LANG = #{lang} AND GROUP_CODE = 'SERVER_URL' AND CODE_NAME = 'POINTMALL') AS url
	  FROM LOY.LOY_EVT_PREVIEW_TOKEN
	 WHERE FLAG = 1
	 <if test="@com.icignal.common.util.StringUtil@isNotEmpty(rid)">
	   AND RID = #{rid}
	 </if>
	 <if test="@com.icignal.common.util.StringUtil@isEmpty(rid)">
	   AND CREATE_BY = #{createBy}
	   AND FO_USER_ID = #{foUserId}
	 </if>
	   AND VALID_DT <![CDATA[>=]]> SYSDATE
	   AND ROWNUM = 1
	 ORDER BY CREATE_DATE DESC
	</select> -->
	
	<!-- 부정등록회원 마스킹 해제 -->                                                                             
	<select id="LimitMbrClearMask" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyLimitMbrResDto">
    SELECT t4.CUST_NM as unMaskCustNm                                 
    FROM loy.LOY_EVT_LIMIT_MBR limMbr
	JOIN loy.LOY_MBR t3 ON limMbr.RID_MBR = t3.RID AND t3.FLAG = 1
	JOIN loy.LOY_CUST t4 ON t3.RID_CUST = t4.RID AND t4.FLAG = 1
    WHERE limMbr.FLAG=1
    	AND limMbr.rid = #{rid}
	</select>   
	
	<!-- 부정등록회원 해지 -->
	<update id="CancelLimitMbr" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto">
	/* LoyEventMapper.CancelLimitMbr */
	UPDATE loy.LOY_EVT_LIMIT_MBR
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   STATUS = 'I',
	 	   RELEA_DESC = #{releaDesc}
	 WHERE RID = #{rid}
	</update>
	
	<!--  예약서비스 미리보기 토큰 조회 -->
	<!-- <select id="selectReservPreviewToken"  parameterType="infavor.loyalty.event.dto.request.LOYEventPreviewTokenRequestDTO" resultType="infavor.loyalty.event.dto.response.LOYEventPreviewTokenResponseDTO">
	/* LoyEventMapper.selectReservPreviewToken */
		SELECT RID 			AS rid
		     , RID_MBR 		AS ridMbr
		     , FO_USER_ID 	AS foUserId
		     , TOKEN 		AS token
		     , VALID_DT 	AS validDt
		     , (SELECT ATTRIB02 FROM COM.COMM_CODE WHERE FLAG = 1 AND LANG = #{lang} AND GROUP_CODE = 'SERVER_URL' AND CODE_NAME = 'RESERVATION') AS url
		  FROM LOY.LOY_EVT_PREVIEW_TOKEN
		 WHERE FLAG = 1
		 <if test="@com.icignal.common.util.StringUtil@isNotEmpty(rid)">
		   AND RID = #{rid}
		 </if>
		 <if test="@com.icignal.common.util.StringUtil@isEmpty(rid)">
		   AND CREATE_BY = #{createBy}
		   AND FO_USER_ID = #{foUserId}
		 </if>
		   AND VALID_DT <![CDATA[>=]]> SYSDATE
		   AND ROWNUM = 1
		 ORDER BY CREATE_DATE DESC
	</select>      -->                                                                                  
	         
	<!-- 부정등록회원 삭제 -->
	<update id="deleteLimitMbr" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deleteLimitMbr */
	UPDATE loy.LOY_EVT_LIMIT_MBR
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   STATUS = 'I',
	 	   flag = flag + 1
	 WHERE RID_EVT_MST = #{rid}
	</update>
	
	<!-- 추가혜택 삭제 -->
	<update id="deletePromotion" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.deletePromotion */
	UPDATE LOY.LOY_EVT_ADD_PROM
	   SET MODIFY_BY    = #{modifyBy},
	 	   MODIFY_DATE 	= sysdate,
	 	   flag = flag + 1
	 WHERE RID_EVT_MST = #{rid}
	</update>
	
	<select id="selectWinningCond" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEventWinningCondResDto">
	/* LoyEventMapper.selectWinningCond  */
	SELECT COUNT(DISTINCT(lea.RID_MBR)) apllicantCnt
		,  SUM(lea.APPLCT_TICKET_CNT) as voteCnt
	  FROM loy.LOY_EVT_APPLCT lea
	  JOIN loy.LOY_MBR lm ON lea.RID_MBR = lm.RID AND lm.FLAG = 1 AND lm.MBR_STAT_CD = 'A'
	 WHERE lea.RID_EVT = #{rid}
	   AND lea.FLAG = 1
	</select>	                       	                                                     

	<!-- 이미지 삭제 업데이트 -->
	<update id="updateEventEmg" parameterType="com.icignal.loyalty.event.dto.request.LoyEventPlanExcutionReqDto">
	/* LoyEventMapper.updateEventEmg */
	UPDATE loy.LOY_EVT_MST
	    SET MODIFY_BY 	= #{modifyBy},
	    	MODIFY_DATE = sysdate,
	    	${fileNm}   = NULL                                                          
  	WHERE flag = 1 
	AND RID = #{rid}
	</update>

	<!-- 출석이벤트 총적립 및 적립별 총액 조회-->
	<!-- <select id="getAttendAcrlPoint" parameterType="attendanceRequest" resultType="attendanceResponse">
	/* LoyEventMapper.getAttendAcrlPoint */
		SELECT
             CASE 
             	WHEN sum(lpme.pnt_amt) IS NOT NULL THEN SUM(lpme.PNT_AMT) 
             	ELSE 0
             END AS acrlAmt,
             sum(decode(lpme.PNT_AMT,'100',lpme.PNT_AMT,0)) AS tot100p,
             sum(decode(lpme.PNT_AMT,'200',lpme.PNT_AMT,0)) AS tot200p,
             sum(decode(lpme.PNT_AMT,'500',lpme.PNT_AMT,0)) AS tot500p,
             sum(decode(lpme.PNT_AMT,'5000',lpme.PNT_AMT,0)) AS tot5000p
       FROM loy.loy_pst_mbr_evt lpme
       JOIN loy.LOY_MBR lm ON lpme.FLAG = 1 AND lpme.RID_MBR = lm.RID 
	   join loy.LOY_CUST lc ON lc.FLAG = 1 AND lm.RID_CUST = lc.RID
	   LEFT OUTER JOIN com.COMM_CODE cc ON lm.MBR_STAT_CD = cc.CODE_NAME AND cc.GROUP_CODE = 'LOY_MEM_STAT_CD' AND cc.lang = #{lang}
	   where ${strCondWhere}
	   AND   lpme.FLAG = 1
	</select> -->
	
	
	<!-- UGC 달성총인원, 횟수 조회 -->
	<select id="getUGCAch" parameterType="com.icignal.loyalty.event.dto.request.LoyUGCAchReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyUGCAchResDto">
	/* LoyEventMapper.getUGCAch*/
    SELECT totPnt.totalPnt AS tot_p
	     , totPnt.tot_cnt AS tot_cnt
	     , totStmp.tot_stmp AS tot_stmp
	     , totMbr.mbrCnt AS tot_mbr_cnt
 	FROM (
			SELECT count(DISTINCT lm.RID) AS totalPnt 
		  	     , count (lm.rid) AS tot_cnt
		  	FROM loy.LOY_EVT_WINNER lew
		  	JOIN Loy.LOY_MBR lm ON lew.RID_EVT=#{rid} AND lm.rid=lew.RID_MBR AND lew.WIN_TYPE_CD='02' AND lm.FLAG=1
		  	WHERE lew.FLAG=1
		 ) totPnt,
	 	 (
	  		SELECT nvl(sum(lew.WIN_TYPE_CD),0) tot_stmp
	    	FROM loy.LOY_EVT_WINNER lew
	  		JOIN Loy.LOY_MBR lm ON lew.RID_EVT=#{rid} AND lm.rid=lew.RID_MBR AND lew.WIN_TYPE_CD='01' AND lm.FLAG=1
	 		WHERE lew.FLAG=1
	  	 )totStmp,
	 	 (
	  		SELECT COUNT(DISTINCT lm.RID) AS mbrCnt
	    	FROM loy.LOY_EVT_WINNER lew
	  		JOIN Loy.LOY_MBR lm ON lew.RID_EVT=#{rid} AND lm.rid=lew.RID_MBR AND lm.FLAG=1
	  		WHERE lew.FLAG=1
	  	 )totMbr
	</select>
	                    
	<!-- 	UGC이력 마스킹 해제           -->          
    <select id="ugcMbrclearMasking" parameterType="com.icignal.loyalty.event.dto.request.LoyUGCListReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyUGCListResDto">
    /* LoyEventMapper.ugcMbrclearMasking */
 	select lc.CUST_NM as custNM
 		  , lm.rid as ridMbr
	  FROM loy.LOY_CUST lc  
	  join loy.LOY_MBR lm ON lm.RID_CUST = lc.RID
	 WHERE lm.RID = #{ridMbr}
    </select>
    
    
    <!-- 추가혜택 중복체크 -->
	<select id="validLimitProm" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto" resultType="java.lang.Integer" >
	/* LoyEventMapper.validLimitProm */
	SELECT COUNT(1)
	  FROM LOY.LOY_EVT_ADD_PROM
	 WHERE RID_EVT_MST = #{evtRid} 
	   AND FLAG = 1
	</select>
	
	<!-- 추가혜택 조회 -->
	<select id="selectAddProm" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyAddPromResDto" >
	/* LoyEventMapper.selectAddProm */
	SELECT mc.CAM_NM AS camNm
           ,mc.DISP_NO AS dispNo
           ,le.RID_MKT_CAM_MST as camRid
           ,le.COND_TYPE_CD AS conCd
           ,cc1.MARK_NAME AS condType
           ,le.COND_VAL AS condVal
     FROM loy.LOY_EVT_ADD_PROM le
     LEFT OUTER JOIN mkt.MKT_CAM_MST mc ON le.RID_MKT_CAM_MST = mc.ID AND mc.FLAG = 1
     LEFT OUTER JOIN com.COMM_CODE cc1 ON cc1.CODE_NAME = le.COND_TYPE_CD AND cc1.FLAG = 1 AND cc1.GROUP_CODE = 'COND_TYPE_CD' AND cc1.Lang = 'ko'
     WHERE le.flag = 1
     AND le.rid = #{rid}
	</select>
	
	<update id="updatePromSave" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto">
	/* LoyEventMapper.updatePromSave */
	UPDATE loy.LOY_EVT_ADD_PROM
	SET MODIFY_BY    	= #{modifyBy}
	 	, MODIFY_DATE 	= SYSDATE
	 	, COND_TYPE_CD	= #{conCd}
	 	, COND_VAL	= #{condVal}
	 	, RID_MKT_CAM_MST = #{camRid}
	where RID_EVT_MST = #{evtRid}
	and flag=1
	</update>
	
    <!--  출석이벤트 참여횟수 및 참여인원, 비율 조회 -->
    <!-- <select id="getAttendAcrlJoin" parameterType="attendanceRequest" resultType="attendanceResponse">
    /* LoyEventMapper.getAttendAcrlJoin */
    	select count(lpme.PNT_AMT) AS acrlJoin,
    		 sum(decode(lpme.PNT_AMT,'100',1,0)) AS cnt100p,
             sum(decode(lpme.PNT_AMT,'200',1,0)) AS cnt200p,
             sum(decode(lpme.PNT_AMT,'500',1,0)) AS cnt500p,
             sum(decode(lpme.PNT_AMT,'5000',1,0)) AS cnt5000p,
        	 COUNT(DISTINCT lm.MBR_NO) AS totMbr
      	from loy.loy_pst_mbr_evt lpme
	  	JOIN loy.LOY_MBR lm ON lpme.FLAG = 1 AND lpme.RID_MBR = lm.RID 
	  	join loy.LOY_CUST lc ON lc.FLAG = 1 AND lm.RID_CUST = lc.RID
	   	LEFT OUTER JOIN com.COMM_CODE cc ON lm.MBR_STAT_CD = cc.CODE_NAME AND cc.GROUP_CODE = 'LOY_MEM_STAT_CD' AND cc.lang = 'ko'
	  	where    ${strCondWhere}
	  	AND   lpme.FLAG = 1
	  	
    </select> -->
    <!-- 출석이벤트 연령별 인원 조회 -->
    <!-- <select id="getAttendAgeGroupCnt" parameterType="attendanceRequest" resultType="attendanceResponse">
    /* LoyEventMapper.getAttendAgeGroupCnt */	  
		SELECT  SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'10대',1 , 0  )) AS s10,
				SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'20대',1 , 0  )) AS s20,
			   SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'30대',1 , 0  )) AS s30,
			   SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'40대',1 , 0  )) AS s40,
			   SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'50대',1 , 0  )) AS s50,
			   SUM(DECODE(FN_GET_AGE_GROUP(FN_GET_AGE('Y3',hr.birthDt)),'60대이상',1 , 0  )) AS over60s
		FROM(
		    SELECT 	DISTINCT lpme.RID_MBR
		    	  , lc.BIRTH_DT AS birthDt
		 	  from loy.loy_pst_mbr_evt lpme
			  JOIN loy.LOY_MBR lm ON lpme.FLAG = 1 AND lpme.RID_MBR = lm.RID 
			  join loy.LOY_CUST lc ON lc.FLAG = 1 AND lm.RID_CUST = lc.RID
			  LEFT OUTER JOIN com.COMM_CODE cc ON lm.MBR_STAT_CD = cc.CODE_NAME AND cc.GROUP_CODE = 'LOY_MEM_STAT_CD' AND cc.lang = 'ko'
	  		 where    ${strCondWhere}
			   AND   lpme.FLAG = 1) hr
    </select> -->
    
    <!-- 추가혜택 조건값 조회 -->
	<select id="selectAddPromCondVal" parameterType="com.icignal.loyalty.event.dto.request.LoyAddPromReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyAddPromResDto">
	/* LoyEventMapper.selectAddPromCondVal */			  
	 SELECT le.COND_VAL AS condVal
     FROM loy.LOY_EVT_ADD_PROM le
     WHERE le.flag = 1
     	AND le.RID_EVT_MST = #{rid}
	</select>

    <select id="selectApplicantCnt" parameterType="com.icignal.loyalty.event.dto.request.LoyApplctRdmReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyApplctRdmResDto">
    /* LoyEventMapper.selectApplicantCnt */
    SELECT COUNT(*)	AS voteCnt
		,  COUNT(DISTINCT lea.rid_mbr) AS voteMbrCnt
  	  FROM loy.LOY_EVT_APPLCT lea 
  	  JOIN loy.LOY_MBR lm ON lm.RID = lea.RID_MBR AND lm.MBR_STAT_CD = 'A' AND lm.FLAG = 1
	 WHERE lea.FLAG = 1 
   	   AND lea.RID_EVT = #{eventRid}
    </select>
    
    <update id="getRdmWinner" parameterType="com.icignal.loyalty.event.dto.request.LoyApplctRdmReqDto" statementType="CALLABLE">
    	/* LoyEventMapper.getRdmWinner */
    	{ call loy.PKG_LOY_BO_EVENT.PROC_EVENT_AUTO_WINNING(
    			 #{eventRid}
    		   , #{winCnt}
    		   , #{modifyBy}
    		   , #{RST		, mode = OUT, jdbcType=VARCHAR, javaType=String}
    		   , #{RST_CD	, mode = OUT, jdbcType=VARCHAR, javaType=String}
    		   , #{RST_MSG	, mode = OUT, jdbcType=VARCHAR, javaType=String}
    	)}
    </update>
    
    <select id="validCheckWinnerTrans" parameterType="com.icignal.loyalty.event.dto.request.LoyApplctRdmReqDto"  resultType="java.lang.Integer" >
   /* LoyEventMapper.validCheckWinnerTrans */
    SELECT COUNT(*)
	  FROM LOY.LOY_EVT_MST lem
	 WHERE lem.FLAG = 1
	   AND lem.RID = #{eventRid}
	   AND (lem.APPLY_END_DT <![CDATA[<]]> TRUNC(SYSDATE) OR EVT_STATUS_CD = 'E')
    </select>
    
    
    <!-- 부정회원 등록 및 취소, 이벤트 당첨완료 프로시저 호출 -->
    <update id="InsertMbrMsg" parameterType="com.icignal.loyalty.event.dto.request.LoyApplctRdmReqDto" statementType="CALLABLE">
    	/* LoyEventMapper.InsertMbrMsg */
    	{ call loy.PKG_LOY_API_ALERT.PROC_ALERT_MSG_REG(
    			 #{type}
    		   , #{mbrRid}
    		   , #{route}
    		   , #{msg}
    		   , #{actionDt}
    		   , #{createBy}
    		   , #{status}
    		   , #{rid}
    		   , #{flag}
    		   , #{RST		, mode = OUT, jdbcType=VARCHAR, javaType=String}
    		   , #{RST_CD	, mode = OUT, jdbcType=VARCHAR, javaType=String}
    		   , #{RST_MSG	, mode = OUT, jdbcType=VARCHAR, javaType=String}
    	)}
    </update>
    
    <!-- 부정등록 테이블의 RID를 조회 -->
    <select id="getInsertLimitMbr" parameterType="com.icignal.loyalty.event.dto.request.LoyLimitMbrReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyLimitMbrResDto">
    /* LoyEventMapper.getInsertLimitMbr */
    SELECT rid
  	  FROM loy.LOY_EVT_LIMIT_MBR 
	 WHERE FLAG = 1 
	   AND RID_MBR	   = #{mbrRid}
   	   AND RID_EVT_MST = #{evtRid}
   	   AND STATUS      = 'A'
    </select>
    
    <!-- 부정등록 테이블의 RID를 조회 -->
    <select id="selectTierLimitList" parameterType="com.icignal.loyalty.event.dto.request.LoyUGCListReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyTierLimitListResDto">
    /* LoyEventMapper.selectTierLimitList */
   		SELECT ee.NAME AS createByNm
                        , TO_CHAR(mt.CREATE_DATE,'YYYY-MM-DD HH24:MI:SS') AS createDate
                        , mt.RID AS rid
                        , ltg.TIERS_GRP_NM	AS tiersGrpNm
                        , t1.TIER_TYPE_CD as tierCd
                        , t1.TIER_NM as tierNm
                        , ${strColumn}
        FROM loy.LOY_EVT_MBR_TIER mt
        JOIN loy.loy_tiers t1 on t1.flag = 1
 		and t1.rid = mt.RID_TIER
 		JOIN LOY.LOY_TIERS_GRP ltg ON ltg.RID = t1.RID_TG AND ltg.FLAG = 1
 		and ltg.STAT_CD = 'A'
        JOIN com.CRM_USER cu ON cu.RID = mt.CREATE_BY AND cu.FLAG = 1
    	JOIN com.EMPLOYEE ee ON ee.ID = cu.ID_EMPLOYEE
    	WHERE mt.FLAG = 1
        AND ${strCondWhere}
	    AND ${strWhere}
	    order by ${strOrderby}
			 ${strEndPaging}
    </select>
    
    <insert id="insertTierLimit" parameterType="com.icignal.loyalty.event.dto.request.LoyAddTierReqDto">
	/* LoyEventMapper.insertTierLimit */
	INSERT 
	INTO LOY.LOY_EVT_MBR_TIER(
		rid
		,CREATE_BY
		,MODIFY_BY
		,CREATE_DATE
		,MODIFY_DATE
		,FLAG
		,RID_TGT_EVT
		,RID_TIER
	)
	VALUES 
	(
	     #{rid}
		,#{createBy} 
		,#{modifyBy}
		, sysdate
		, sysdate
		,1
		,#{eventRid}
		,#{tierRid}
	)
	</insert>
	
	<select id="dupCheckProd"  parameterType="com.icignal.loyalty.event.dto.request.LOYProdRequestDTO" resultType="java.lang.Integer" >
	/* LoyEventMapper.dupCheckProd */
	select 
		count(1) as dupCnt
	from 
		LOY.LOY_PROD
	where 
		prod_id=#{prodId}
	</select>
	
	<select id="selectMbrNoDetail"  parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto" >
	/* LoyEventMapper.selectMbrNoDetail */
	select lm.RID AS ridMbr
	     , lm.MBR_NO AS mbrNo
	FROM LOY.LOY_MBR lm 
	JOIN LOY.LOY_CUST lc ON lm.RID_CUST = lc.RID 
	WHERE MBR_NO = #{mbrNo} 
	AND lm.MBR_TYPE_CD = 'M3' 
	AND lm.MBR_STAT_CD ='A' 
	AND lc.CUST_TYPE_CD='I'
	</select>
	
	<select id="selectMbrDetail"  parameterType="com.icignal.loyalty.event.dto.request.LoyEvtApplctReqDto" resultType="com.icignal.loyalty.event.dto.response.LoyEvtApplctResDto" >
	/* LoyEventMapper.selectMbrDetail */
	select lm.RID AS ridMbr
	     , lm.MBR_NO AS mbrNo
	FROM LOY.LOY_MBR lm 
	JOIN LOY.LOY_CUST lc ON lm.RID_CUST = lc.RID 
	WHERE lc.CUST_NM = #{custNm} 
	AND   lc.HHP = #{hhp} 
	AND lm.MBR_TYPE_CD = 'M3' 
	AND lm.MBR_STAT_CD ='A' 
	AND lc.CUST_TYPE_CD='I'
	</select>
    
</mapper>